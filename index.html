<!DOCTYPE html>

<html lang="ru">
<head>

<!-- CHARIS EARLY CLOUDflare PROXY PATCH (fetch + XHR) - single early instance -->
<script>
(function(){
  if (window.__charis_cf_proxy_applied) return;
  window.__charis_cf_proxy_applied = true;
  try {
    const DEFAULT_WORKER = (typeof CLOUDFLARE_WORKER_URL !== 'undefined') ? CLOUDFLARE_WORKER_URL : 'https://gemini-proxy.xlebovichxleb140.workers.dev/';
    const GEMINI_PREFIX = 'https://generativelanguage.googleapis.com/';
    const STORAGE_KEY = 'enableCloudflareRedirect_v1';
    const FALLBACK_ON_ERROR = false;

    function getUseCloudflare(){
      try { return localStorage.getItem(STORAGE_KEY) === 'true'; } catch(e){ return false; }
    }

    function copySafeHeaders(src){
      const h = new Headers();
      try {
        if (!src) return h;
        if (typeof src.get === 'function') {
          const ct = src.get('Content-Type') || src.get('content-type');
          if (ct) h.set('Content-Type', ct);
          const a = src.get('Authorization') || src.get('authorization');
          if (a) h.set('Authorization', a);
          const acc = src.get('Accept') || src.get('accept');
          if (acc) h.set('Accept', acc);
        } else if (typeof src === 'object') {
          if (src['Content-Type']) h.set('Content-Type', src['Content-Type']);
          if (src['content-type']) h.set('Content-Type', src['content-type']);
          if (src['Authorization']) h.set('Authorization', src['Authorization']);
          if (src['authorization']) h.set('Authorization', src['authorization']);
          if (src['Accept']) h.set('Accept', src['Accept']);
          if (src['accept']) h.set('Accept', src['accept']);
        }
      } catch(e){ /* noop */ }
      return h;
    }

    // Patch fetch early
    try {
      if (typeof window.fetch === 'function' && !window.fetch.__charis_cf_patched) {
        const originalFetch = window.fetch.bind(window);
        window.fetch = async function(input, init = {}) {
          try {
            const isRequest = (typeof Request !== 'undefined') && (input instanceof Request);
            const origUrl = isRequest ? input.url : String(input || '');
            if (!getUseCloudflare() || !origUrl.startsWith(GEMINI_PREFIX)) {
              return originalFetch(input, init);
            }

            // build safe headers and mark the original URL
            const srcHeaders = isRequest ? new Headers(input.headers || {}) : new Headers(init.headers || {});
            const headers = copySafeHeaders(srcHeaders);
            headers.set('X-Original-URL', origUrl);
            headers.set('X-Client-Proxy', 'true');

            // body handling: only when body is a string (JSON.stringify used)
            let body = (init && init.body !== undefined) ? init.body : (isRequest ? input.body : undefined);
            const contentType = headers.get('Content-Type') || '';
            if (typeof body === 'string' && contentType.indexOf('application/json') !== -1) {
              try {
                const j = JSON.parse(body || '{}');
                if (Array.isArray(j.contents) && j.contents.length > 0 && j.contents[0] && j.contents[0].role === 'model') {
                  j.contents.push(j.contents.shift());
                  body = JSON.stringify(j);
                  headers.set('X-Worker-Fix', 'model-shifted');
                  console.log('[charis-proxy] client fixed: moved model->end');
                }
              } catch(e) { /* ignore JSON parse errors */ }
            }

            const fetchOptions = {
              method: (init && init.method) || (isRequest ? input.method : 'POST'),
              headers: headers,
              body: body,
              redirect: (init && init.redirect) || (isRequest ? input.redirect : undefined),
              credentials: (init && init.credentials) || (isRequest ? input.credentials : undefined),
              referrer: (init && init.referrer) || (isRequest ? input.referrer : undefined),
              referrerPolicy: (init && init.referrerPolicy) || (isRequest ? input.referrerPolicy : undefined)
            };

            return await originalFetch(DEFAULT_WORKER, fetchOptions);
          } catch (err) {
            console.error('[charis-proxy] fetch patch error', err);
            if (FALLBACK_ON_ERROR) {
              try { return originalFetch(input, init); } catch(e) { throw err; }
            }
            throw err;
          }
        };
        // mark flags used also by other scripts so they don't re-patch
        window.fetch.__charis_cf_patched = true;
        window.fetch.__cf_patched = true;
        window.fetch.isPatched = true;
        console.log('[charis-proxy] fetch patched (early)');
      }
    } catch(e) { console.warn('[charis-proxy] fetch patch init failed', e); }

    // Patch XHR early
    try {
      if (typeof XMLHttpRequest !== 'undefined' && !XMLHttpRequest.prototype.__charis_cf_xhr_patched) {
        const origOpen = XMLHttpRequest.prototype.open;
        const origSend = XMLHttpRequest.prototype.send;
        const origSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;

        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
          try {
            this.__charis_original_url = url;
            this.__charis_should_proxy = getUseCloudflare() && (typeof url === 'string') && url.indexOf(GEMINI_PREFIX) === 0;
            if (this.__charis_should_proxy) {
              return origOpen.call(this, method, DEFAULT_WORKER, async, user, password);
            }
          } catch(e) { console.error('[charis-proxy] xhr open error', e); }
          return origOpen.call(this, method, url, async, user, password);
        };

        XMLHttpRequest.prototype.setRequestHeader = function(name, value) {
          try {
            const lname = String(name || '').toLowerCase();
            if (lname === 'x-original-url' || lname === 'content-type' || lname === 'authorization' || lname === 'accept') {
              return origSetRequestHeader.call(this, name, value);
            }
            // ignore other headers to avoid leaking UA/cookies by accident
          } catch(e){}
        };

        XMLHttpRequest.prototype.send = function(body) {
          try {
            if (this.__charis_should_proxy && this.__charis_original_url) {
              try { origSetRequestHeader.call(this, 'X-Original-URL', this.__charis_original_url); origSetRequestHeader.call(this, 'X-Client-Proxy', 'true'); } catch(e){}
              // small safe auto-fix if body is string JSON
              try {
                if (typeof body === 'string' && body.trim().startsWith('{')) {
                  try {
                    const j = JSON.parse(body || '{}');
                    if (Array.isArray(j.contents) && j.contents.length > 0 && j.contents[0] && j.contents[0].role === 'model') {
                      j.contents.push(j.contents.shift());
                      body = JSON.stringify(j);
                      console.log('[charis-proxy] xhr client fixed: moved model->end');
                    }
                  } catch(e) {}
                }
              } catch(e){}
            }
          } catch(e){ console.error('[charis-proxy] xhr send wrapper error', e); }
          return origSend.call(this, body);
        };

        XMLHttpRequest.prototype.__charis_cf_xhr_patched = true;
        window.__cf_xhr_patched = true;
        window.__charis_cf_proxy_applied = true;
        console.log('[charis-proxy] XHR patched (early)');
      }
    } catch(e) { console.warn('[charis-proxy] XHR patch init failed', e); }

  } catch(e) { console.error('[charis-proxy] early patch final error', e); }
})();
</script>
<!-- END CHARIS EARLY PROXY PATCH -->


<meta name="google-site-verification" content="EYT4iauhkHMs9bSBaXSbFaN8w72haQYJa4JE_JBFwmY" />
<link rel="icon" href="/favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="/logo-1024.png" sizes="1024x1024" />

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>

<title>Charis Chat</title>
<meta name="description" content="Charis Chat ‚Äî –æ–Ω–ª–∞–π–Ω —á–∞—Ç-–±–æ—Ç —Å –ò–ò –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ë–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ, –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤. –õ–∏—á–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã, –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (Chub), –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ SillyTavern –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.">

<!-- Open Graph -->
<meta property="og:title" content="Charis Chat" />
<meta property="og:description" content="–ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç-–±–æ—Ç —Å –ò–ò –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (Chub)." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://charis-chat.vercel.app/" />
<meta property="og:image" content="https://charis-chat.vercel.app/logo-1024.png" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="1024" />
<meta property="og:locale" content="ru_RU" />
<meta property="og:locale:alternate" content="en_US" />
<meta property="og:description" content="Charis Chat ‚Äî —É–º–Ω—ã–π —á–∞—Ç-–±–æ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏—á–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ –±–µ—Å–µ–¥—ã." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://charis-chat.vercel.app/" />
<meta property="og:image" content="https://charis-chat.vercel.app/logo-1024.png" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="1024" />
<meta property="og:locale" content="ru_RU" />
<meta property="og:locale:alternate" content="en_US" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Charis Chat" />
<meta name="twitter:description" content="–û–±—â–∞–π—Å—è —Å –ò–ò –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ, –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤, –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (Chub), –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã." />
<meta name="twitter:image" content="https://charis-chat.vercel.app/logo-1024.png" />
<meta name="twitter:title" content="Charis Chat" />
<meta name="twitter:description" content="Charis Chat ‚Äî —É–º–Ω—ã–π —á–∞—Ç-–±–æ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏—á–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ –±–µ—Å–µ–¥—ã." />
<meta name="twitter:image" content="https://charis-chat.vercel.app/logo-1024.png" />

<!-- JSON-LD: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "name": "Charis Chat",
      "url": "https://charis-chat.vercel.app",
      "logo": "https://charis-chat.vercel.app/logo-1024.png"
    },
    {
      "@type": "WebSite",
      "url": "https://charis-chat.vercel.app",
      "name": "Charis Chat",
      "inLanguage": ["ru", "en"]
    }
  ]
}
</script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root {
      --bg-color: #fdeef5;
      --accent-color: #ff7aac;
      --accent-gradient: linear-gradient(135deg, #ff7aac 0%, #ffb6d5 100%);
      --text-color: #E91E63; /* Default pink text color */
      --italic-text-color: #9E9E9E; /* Default light gray for italics */
      --bold-text-color: #E91E63; /* Default pink for bold (as per user, can be same as text-color) */
      --card-bg: #fff8fb;
      --card-bg-rgb: 255, 248, 251; /* RGB for --card-bg */
      --input-bg: #ffe8f2;
      --input-bg-rgb: 255, 232, 242; /* RGB for --input-bg */
      --border-radius: 16px;
      --participant-bg: #fff0f7;
      --participant-active-bg: #ff7aac;
      --shadow: 0 10px 35px 0 rgba(255, 122, 172, 0.15);
      --transition-fast: 0.2s ease-out;
      --transition-normal: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --bubble-user: #ffe8f2;
      --bubble-user-rgb: 255, 232, 242;
      --bubble-bot: #f0f8ff;
      --bubble-bot-rgb: 240, 248, 255;
      --bubble-system: #f5f5f5;
      --bubble-system-rgb: 245, 245, 245;
      --bubble-api: #e6fff5;
      --bubble-api-rgb: 230, 255, 245;
      --sidebar-bg: #fff5fa;
      --sidebar-accent: #ff6fa8;
      --sidebar-hover-bg: #ffe0ef;
      --sidebar-active-bg: #ff7aac;
      --button-hover-brightness: 1.08;
      --button-active-scale: 0.97;
      --accent-color-rgb: 255, 122, 172;
      --chat-font-size-multiplier: 1;
      --app-height: 100vh; /* Variable for dynamic viewport height */
      --sidebar-width: 280px;
      --sidebar-width-collapsed: 0px;
    }

    .dark-theme {
      --bg-color: #2c1d27;
      --accent-color: #ff8fbc;
      --accent-gradient: linear-gradient(135deg, #ff8fbc 0%, #ff6099 100%);
      --card-bg: #3b2a36;
      --card-bg-rgb: 59, 42, 54; /* RGB for dark --card-bg */
      --input-bg: #4f3548;
      --input-bg-rgb: 79, 53, 72; /* RGB for dark --input-bg */
      --participant-bg: #5c4055;
      --participant-active-bg: #ff6099;
      --bubble-user: #4f3548;
      --bubble-user-rgb: 79, 53, 72;
      --bubble-bot: #30404f;
      --bubble-bot-rgb: 48, 64, 79;
      --bubble-system: #4a4a4a;
      --bubble-system-rgb: 74, 74, 74;
      --bubble-api: #2a4f40;
      --bubble-api-rgb: 42, 79, 64;
      --sidebar-bg: #3b2a36;
      --sidebar-accent: #ff6099;
      --sidebar-hover-bg: #603050;
      --sidebar-active-bg: #ff6099;
      --shadow: 0 10px 35px 0 rgba(255, 96, 153, 0.3);
      --accent-color-rgb: 255, 143, 188;
    }

    html {
      height: -webkit-fill-available;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      width: 100vw;
      overflow: hidden;
      transition: background 0.4s var(--transition-normal), color 0.4s var(--transition-normal);
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: var(--app-height);
      min-height: var(--app-height);
    }

    body {
      display: flex;
      flex-direction: row;
    }

    .hamburger-btn {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1005;
        background: var(--accent-gradient);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.3);
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    .hamburger-btn span {
        display: block;
        width: 22px;
        height: 3px;
        background-color: white;
        border-radius: 3px;
        position: relative;
        transition: all 0.3s ease-in-out;
    }
    .hamburger-btn span::before,
    .hamburger-btn span::after {
        content: '';
        position: absolute;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        border-radius: 3px;
        transition: all 0.3s ease-in-out;
    }
    .hamburger-btn span::before { transform: translateY(-7px); }
    .hamburger-btn span::after { transform: translateY(7px); }

    .hamburger-btn.open span { background-color: transparent; }
    .hamburger-btn.open span::before { transform: rotate(45deg) translateY(0px); }
    .hamburger-btn.open span::after { transform: rotate(-45deg) translateY(0px); }


    .mobile-menu-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        max-width: 80vw;
        height: var(--app-height);
        background-color: var(--sidebar-bg);
        box-shadow: 3px 0 15px rgba(0,0,0,0.2);
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s var(--transition-normal);
        overflow-y: auto;
        flex-direction: column;
    }
    .mobile-menu-container.open {
        transform: translateX(0);
    }
    .mobile-menu-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid rgba(var(--accent-color-rgb),0.2);
        position: relative;
    }
    .mobile-menu-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--sidebar-accent);
    }
    .close-mobile-menu-btn {
        background: transparent;
        border: none;
        font-size: 2rem;
        color: var(--text-color);
        cursor: pointer;
        padding: 0.2rem;
        line-height: 1;
    }
    .mobile-menu-header .close-mobile-menu-btn {
        display: none;
    }

    #mobileMenuItemsPlaceholder {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    #mobileMenuItemsPlaceholder .sidebar-header {
        text-align: left; padding: 0 0 0.5rem 0; border-bottom: none; font-size: 1.2rem;
    }
    #mobileMenuItemsPlaceholder .chat-list {
        flex-direction: column; gap: 0.5rem; padding: 0; max-height: 250px; overflow-y: auto;
    }
    #mobileMenuItemsPlaceholder .chat-item {
        width: 100%; box-sizing: border-box;
    }

    #mobileMenuItemsPlaceholder #themeToggle,
    #mobileMenuItemsPlaceholder #toggleSettingsBtn {
        position: static;
        width: 100%;
        border-radius: var(--border-radius);
        display: flex !important;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem;
        font-size: 1rem;
    }
     #mobileMenuItemsPlaceholder #themeToggle svg { margin-right: 8px; }

    #mobileMenuItemsPlaceholder #themeToggle:hover,
    #mobileMenuItemsPlaceholder #toggleSettingsBtn:hover {
        transform: scale(1.02);
        filter: brightness(var(--button-hover-brightness));
        box-shadow: 0 4px 12px rgba(var(--accent-color-rgb),0.2);
    }

    #mobileMenuItemsPlaceholder #themeToggle:active,
    #mobileMenuItemsPlaceholder #toggleSettingsBtn:active {
        transform: scale(0.98);
        filter: brightness(0.95);
    }

    #sidebarToggleButton {
        background: var(--accent-gradient);
        color: white;
        border: none;
        cursor: pointer;
        width: 40px;
        height: 40px;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.25);
        border-radius: 50%;
        transition: background 0.2s var(--transition-fast), transform 0.2s var(--transition-fast), opacity 0.3s var(--transition-normal), filter 0.2s var(--transition-fast);
    }
    #sidebarToggleButton:hover {
        filter: brightness(var(--button-hover-brightness));
        transform: scale(1.05);
    }
    #sidebarToggleButton:active {
        transform: scale(var(--button-active-scale));
    }


    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      border-right: 1px solid rgba(var(--accent-color-rgb),0.2);
      display: flex;
      flex-direction: column;
      padding: 1rem 0;
      box-shadow: 3px 0 15px rgba(var(--accent-color-rgb),0.05);
      overflow-y: auto;
      overflow-x: hidden;
      user-select: none;
      transition: width 0.3s var(--transition-normal), background 0.4s var(--transition-normal), border-color 0.4s var(--transition-normal), padding 0.3s var(--transition-normal);
      flex-shrink: 0;
      height: var(--app-height);
      position: sticky;
      top: 0;
    }
    .sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
      padding: 1rem 0;
      border-right-width: 0;
    }
    .sidebar.collapsed .sidebar-header,
    .sidebar.collapsed .chat-list,
    .sidebar.collapsed .sidebar-footer {
        display: none;
    }

    .dark-theme .sidebar {
      border-color: rgba(var(--accent-color-rgb),0.3);
      box-shadow: 3px 0 15px rgba(var(--accent-color-rgb),0.15);
    }
    .sidebar-header {
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--sidebar-accent);
      text-align: center;
      padding: 0 1rem 1.2rem 1rem;
      border-bottom: 1px solid rgba(var(--accent-color-rgb),0.2);
      transition: border-color 0.4s var(--transition-normal), color 0.4s var(--transition-normal);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: 0.02em;
    }
    .dark-theme .sidebar-header {
      border-bottom: 1px solid rgba(var(--accent-color-rgb),0.3);
    }
    .chat-list {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
    }
    .chat-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.2rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      background: transparent;
      box-shadow: none;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
      color: var(--text-color);
      position: relative;
      font-weight: 500;
      font-size: 1rem;
      border: 1px solid transparent;
    }
    .chat-item:hover {
      background: var(--sidebar-hover-bg);
      box-shadow: 0 4px 12px rgba(var(--accent-color-rgb),0.1);
      transform: translateX(4px);
      border-color: rgba(var(--accent-color-rgb),0.3);
    }
    .chat-item.active {
      background: var(--sidebar-active-bg);
      color: #fff;
      box-shadow: 0 6px 18px rgba(var(--accent-color-rgb),0.25);
      transform: translateX(0);
      font-weight: 600;
      border-color: transparent;
    }
    .chat-item img {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
      transition: border-color 0.4s var(--transition-normal);
    }
    .dark-theme .chat-item img {
      border-color: var(--accent-color);
    }
    .chat-item .chat-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
    }
    .delete-char-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-color);
      opacity: 0.6;
      font-weight: 700;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      line-height: 1;
      transition: color var(--transition-fast), opacity var(--transition-fast);
    }
    .delete-char-btn:hover {
      color: #ff0055;
      opacity: 1;
    }

    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
      position: relative;
      height: var(--app-height);
      max-height: var(--app-height);
      overflow: hidden;
      transition: background 0.4s var(--transition-normal), width 0.3s var(--transition-normal);
      width: calc(100% - var(--sidebar-width));
    }
    .sidebar.collapsed + .main-content {
        width: calc(100% - var(--sidebar-width-collapsed));
    }


    .chat-container {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      min-height: 0;
      padding: 1rem 0 0.2rem 1.5rem;
      overflow: hidden;
      position: relative;
      background: var(--card-bg);
      transition: background-image 0.4s var(--transition-normal), background-color 0.4s var(--transition-normal), padding 0.4s var(--transition-normal);
    }
    .chat-container.chat-container-custom-bg {
        padding-left: 0px;
        padding-bottom: 0px;
    }


    .toggle-mode {
      margin-bottom: 1.5rem;
      text-align: center;
      user-select: none;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.5rem 0;
      flex-shrink: 0;
    }
    .toggle-mode button {
      background: transparent;
      color: var(--accent-color);
      border: 2px solid var(--accent-color);
      padding: 0.6rem 1.8rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast), transform 0.1s ease-out;
      outline: none;
      letter-spacing: 0.01em;
    }
    .toggle-mode button.selected, .toggle-mode button:hover {
      background: var(--accent-gradient);
      color: #fff;
      box-shadow: 0 3px 12px rgba(var(--accent-color-rgb),0.2);
      border-color: transparent;
    }
    .toggle-mode button:active {
      transform: scale(var(--button-active-scale));
      transition-duration: 0.05s;
    }

    #groupParticipants {
      display: none;
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      background: var(--participant-bg);
      border-radius: var(--border-radius);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05), var(--shadow);
      overflow-x: auto;
      white-space: nowrap;
      user-select: none;
      transition: background 0.4s var(--transition-normal), box-shadow 0.4s var(--transition-normal);
      flex-shrink: 0;
      animation: slideDownFadeIn 0.4s var(--transition-normal) forwards;
    }
    .dark-theme #groupParticipants {
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), var(--shadow);
    }
    #groupParticipants .participant {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0.5rem 0.8rem;
      border-radius: calc(var(--border-radius) - 4px);
      background: rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-right: 0.8rem;
      min-width: 75px;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      color: var(--text-color);
      font-weight: 500;
      font-size: 0.9rem;
    }
    .dark-theme #groupParticipants .participant {
      background: rgba(255,255,255,0.1);
    }
    #groupParticipants .participant:hover {
      background: #fff;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .dark-theme #groupParticipants .participant:hover {
      background: rgba(255,255,255,0.2);
    }
    #groupParticipants .participant.active {
      background: var(--participant-active-bg);
      color: #fff;
      box-shadow: 0 5px 15px rgba(var(--accent-color-rgb),0.3);
      transform: scale(1.08);
      font-weight: 600;
    }
    #groupParticipants .participant img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.3rem;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .dark-theme #groupParticipants .participant img {
      border-color: var(--accent-color);
    }

    #settingsModal, #lorebookModal, #backgroundModal, #greetingSelectModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.65);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.25s ease-out;
      padding: 1rem;
      box-sizing: border-box;
    }
    #settingsModal.above-hamburger,
    #lorebookModal.above-hamburger,
    #backgroundModal.above-hamburger,
    #greetingSelectModal.above-hamburger {
        z-index: 1010;
    }

    #settingsModal[style*="display: flex"],
    #lorebookModal[style*="display: flex"],
    #backgroundModal[style*="display: flex"],
    #greetingSelectModal[style*="display: flex"] {
      opacity: 1;
    }
    .settings-content, 
@keyframes slideUpFadeInModal {
      from { opacity: 0.5; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dark-theme .settings-content, .dark-theme .greeting-select-content {
      background: var(--card-bg);
    }
    .settings-content .close-btn, .greeting-select-content .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      font-size: 28px;
      line-height: 1;
      padding: 5px;
      cursor: pointer;
      color: var(--text-color);
      opacity: 0.7;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
      transform-origin: center;
    }
    .settings-content .close-btn:hover, .greeting-select-content .close-btn:hover {
      opacity: 1;
      transform: rotate(90deg);
    }

    .settings {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 1.5rem;
    }

    .settings-content fieldset {
      border: 1px solid rgba(var(--accent-color-rgb), 0.3);
      border-radius: var(--border-radius);
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      background: rgba(var(--accent-color-rgb), 0.03);
    }
    .dark-theme .settings-content fieldset {
      border-color: rgba(var(--accent-color-rgb), 0.4);
      background: rgba(var(--accent-color-rgb), 0.06);
    }
    .settings-content legend {
      font-weight: 600;
      color: var(--accent-color);
      padding: 0 0.5rem;
      font-size: 1.1rem;
    }

    .settings-content .settings > fieldset {
      grid-column: span 2;
    }

    .settings-content .settings > .fieldset-span-1 {
      grid-column: span 1;
    }

    .settings-content label {
        color: var(--text-color);
        display: block;
        margin-bottom: 0.3rem;
        font-weight: 500;
    }
    .settings-content input, .settings-content textarea, .settings-content select, .settings-content input[type="color"] {
      width: 100%;
      margin-bottom: 0.5rem;
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      background-color: var(--input-bg);
      border: 1px solid transparent;
      border-radius: calc(var(--border-radius) - 6px);
      color: var(--text-color);
      transition: box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
      font-family: inherit;
      outline: none;
      font-weight: 500;
      box-sizing: border-box;
    }
     .settings-content input[type="color"] {
        padding: 0.2rem;
        height: 40px;
    }
    .settings-content input[type="range"] {
        padding: 0.2rem 0;
    }
    .settings-content .font-size-indicator {
        display: inline-block;
        margin-left: 10px;
        font-weight: 500;
        color: var(--text-color);
    }
    .settings-content input:focus, .settings-content textarea:focus, .settings-content select:focus, .settings-content input[type="color"]:focus {
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
      border-color: var(--accent-color);
      background: #fff;
    }
    .dark-theme .settings-content input:focus, .dark-theme .settings-content textarea:focus, .dark-theme .settings-content select:focus, .dark-theme .settings-content input[type="color"]:focus {
      background: var(--sidebar-hover-bg);
      border-color: var(--accent-color);
    }
    .settings-content textarea {
      min-height: 100px;
      max-height: 250px;
      resize: vertical;
    }
    .settings-content .avatar-selection {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .settings-content .settings .avatar-selection {
        grid-column: span 1;
    }

    .settings-content button,
    #lorebookModal button[type="button"],
    #backgroundModal button[type="button"],
    .greeting-select-content button {
      background: var(--accent-gradient);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.15);
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      outline: none;
      letter-spacing: 0.01em;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .settings-content button:hover,
    #lorebookModal button[type="button"]:hover,
    #backgroundModal button[type="button"]:hover,
    .greeting-select-content button:hover {
      filter: brightness(var(--button-hover-brightness));
      box-shadow: 0 4px 15px rgba(var(--accent-color-rgb),0.25);
      transform: translateY(-1px);
    }
    .settings-content button:active,
    #lorebookModal button[type="button"]:active,
    #backgroundModal button[type="button"]:active,
    .greeting-select-content button:active {
      transform: scale(var(--button-active-scale)) translateY(0);
      filter: brightness(0.95);
    }
    .settings-content .avatar-selection button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; margin-bottom: 0.4rem;}
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s var(--transition-normal); border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .3s var(--transition-normal); border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
    input:checked + .slider:before { transform: translateX(22px); }

    .messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem 0.5rem;
      background-color: transparent;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: background 0.4s var(--transition-normal), background-color 0.4s var(--transition-normal);
      scroll-behavior: smooth;
      position: relative;
      white-space: pre-wrap;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: calc(1.05rem * var(--chat-font-size-multiplier));
      line-height: calc(1.5 * var(--chat-font-size-multiplier));
      color: var(--text-color);
      user-select: text;
      min-height: 150px;
    }
    .messages.has-custom-background .message {
        background-color: rgba(var(--bubble-bot-rgb), 0.85);
    }
    .messages.has-custom-background .message.user {
        background-color: rgba(var(--bubble-user-rgb), 0.85);
    }
    .messages.has-custom-background .message.api {
        background-color: rgba(var(--bubble-api-rgb), 0.85);
    }
    .messages.has-custom-background .message.system {
        background-color: rgba(var(--bubble-system-rgb), 0.85);
        color: var(--text-color);
    }
    .dark-theme .messages.has-custom-background .message.system {
        color: var(--text-color);
    }


    .dark-theme .messages {
      color: var(--text-color);
    }
    .message-container {
      display: flex;
      flex-direction: column;
      margin-bottom: 1.2rem;
      opacity: 0;
      animation: messageFadeInUp 0.4s var(--transition-normal) forwards;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }
    .message-content-wrapper {
        display: flex;
        align-items: flex-start;
        width: 100%;
    }
    .message-container.user-container .message-content-wrapper {
        justify-content: flex-end;
    }

    @keyframes messageFadeInUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 0.8rem;
      border: 2px solid var(--accent-color);
      box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.1);
      transition: border-color 0.4s var(--transition-normal);
      background: #fff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .dark-theme .avatar {
      border-color: var(--accent-color);
      box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.4);
      background: var(--card-bg);
    }
    .message {
      word-wrap: break-word;
      flex: 0 1 auto;
      max-width: calc(75% - 40px);
      background: var(--bubble-bot);
      padding: 0.75rem 1.1rem;
      border-radius: 1.2em 1.2em 1.2em 0.5em;
      line-height: 1.45;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      transition: background 0.3s var(--transition-normal), color 0.3s var(--transition-normal);
      position: relative;
      color: var(--text-color);
      white-space: pre-wrap;
    }

    .message em, .message i {
        color: var(--italic-text-color);
        font-style: italic;
    }
    .message strong, .message b {
        color: var(--bold-text-color);
        font-weight: bold;
    }
    .dark-theme .message em, .dark-theme .message i {
        color: var(--italic-text-color);
    }
    .dark-theme .message strong, .dark-theme .message b {
        color: var(--bold-text-color);
    }

    .message .attachments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .message img.attached-image, .message .attached-file-preview {
        max-width: 100%;
        height: auto;
        max-height: 120px;
        border-radius: calc(var(--border-radius) - 8px);
        display: block;
        cursor: zoom-in;
        object-fit: cover;
    }
    .message a.attached-file-link {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: rgba(var(--accent-color-rgb), 0.1);
        color: var(--accent-color);
        border-radius: calc(var(--border-radius) - 8px);
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
        word-break: break-all;
        height: 100px;
    }
    .message a.attached-file-link:hover {
        background-color: rgba(var(--accent-color-rgb), 0.2);
    }
    .message a.attached-file-link .file-icon {
        font-size: 2rem;
        margin-bottom: 0.3rem;
    }


    .dark-theme .message {
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .message p { margin: 0.3em 0; padding: 0; }
    .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 { display: block; font-size: 1.1em; font-weight: bold; margin-top: 0.5em; margin-bottom: 0.2em;}
    .message ul, .message ol { margin: 0.5em 0; padding-left: 1.8em; }
    .message.user {
      background: var(--bubble-user);
      border-radius: 1.2em 1.2em 0.5em 1.2em;
      font-weight: 500;
    }
    .message-container.user-container .message-content-wrapper .avatar {
        order: 1;
        margin-left: 0.8rem;
        margin-right: 0;
    }
    .message.api { background: var(--bubble-api); }
    .message.system { background: var(--bubble-system); color: #777; font-style: italic; font-size: 0.9em; max-width: 100%; text-align: center; }
    .dark-theme .message.system { color: #bbb; }

    .message-buttons {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      margin-top: 0.5rem;
      padding-left: calc(44px + 0.8rem);
      width: fit-content;
    }
    .message-container.user-container .message-buttons {
      padding-left: 0;
      padding-right: calc(44px + 0.8rem);
      margin-left: auto;
    }

    .message-buttons button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: var(--accent-gradient);
      color: #fff;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .message-buttons button:hover {
      filter: brightness(var(--button-hover-brightness));
      box-shadow: 0 2px 6px rgba(var(--accent-color-rgb),0.2);
      transform: scale(1.1);
    }
    .message-buttons button:active {
      transform: scale(var(--button-active-scale)) translateY(0);
    }
    .message-buttons button:disabled {
        background: #ccc;
        cursor: not-allowed;
        filter: grayscale(50%);
    }
    .message-buttons .delete-btn::before { content: "üóëÔ∏è"; }
    .message-buttons .regen-btn::before { content: "üîÑ"; }
    .message-buttons .edit-btn::before { content: "‚úèÔ∏è"; }
    .message-buttons .copy-btn::before { content: "üìã"; }

    /* --- –°–¢–ò–õ–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô (–ò–°–ü–†–ê–í–õ–ï–ù–û) --- */
    .message-edit-area {
      width: 100%; /* –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è max-width */
      max-width: 75%; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã, –∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
      box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –Ω–µ –≤–ª–∏—è–ª –Ω–∞ –æ–±—â—É—é —à–∏—Ä–∏–Ω—É */
      min-height: 80px;
      max-height: 200px;
      resize: vertical;
      font-size: inherit;
      padding: 0.7rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--accent-color);
      background: var(--input-bg);
      color: var(--text-color);
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.2);
      margin-bottom: 0.5rem;
      outline: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .message-container:not(.user-container) .message-edit-area {
        margin-left: calc(44px + 0.8rem); /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ */
    }
    .message-container.user-container .message-edit-area {
        margin-left: auto; /* –ê–≤—Ç–æ-–æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        margin-right: calc(44px + 0.8rem); /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    }
    .dark-theme .message-edit-area {
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.5);
    }
    .edit-button-container {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding-left: calc(44px + 0.8rem);
    }
    .message-container.user-container .edit-button-container {
        padding-left: 0;
        padding-right: calc(44px + 0.8rem);
        justify-content: flex-end;
    }


    .input-area-container {
        padding: 0.3rem 0;
        border-top: 1px solid rgba(var(--accent-color-rgb),0.2);
        background: var(--card-bg);
        flex-shrink: 0;
        transition: border-color 0.4s var(--transition-normal), background-color 0.4s var(--transition-normal);
    }
    .dark-theme .input-area-container {
        border-top: 1px solid rgba(var(--accent-color-rgb),0.3);
    }
    /* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–†–û–ó–†–ê–ß–ù–û–ì–û –í–í–û–î–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) --- */
    .input-area-container.has-custom-background-too {
        background-color: rgba(var(--card-bg-rgb), 0.65) !important;
        border-top-color: rgba(var(--accent-color-rgb), 0.2) !important;
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
    }
    .input-area-container.has-custom-background-too #userInput {
        background-color: rgba(var(--input-bg-rgb), 0.7) !important;
        color: var(--text-color);
    }
    .dark-theme .input-area-container.has-custom-background-too #userInput {
        background-color: rgba(var(--input-bg-rgb), 0.7) !important;
    }


    #filePreviewsContainer {
        display: none;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem 0.5rem 0.3rem 0.5rem;
        max-height: 120px;
        overflow-y: auto;
        border-bottom: 1px solid rgba(var(--accent-color-rgb),0.1);
    }
    .file-preview-item {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--input-bg);
        border-radius: calc(var(--border-radius) - 8px);
        padding: 0.3rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        width: 80px;
        height: 80px;
    }
    .file-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: calc(var(--border-radius) - 10px);
    }
    .file-preview-item .file-info {
        font-size: 0.7rem;
        color: var(--text-color);
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        margin-top: 0.2rem;
    }
    .file-preview-item .file-icon-placeholder {
        font-size: 2rem;
        color: var(--accent-color);
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .remove-file-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        z-index: 1;
    }


    .input-row {
      display: flex;
      align-items: flex-end; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –Ω–∏–∂–Ω–µ–º—É –∫—Ä–∞—é */
      gap: 0.5rem;
      position: relative;
      padding: 0 0.5rem;
    }

    .mobile-input-prefix {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 0.4rem;
        flex-shrink: 0;
    }

    #userInput {
      flex-grow: 1;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border-radius: var(--border-radius);
      border: 1px solid transparent;
      background-color: var(--input-bg);
      color: var(--text-color);
      resize: none;
      transition: box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      font-family: inherit;
      min-height: 44px;
      max-height: 150px;
      outline: none;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
      overflow-y: auto;
      line-height: 1.4;
      box-sizing: border-box; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ */
    }
    #userInput:focus {
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
      border-color: var(--accent-color);
      background: #fff;
    }
    .dark-theme #userInput:focus {
      background: var(--sidebar-hover-bg);
    }
    button.send-button, .file-attach-button {
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: filter var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      outline: none;
      white-space: nowrap;
      user-select: none;
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-sizing: border-box; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ */
    }
    button.send-button:hover, .file-attach-button:hover {
      filter: brightness(var(--button-hover-brightness));
      box-shadow: 0 4px 15px rgba(var(--accent-color-rgb),0.25);
      transform: translateY(-1px);
    }
    button.send-button:active, .file-attach-button:active {
      transform: scale(var(--button-active-scale)) translateY(0);
      filter: brightness(0.95);
    }
    button.send-button#sendButton {
      padding: 0.8rem 1.5rem; /* –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤—ã—Å–æ—Ç–µ textarea */
      height: 44px; /* –Ø–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
      font-size: 1rem;
      letter-spacing: 0.02em;
    }
    .file-attach-button {
      width: 44px;
      height: 44px;
      font-size: 18px;
    }
    input#fileInput { display: none; }

    .status-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.3rem;
      padding: 0 0.5rem;
      flex-wrap: wrap;
    }
    #messages-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
      box-shadow: 0 0 8px #ccc;
      transition: background 0.3s var(--transition-normal), box-shadow 0.3s var(--transition-normal);
      flex-shrink: 0;
      margin-bottom: 16px; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
    }
    #messages-status-indicator.active {
      background: #4CAF50;
      box-shadow: 0 0 12px #4CAF50;
      animation: pulseIndicator 1.8s infinite ease-in-out;
    }
    @keyframes pulseIndicator {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }
    .status-container button {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        background: var(--participant-bg);
        color: var(--text-color);
        border: 1px solid var(--accent-color);
    }
    .status-container button:hover {
        background: var(--sidebar-hover-bg);
    }
    .status-container button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    #variantCounter {
        font-weight: 600;
        font-size: 0.9rem;
        user-select: none;
        color: var(--accent-color);
    }

    .memory-box {
      background: var(--input-bg);
      border-radius: calc(var(--border-radius) - 6px);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      color: var(--text-color);
      resize: vertical;
      min-height: 80px;
      max-height: 150px;
      width: 100%;
      font-family: inherit;
      border: 1px solid transparent;
      outline: none;
      transition: box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      font-weight: 500;
      box-sizing: border-box;
    }
    .memory-box:focus {
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
      border-color: var(--accent-color);
      background: #fff;
    }
    .dark-theme .memory-box {
      background: var(--input-bg);
    }
    .dark-theme .memory-box:focus {
      background: var(--sidebar-hover-bg);
    }

    #themeToggle, #toggleSettingsBtn {
      position: fixed;
      background: var(--accent-gradient);
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      cursor: pointer;
      box-shadow: 0 4px 18px rgba(var(--accent-color-rgb),0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s var(--transition-normal), transform 0.2s var(--transition-fast), box-shadow 0.3s var(--transition-normal), filter 0.2s var(--transition-fast);
      z-index: 100;
      outline: none;
    }
    #themeToggle:hover, #toggleSettingsBtn:hover {
      filter: brightness(var(--button-hover-brightness));
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 6px 22px rgba(var(--accent-color-rgb),0.4);
    }
    #themeToggle:active, #toggleSettingsBtn:active {
      transform: scale(var(--button-active-scale));
    }
    #themeToggle { top: 20px; right: 20px; }
    #toggleSettingsBtn { top: 85px; right: 20px; }
    #themeToggle svg { fill: white; width: 24px; height: 24px; transition: transform 0.4s ease-in-out; }
    .dark-theme #themeToggle svg { transform: rotate(180deg); }
    #toggleSettingsBtn span { font-size: 22px; color: white; }

    #lorebookModal .settings-content { max-width: 600px; }
    .lorebook-entry {
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0,0,0,0.03);
      border-radius: calc(var(--border-radius) - 4px);
      border: 1px solid rgba(var(--accent-color-rgb),0.2);
    }
    .dark-theme .lorebook-entry {
        background: rgba(255,255,255,0.04);
        border-color: rgba(var(--accent-color-rgb),0.3);
    }
    .lorebook-entry label { display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem; color: var(--accent-color); }
    .lorebook-entry input, .lorebook-entry textarea {
      width: 100%;
      margin-bottom: 0.5rem;
      box-sizing: border-box;
    }
    .lorebook-entry textarea { min-height: 80px; }

    #backgroundModal .settings-content { max-width: 450px; text-align: center; }
    #backgroundModal input[type="file"] { display: block; margin: 1rem auto; }

    @keyframes slideDownFadeIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUpFadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
        overflow-y: hidden;
        height: var(--app-height);
      }

      .hamburger-btn { display: flex; }
      .mobile-menu-container { display: flex; }

      #sidebarToggleButton { display: none !important; }
      .sidebar { display: none !important; }

      body > #themeToggle, body > #toggleSettingsBtn { display: none !important; }


      .main-content {
          width: 100% !important;
          min-height: 0;
          flex-grow: 1;
          overflow: hidden;
          height: 100%;
      }
      .chat-container {
          padding: 0.8rem 0 0.3rem 0.8rem;
      }
      .chat-container.chat-container-custom-bg {
          padding-left: 0px;
          padding-bottom: 0px;
      }

      .messages {
          padding-left: 0.1rem;
          padding-right: 0.8rem;
      }

      .message-content-wrapper {
          flex-direction: column;
      }
      .message-container .message-content-wrapper {
          align-items: flex-start;
      }
      .message-container.user-container .message-content-wrapper {
          align-items: flex-end;
      }

      .avatar {
          width: 30px;
          height: 30px;
          margin-right: 0;
          margin-left: 0;
          margin-bottom: 0.3rem;
      }
      .message-container.user-container .message-content-wrapper .avatar {
          order: 0;
      }

      .message {
          max-width: 100%;
          padding: 0.5rem 0.8rem;
      }

      .message-buttons {
          padding: 0 0.8rem;
          box-sizing: border-box;
          width: 100%;
          margin-left: 0;
          margin-right: 0;
      }
      .message-container .message-buttons {
          justify-content: flex-start;
      }
      .message-container.user-container .message-buttons {
          justify-content: flex-end;
          padding-right: 0 !important;
      }

      .edit-button-container {
          padding: 0 0.8rem;
          box-sizing: border-box;
          width: 100%;
          margin-left: 0;
          margin-right: 0;
      }
      .message-container .edit-button-container {
          justify-content: flex-start;
      }
      .message-container.user-container .edit-button-container {
          justify-content: flex-end;
          padding-right: 0 !important;
      }

      #groupParticipants { margin-bottom: 1rem; }


      .input-area-container {
        padding: 0.5rem;
      }
      .input-row {
        flex-wrap: nowrap;
        align-items: center; /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤–µ—Ä–Ω–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
        gap: 0.4rem;
        padding: 0;
      }
      .mobile-input-prefix {
        display: flex;
      }

      .input-row > .file-attach-button:not(.mobile-input-prefix .file-attach-button),
      .input-row > #messages-status-indicator:not(.mobile-input-prefix #messages-status-indicator) {
        display: none !important;
      }


      #userInput {
        font-size: 0.95rem;
        padding: 0.7rem 0.9rem;
        min-height: 80px;
      }
      button.send-button#sendButton {
        width: 40px;
        height: 40px;
        padding: 0;
        font-size: 1.2rem;
        line-height: 1;
        border-radius: 50%;
        flex-shrink: 0;
        margin-left: 0.4rem;
      }

      .mobile-input-prefix .file-attach-button {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        flex-shrink: 0;
      }
      .mobile-input-prefix #messages-status-indicator {
          margin: 0;
          flex-shrink: 0;
          width: 12px;
          height: 12px;
      }
      #messages-status-indicator {
        margin-bottom: 0;
      }

      .settings-content .settings {
        grid-template-columns: 1fr;
      }
      .settings-content .settings > .fieldset-span-1 {
        grid-column: span 1;
      }
      .settings-content .settings .avatar-selection {
        flex-direction: column;
        align-items: stretch;
        grid-column: span 1;
      }
      .settings-content .settings .avatar-selection button {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      .settings-content { padding: 1rem 1.2rem; max-height: 80vh; }


      .message-buttons button { width: 28px; height: 28px; font-size: 14px; }
    }
    @media (min-width: 901px) {
        .hamburger-btn {
            display: none !important;
        }
        #sidebarToggleButton {
            display: flex !important;
        }
        .sidebar {
            display: flex !important;
        }
    }


    @media (max-width: 480px) {
      .avatar {
          width: 28px;
          height: 28px;
          margin-bottom: 0.2rem;
      }
      .message {
          padding: 0.4rem 0.7rem;
      }

      .input-row { gap: 0.2rem; }
      #userInput { min-height: 70px; padding: 0.6rem 0.8rem; font-size: 0.9rem; }
      button.send-button#sendButton,
      .mobile-input-prefix .file-attach-button {
        width: 38px;
        height: 38px;
      }
      .mobile-input-prefix { margin-right: 0.3rem; }


      .memory-box { font-size: 0.9rem; padding: 0.7rem; }
      .settings-content { padding: 1rem; }
      .settings-content legend {font-size: 1rem;}
      .settings-content input, .settings-content textarea, .settings-content select {font-size: 0.9rem; padding: 0.7rem 0.9rem;}
      .settings-content button {font-size: 0.9rem; padding: 0.7rem 1.2rem;}


      .hamburger-btn { top: 10px; left: 10px; width: 40px; height: 40px; }
      .hamburger-btn span { width: 20px; height: 2.5px;}
      .hamburger-btn span::before { transform: translateY(-6px); }
      .hamburger-btn span::after { transform: translateY(6px); }
    }

  </style>
<meta name="description" content="Charis Chat ‚Äî –æ–Ω–ª–∞–π–Ω —á–∞—Ç-–±–æ—Ç —Å –ò–ò –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ë–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ, –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤. –õ–∏—á–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã, –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (Chub), –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ SillyTavern –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤."><meta name="keywords" content="—á–∞—Ç —Å –ò–ò, –æ–Ω–ª–∞–π–Ω —á–∞—Ç-–±–æ—Ç, AI chat, Charis Chat, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ SillyTavern, –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π —á–∞—Ç–±–æ—Ç, –æ–±—â–µ–Ω–∏–µ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é, –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ Chub, —á–∞—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º, AI group chat, AI character cards, free AI chat, multilingual chatbot"><meta name="author" content="Charis" /><meta property="og:title" content="Charis Chat" />
<meta property="og:description" content="–ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç-–±–æ—Ç —Å –ò–ò –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (Chub)." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://charis-chat.vercel.app/" />
<meta property="og:image" content="https://charis-chat.vercel.app/logo-1024.png" />
<meta property="og:image:width" content="1024" />
<meta property="og:image:height" content="1024" />
<meta property="og:locale" content="ru_RU" />
<meta property="og:locale:alternate" content="en_US" /><meta content="–£–º–Ω—ã–π AI —á–∞—Ç-–±–æ—Ç –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö." property="og:description"/><meta content="website" property="og:type"/><meta content="https://charis.vercel.app" property="og:url"/><meta content="ru_RU" property="og:locale"/><meta content="en_US" property="og:locale:alternate"/><meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Charis Chat" />
<meta name="twitter:description" content="–û–±—â–∞–π—Å—è —Å –ò–ò –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ, –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ –∏ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤, –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (Chub), –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã." />
<meta name="twitter:image" content="https://charis-chat.vercel.app/logo-1024.png" /><meta content="–ß–∞—Ç-–±–æ—Ç Charis" name="twitter:title"/><meta content="–£–º–Ω—ã–π AI —á–∞—Ç-–±–æ—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è LLM." name="twitter:description"/></meta>
<style>
/* Mobile tab styles - hidden by default (so PC is unaffected) */
.settings-content .tab-buttons { display: none; }
.settings-content .tab-page { display: block; }

@media (max-width: 900px) {
  .settings-content .tab-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    overflow-x: auto;
  }
  .settings-content .tab-buttons button {
    flex: 1;
    padding: 0.6rem;
    font-size: 0.9rem;
    border: 1px solid var(--accent-color);
    border-radius: var(--border-radius);
    background: var(--card-bg);
    color: var(--text-color);
    white-space: nowrap;
  }
  .settings-content .tab-buttons button.active {
    background: var(--accent-gradient);
    color: #fff;
    border-color: transparent;
  }
  .settings-content .tab-page {
    display: none;
    flex-direction: column;
    gap: 1rem;
  }
  .settings-content .tab-page.active {
    display: flex;
  }
  /* Ensure settings grid becomes single column on mobile (for compatibility) */
  .settings-content .settings { display: block; }
}
</style>
<style>
/* Mobile actions panel - hidden on desktop */
.settings-content .mobile-actions { display: none; }

/* buttons look compact on mobile */
.settings-content .mobile-actions .mobile-action-btn {
  padding: 0.6rem 0.8rem;
  border-radius: 10px;
  border: 1px solid rgba(var(--accent-color-rgb),0.12);
  background: var(--input-bg);
  color: var(--text-color);
  font-weight: 600;
  width: 100%;
  box-sizing: border-box;
}

/* two-column small screens */
@media (max-width: 480px) {
  .settings-content .mobile-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
}
@media (min-width: 481px) and (max-width:900px) {
  .settings-content .mobile-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
  .settings-content .mobile-actions .mobile-action-btn { padding: 0.6rem; }
}
/* Keep hidden on desktop explicitly */
@media (min-width: 901px) {
  .settings-content .mobile-actions { display: none !important; }
}
</style><style>
@media (min-width: 901px) {
  .settings-content .tab-buttons { display: none !important; }
}
</style><style>
@media (max-width: 900px) {
  .settings-content .mobile-actions { 
    display: flex !important; 
  }
  .settings-content .mobile-actions button {
    flex: 1 1 calc(50% - 0.5rem);
    min-width: 120px;
  }
}
@media (max-width: 480px) {
  .settings-content .mobile-actions button {
    flex: 1 1 100%;
  }
}
@media (min-width: 901px) {
  .settings-content .mobile-actions {
    display: none !important;
  }
}
</style>
<style>
/* show mobile color picker only on mobile */
.settings-content .mobile-color-picker { display: none; }
@media (max-width: 900px) {
  .settings-content .mobile-color-picker { display: block !important; }
  .settings-content .mobile-actions { display: grid !important; grid-template-columns: repeat(2, 1fr); gap:0.5rem; }
  .settings-content .mobile-actions .mobile-action-btn { width:100%; }
}
</style>

<!-- MODAL STYLES IMPORTED FROM index_animation_fixed.html -->
<style>
    :root {
      --bg-color: #fdeef5;
      --accent-color: #ff7aac;
      --accent-gradient: linear-gradient(135deg, #ff7aac 0%, #ffb6d5 100%);
      --text-color: #E91E63; /* Default pink text color */
      --italic-text-color: #9E9E9E; /* Default light gray for italics */
      --bold-text-color: #E91E63; /* Default pink for bold (as per user, can be same as text-color) */
      --card-bg: #fff8fb;
      --card-bg-rgb: 255, 248, 251; /* RGB for --card-bg */
      --input-bg: #ffe8f2;
      --input-bg-rgb: 255, 232, 242; /* RGB for --input-bg */
      --border-radius: 16px;
      --participant-bg: #fff0f7;
      --participant-active-bg: #ff7aac;
      --shadow: 0 10px 35px 0 rgba(255, 122, 172, 0.15);
      --transition-fast: 0.2s ease-out;
      --transition-normal: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --bubble-user: #ffe8f2;
      --bubble-user-rgb: 255, 232, 242;
      --bubble-bot: #f0f8ff;
      --bubble-bot-rgb: 240, 248, 255;
      --bubble-system: #f5f5f5;
      --bubble-system-rgb: 245, 245, 245;
      --bubble-api: #e6fff5;
      --bubble-api-rgb: 230, 255, 245;
      --sidebar-bg: #fff5fa;
      --sidebar-accent: #ff6fa8;
      --sidebar-hover-bg: #ffe0ef;
      --sidebar-active-bg: #ff7aac;
      --button-hover-brightness: 1.08;
      --button-active-scale: 0.97;
      --accent-color-rgb: 255, 122, 172;
      --chat-font-size-multiplier: 1;
      --app-height: 100vh; /* Variable for dynamic viewport height */
      --sidebar-width: 280px;
      --sidebar-width-collapsed: 0px;
    }

    .dark-theme {
      --bg-color: #2c1d27;
      --accent-color: #ff8fbc;
      --accent-gradient: linear-gradient(135deg, #ff8fbc 0%, #ff6099 100%);
      --card-bg: #3b2a36;
      --card-bg-rgb: 59, 42, 54; /* RGB for dark --card-bg */
      --input-bg: #4f3548;
      --input-bg-rgb: 79, 53, 72; /* RGB for dark --input-bg */
      --participant-bg: #5c4055;
      --participant-active-bg: #ff6099;
      --bubble-user: #4f3548;
      --bubble-user-rgb: 79, 53, 72;
      --bubble-bot: #30404f;
      --bubble-bot-rgb: 48, 64, 79;
      --bubble-system: #4a4a4a;
      --bubble-system-rgb: 74, 74, 74;
      --bubble-api: #2a4f40;
      --bubble-api-rgb: 42, 79, 64;
      --sidebar-bg: #3b2a36;
      --sidebar-accent: #ff6099;
      --sidebar-hover-bg: #603050;
      --sidebar-active-bg: #ff6099;
      --shadow: 0 10px 35px 0 rgba(255, 96, 153, 0.3);
      --accent-color-rgb: 255, 143, 188;
    }

    html {
      height: -webkit-fill-available;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      width: 100vw;
      overflow: hidden;
      transition: background 0.4s var(--transition-normal), color 0.4s var(--transition-normal);
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: var(--app-height);
      min-height: var(--app-height);
    }

    body {
      display: flex;
      flex-direction: row;
    }

    .hamburger-btn {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1005;
        background: var(--accent-gradient);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.3);
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    .hamburger-btn span {
        display: block;
        width: 22px;
        height: 3px;
        background-color: white;
        border-radius: 3px;
        position: relative;
        transition: all 0.3s ease-in-out;
    }
    .hamburger-btn span::before,
    .hamburger-btn span::after {
        content: '';
        position: absolute;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        border-radius: 3px;
        transition: all 0.3s ease-in-out;
    }
    .hamburger-btn span::before { transform: translateY(-7px); }
    .hamburger-btn span::after { transform: translateY(7px); }

    .hamburger-btn.open span { background-color: transparent; }
    .hamburger-btn.open span::before { transform: rotate(45deg) translateY(0px); }
    .hamburger-btn.open span::after { transform: rotate(-45deg) translateY(0px); }


    .mobile-menu-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        max-width: 80vw;
        height: var(--app-height);
        background-color: var(--sidebar-bg);
        box-shadow: 3px 0 15px rgba(0,0,0,0.2);
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s var(--transition-normal);
        overflow-y: auto;
        flex-direction: column;
    }
    .mobile-menu-container.open {
        transform: translateX(0);
    }
    .mobile-menu-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem 1.2rem;
        border-bottom: 1px solid rgba(var(--accent-color-rgb),0.2);
        position: relative;
    }
    .mobile-menu-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--sidebar-accent);
    }
    .close-mobile-menu-btn {
        background: transparent;
        border: none;
        font-size: 2rem;
        color: var(--text-color);
        cursor: pointer;
        padding: 0.2rem;
        line-height: 1;
    }
    .mobile-menu-header .close-mobile-menu-btn {
        display: none;
    }

    #mobileMenuItemsPlaceholder {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    #mobileMenuItemsPlaceholder .sidebar-header {
        text-align: left; padding: 0 0 0.5rem 0; border-bottom: none; font-size: 1.2rem;
    }
    #mobileMenuItemsPlaceholder .chat-list {
        flex-direction: column; gap: 0.5rem; padding: 0; max-height: 250px; overflow-y: auto;
    }
    #mobileMenuItemsPlaceholder .chat-item {
        width: 100%; box-sizing: border-box;
    }

    #mobileMenuItemsPlaceholder #themeToggle,
    #mobileMenuItemsPlaceholder #toggleSettingsBtn {
        position: static;
        width: 100%;
        border-radius: var(--border-radius);
        display: flex !important;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem;
        font-size: 1rem;
    }
     #mobileMenuItemsPlaceholder #themeToggle svg { margin-right: 8px; }

    #mobileMenuItemsPlaceholder #themeToggle:hover,
    #mobileMenuItemsPlaceholder #toggleSettingsBtn:hover {
        transform: scale(1.02);
        filter: brightness(var(--button-hover-brightness));
        box-shadow: 0 4px 12px rgba(var(--accent-color-rgb),0.2);
    }

    #mobileMenuItemsPlaceholder #themeToggle:active,
    #mobileMenuItemsPlaceholder #toggleSettingsBtn:active {
        transform: scale(0.98);
        filter: brightness(0.95);
    }

    #sidebarToggleButton {
        background: var(--accent-gradient);
        color: white;
        border: none;
        cursor: pointer;
        width: 40px;
        height: 40px;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.25);
        border-radius: 50%;
        transition: background 0.2s var(--transition-fast), transform 0.2s var(--transition-fast), opacity 0.3s var(--transition-normal), filter 0.2s var(--transition-fast);
    }
    #sidebarToggleButton:hover {
        filter: brightness(var(--button-hover-brightness));
        transform: scale(1.05);
    }
    #sidebarToggleButton:active {
        transform: scale(var(--button-active-scale));
    }


    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      border-right: 1px solid rgba(var(--accent-color-rgb),0.2);
      display: flex;
      flex-direction: column;
      padding: 1rem 0;
      box-shadow: 3px 0 15px rgba(var(--accent-color-rgb),0.05);
      overflow-y: auto;
      overflow-x: hidden;
      user-select: none;
      transition: width 0.3s var(--transition-normal), background 0.4s var(--transition-normal), border-color 0.4s var(--transition-normal), padding 0.3s var(--transition-normal);
      flex-shrink: 0;
      height: var(--app-height);
      position: sticky;
      top: 0;
    }
    .sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
      padding: 1rem 0;
      border-right-width: 0;
    }
    .sidebar.collapsed .sidebar-header,
    .sidebar.collapsed .chat-list,
    .sidebar.collapsed .sidebar-footer {
        display: none;
    }

    .dark-theme .sidebar {
      border-color: rgba(var(--accent-color-rgb),0.3);
      box-shadow: 3px 0 15px rgba(var(--accent-color-rgb),0.15);
    }
    .sidebar-header {
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--sidebar-accent);
      text-align: center;
      padding: 0 1rem 1.2rem 1rem;
      border-bottom: 1px solid rgba(var(--accent-color-rgb),0.2);
      transition: border-color 0.4s var(--transition-normal), color 0.4s var(--transition-normal);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: 0.02em;
    }
    .dark-theme .sidebar-header {
      border-bottom: 1px solid rgba(var(--accent-color-rgb),0.3);
    }
    .chat-list {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1rem;
    }
    .chat-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.2rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      background: transparent;
      box-shadow: none;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
      color: var(--text-color);
      position: relative;
      font-weight: 500;
      font-size: 1rem;
      border: 1px solid transparent;
    }
    .chat-item:hover {
      background: var(--sidebar-hover-bg);
      box-shadow: 0 4px 12px rgba(var(--accent-color-rgb),0.1);
      transform: translateX(4px);
      border-color: rgba(var(--accent-color-rgb),0.3);
    }
    .chat-item.active {
      background: var(--sidebar-active-bg);
      color: #fff;
      box-shadow: 0 6px 18px rgba(var(--accent-color-rgb),0.25);
      transform: translateX(0);
      font-weight: 600;
      border-color: transparent;
    }
    .chat-item img {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
      transition: border-color 0.4s var(--transition-normal);
    }
    .dark-theme .chat-item img {
      border-color: var(--accent-color);
    }
    .chat-item .chat-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
    }
    .delete-char-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-color);
      opacity: 0.6;
      font-weight: 700;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      line-height: 1;
      transition: color var(--transition-fast), opacity var(--transition-fast);
    }
    .delete-char-btn:hover {
      color: #ff0055;
      opacity: 1;
    }

    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-color);
      position: relative;
      height: var(--app-height);
      max-height: var(--app-height);
      overflow: hidden;
      transition: background 0.4s var(--transition-normal), width 0.3s var(--transition-normal);
      width: calc(100% - var(--sidebar-width));
    }
    .sidebar.collapsed + .main-content {
        width: calc(100% - var(--sidebar-width-collapsed));
    }


    .chat-container {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      min-height: 0;
      padding: 1rem 0 0.2rem 1.5rem;
      overflow: hidden;
      position: relative;
      background: var(--card-bg);
      transition: background-image 0.4s var(--transition-normal), background-color 0.4s var(--transition-normal), padding 0.4s var(--transition-normal);
    }
    .chat-container.chat-container-custom-bg {
        padding-left: 0px;
        padding-bottom: 0px;
    }


    .toggle-mode {
      margin-bottom: 1.5rem;
      text-align: center;
      user-select: none;
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 0.5rem 0;
      flex-shrink: 0;
    }
    .toggle-mode button {
      background: transparent;
      color: var(--accent-color);
      border: 2px solid var(--accent-color);
      padding: 0.6rem 1.8rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background var(--transition-fast), color var(--transition-fast), box-shadow var(--transition-fast), transform 0.1s ease-out;
      outline: none;
      letter-spacing: 0.01em;
    }
    .toggle-mode button.selected, .toggle-mode button:hover {
      background: var(--accent-gradient);
      color: #fff;
      box-shadow: 0 3px 12px rgba(var(--accent-color-rgb),0.2);
      border-color: transparent;
    }
    .toggle-mode button:active {
      transform: scale(var(--button-active-scale));
      transition-duration: 0.05s;
    }

    #groupParticipants {
      display: none;
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      background: var(--participant-bg);
      border-radius: var(--border-radius);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05), var(--shadow);
      overflow-x: auto;
      white-space: nowrap;
      user-select: none;
      transition: background 0.4s var(--transition-normal), box-shadow 0.4s var(--transition-normal);
      flex-shrink: 0;
      animation: slideDownFadeIn 0.4s var(--transition-normal) forwards;
    }
    .dark-theme #groupParticipants {
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), var(--shadow);
    }
    #groupParticipants .participant {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0.5rem 0.8rem;
      border-radius: calc(var(--border-radius) - 4px);
      background: rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-right: 0.8rem;
      min-width: 75px;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      color: var(--text-color);
      font-weight: 500;
      font-size: 0.9rem;
    }
    .dark-theme #groupParticipants .participant {
      background: rgba(255,255,255,0.1);
    }
    #groupParticipants .participant:hover {
      background: #fff;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .dark-theme #groupParticipants .participant:hover {
      background: rgba(255,255,255,0.2);
    }
    #groupParticipants .participant.active {
      background: var(--participant-active-bg);
      color: #fff;
      box-shadow: 0 5px 15px rgba(var(--accent-color-rgb),0.3);
      transform: scale(1.08);
      font-weight: 600;
    }
    #groupParticipants .participant img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.3rem;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .dark-theme #groupParticipants .participant img {
      border-color: var(--accent-color);
    }

    #settingsModal, #lorebookModal, #backgroundModal, #greetingSelectModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.65);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.25s ease-out;
      padding: 1rem;
      box-sizing: border-box;
    }
    #settingsModal.above-hamburger,
    #lorebookModal.above-hamburger,
    #backgroundModal.above-hamburger,
    #greetingSelectModal.above-hamburger {
        z-index: 1010;
    }

    #settingsModal[style*="display: flex"],
    #lorebookModal[style*="display: flex"],
    #backgroundModal[style*="display: flex"],
    #greetingSelectModal[style*="display: flex"] {
      opacity: 1;
    }
    .settings-content, .greeting-select-content {
      background: var(--card-bg);
      padding: 1.5rem 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideUpFadeInModal 0.3s var(--transition-normal) forwards;
    }
    .greeting-select-content { max-width: 500px; }
    .greeting-select-content h2 { margin-top: 0;}
    .greeting-options { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
    .greeting-option {
        padding: 0.75rem;
        border: 1px solid rgba(var(--accent-color-rgb), 0.3);
        border-radius: calc(var(--border-radius) - 4px);
        cursor: pointer;
        transition: background-color var(--transition-fast), border-color var(--transition-fast);
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    .greeting-option:hover {
        background-color: var(--sidebar-hover-bg);
        border-color: var(--accent-color);
    }
    .greeting-option.selected {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }


    @keyframes slideUpFadeInModal {
      from { opacity: 0.5; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dark-theme .settings-content, .dark-theme .greeting-select-content {
      background: var(--card-bg);
    }
    .settings-content .close-btn, .greeting-select-content .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      font-size: 28px;
      line-height: 1;
      padding: 5px;
      cursor: pointer;
      color: var(--text-color);
      opacity: 0.7;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
      transform-origin: center;
    }
    .settings-content .close-btn:hover, .greeting-select-content .close-btn:hover {
      opacity: 1;
      transform: rotate(90deg);
    }

    .settings {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 1.5rem;
    }

    .settings-content fieldset {
      border: 1px solid rgba(var(--accent-color-rgb), 0.3);
      border-radius: var(--border-radius);
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      background: rgba(var(--accent-color-rgb), 0.03);
    }
    .dark-theme .settings-content fieldset {
      border-color: rgba(var(--accent-color-rgb), 0.4);
      background: rgba(var(--accent-color-rgb), 0.06);
    }
    .settings-content legend {
      font-weight: 600;
      color: var(--accent-color);
      padding: 0 0.5rem;
      font-size: 1.1rem;
    }

    .settings-content .settings > fieldset {
      grid-column: span 2;
    }

    .settings-content .settings > .fieldset-span-1 {
      grid-column: span 1;
    }

    .settings-content label {
        color: var(--text-color);
        display: block;
        margin-bottom: 0.3rem;
        font-weight: 500;
    }
    .settings-content input, .settings-content textarea, .settings-content select, .settings-content input[type="color"] {
      width: 100%;
      margin-bottom: 0.5rem;
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      background-color: var(--input-bg);
      border: 1px solid transparent;
      border-radius: calc(var(--border-radius) - 6px);
      color: var(--text-color);
      transition: box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
      font-family: inherit;
      outline: none;
      font-weight: 500;
      box-sizing: border-box;
    }
     .settings-content input[type="color"] {
        padding: 0.2rem;
        height: 40px;
    }
    .settings-content input[type="range"] {
        padding: 0.2rem 0;
    }
    .settings-content .font-size-indicator {
        display: inline-block;
        margin-left: 10px;
        font-weight: 500;
        color: var(--text-color);
    }
    .settings-content input:focus, .settings-content textarea:focus, .settings-content select:focus, .settings-content input[type="color"]:focus {
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
      border-color: var(--accent-color);
      background: #fff;
    }
    .dark-theme .settings-content input:focus, .dark-theme .settings-content textarea:focus, .dark-theme .settings-content select:focus, .dark-theme .settings-content input[type="color"]:focus {
      background: var(--sidebar-hover-bg);
      border-color: var(--accent-color);
    }
    .settings-content textarea {
      min-height: 100px;
      max-height: 250px;
      resize: vertical;
    }
    .settings-content .avatar-selection {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .settings-content .settings .avatar-selection {
        grid-column: span 1;
    }

    .settings-content button,
    #lorebookModal button[type="button"],
    #backgroundModal button[type="button"],
    .greeting-select-content button {
      background: var(--accent-gradient);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.15);
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      outline: none;
      letter-spacing: 0.01em;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .settings-content button:hover,
    #lorebookModal button[type="button"]:hover,
    #backgroundModal button[type="button"]:hover,
    .greeting-select-content button:hover {
      filter: brightness(var(--button-hover-brightness));
      box-shadow: 0 4px 15px rgba(var(--accent-color-rgb),0.25);
      transform: translateY(-1px);
    }
    .settings-content button:active,
    #lorebookModal button[type="button"]:active,
    #backgroundModal button[type="button"]:active,
    .greeting-select-content button:active {
      transform: scale(var(--button-active-scale)) translateY(0);
      filter: brightness(0.95);
    }
    .settings-content .avatar-selection button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; margin-bottom: 0.4rem;}
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s var(--transition-normal); border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .3s var(--transition-normal); border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
    input:checked + .slider:before { transform: translateX(22px); }

    .messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem 0.5rem;
      background-color: transparent;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: background 0.4s var(--transition-normal), background-color 0.4s var(--transition-normal);
      scroll-behavior: smooth;
      position: relative;
      white-space: pre-wrap;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: calc(1.05rem * var(--chat-font-size-multiplier));
      line-height: calc(1.5 * var(--chat-font-size-multiplier));
      color: var(--text-color);
      user-select: text;
      min-height: 150px;
    }
    .messages.has-custom-background .message {
        background-color: rgba(var(--bubble-bot-rgb), 0.85);
    }
    .messages.has-custom-background .message.user {
        background-color: rgba(var(--bubble-user-rgb), 0.85);
    }
    .messages.has-custom-background .message.api {
        background-color: rgba(var(--bubble-api-rgb), 0.85);
    }
    .messages.has-custom-background .message.system {
        background-color: rgba(var(--bubble-system-rgb), 0.85);
        color: var(--text-color);
    }
    .dark-theme .messages.has-custom-background .message.system {
        color: var(--text-color);
    }


    .dark-theme .messages {
      color: var(--text-color);
    }
    .message-container {
      display: flex;
      flex-direction: column;
      margin-bottom: 1.2rem;
      opacity: 0;
      animation: messageFadeInUp 0.4s var(--transition-normal) forwards;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }
    .message-content-wrapper {
        display: flex;
        align-items: flex-start;
        width: 100%;
    }
    .message-container.user-container .message-content-wrapper {
        justify-content: flex-end;
    }

    @keyframes messageFadeInUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 0.8rem;
      border: 2px solid var(--accent-color);
      box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.1);
      transition: border-color 0.4s var(--transition-normal);
      background: #fff;
      flex-shrink: 0;
      cursor: pointer;
    }
    .dark-theme .avatar {
      border-color: var(--accent-color);
      box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.4);
      background: var(--card-bg);
    }
    .message {
      word-wrap: break-word;
      flex: 0 1 auto;
      max-width: calc(75% - 40px);
      background: var(--bubble-bot);
      padding: 0.75rem 1.1rem;
      border-radius: 1.2em 1.2em 1.2em 0.5em;
      line-height: 1.45;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      transition: background 0.3s var(--transition-normal), color 0.3s var(--transition-normal);
      position: relative;
      color: var(--text-color);
      white-space: pre-wrap;
    }

    .message em, .message i {
        color: var(--italic-text-color);
        font-style: italic;
    }
    .message strong, .message b {
        color: var(--bold-text-color);
        font-weight: bold;
    }
    .dark-theme .message em, .dark-theme .message i {
        color: var(--italic-text-color);
    }
    .dark-theme .message strong, .dark-theme .message b {
        color: var(--bold-text-color);
    }

    .message .attachments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .message img.attached-image, .message .attached-file-preview {
        max-width: 100%;
        height: auto;
        max-height: 120px;
        border-radius: calc(var(--border-radius) - 8px);
        display: block;
        cursor: zoom-in;
        object-fit: cover;
    }
    .message a.attached-file-link {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: rgba(var(--accent-color-rgb), 0.1);
        color: var(--accent-color);
        border-radius: calc(var(--border-radius) - 8px);
        text-decoration: none;
        font-size: 0.9em;
        font-weight: 500;
        word-break: break-all;
        height: 100px;
    }
    .message a.attached-file-link:hover {
        background-color: rgba(var(--accent-color-rgb), 0.2);
    }
    .message a.attached-file-link .file-icon {
        font-size: 2rem;
        margin-bottom: 0.3rem;
    }


    .dark-theme .message {
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .message p { margin: 0.3em 0; padding: 0; }
    .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 { display: block; font-size: 1.1em; font-weight: bold; margin-top: 0.5em; margin-bottom: 0.2em;}
    .message ul, .message ol { margin: 0.5em 0; padding-left: 1.8em; }
    .message.user {
      background: var(--bubble-user);
      border-radius: 1.2em 1.2em 0.5em 1.2em;
      font-weight: 500;
    }
    .message-container.user-container .message-content-wrapper .avatar {
        order: 1;
        margin-left: 0.8rem;
        margin-right: 0;
    }
    .message.api { background: var(--bubble-api); }
    .message.system { background: var(--bubble-system); color: #777; font-style: italic; font-size: 0.9em; max-width: 100%; text-align: center; }
    .dark-theme .message.system { color: #bbb; }

    .message-buttons {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      margin-top: 0.5rem;
      padding-left: calc(44px + 0.8rem);
      width: fit-content;
    }
    .message-container.user-container .message-buttons {
      padding-left: 0;
      padding-right: calc(44px + 0.8rem);
      margin-left: auto;
    }

    .message-buttons button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: var(--accent-gradient);
      color: #fff;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), filter var(--transition-fast);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .message-buttons button:hover {
      filter: brightness(var(--button-hover-brightness));
      box-shadow: 0 2px 6px rgba(var(--accent-color-rgb),0.2);
      transform: scale(1.1);
    }
    .message-buttons button:active {
      transform: scale(var(--button-active-scale)) translateY(0);
    }
    .message-buttons button:disabled {
        background: #ccc;
        cursor: not-allowed;
        filter: grayscale(50%);
    }
    .message-buttons .delete-btn::before { content: "üóëÔ∏è"; }
    .message-buttons .regen-btn::before { content: "üîÑ"; }
    .message-buttons .edit-btn::before { content: "‚úèÔ∏è"; }
    .message-buttons .copy-btn::before { content: "üìã"; }

    /* --- –°–¢–ò–õ–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô (–ò–°–ü–†–ê–í–õ–ï–ù–û) --- */
    .message-edit-area {
      width: 100%; /* –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è max-width */
      max-width: 75%; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã, –∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
      box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –Ω–µ –≤–ª–∏—è–ª –Ω–∞ –æ–±—â—É—é —à–∏—Ä–∏–Ω—É */
      min-height: 80px;
      max-height: 200px;
      resize: vertical;
      font-size: inherit;
      padding: 0.7rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--accent-color);
      background: var(--input-bg);
      color: var(--text-color);
      font-family: inherit;
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.2);
      margin-bottom: 0.5rem;
      outline: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .message-container:not(.user-container) .message-edit-area {
        margin-left: calc(44px + 0.8rem); /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ */
    }
    .message-container.user-container .message-edit-area {
        margin-left: auto; /* –ê–≤—Ç–æ-–æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        margin-right: calc(44px + 0.8rem); /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    }
    .dark-theme .message-edit-area {
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.5);
    }
    .edit-button-container {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding-left: calc(44px + 0.8rem);
    }
    .message-container.user-container .edit-button-container {
        padding-left: 0;
        padding-right: calc(44px + 0.8rem);
        justify-content: flex-end;
    }


    .input-area-container {
        padding: 0.3rem 0;
        border-top: 1px solid rgba(var(--accent-color-rgb),0.2);
        background: var(--card-bg);
        flex-shrink: 0;
        transition: border-color 0.4s var(--transition-normal), background-color 0.4s var(--transition-normal);
    }
    .dark-theme .input-area-container {
        border-top: 1px solid rgba(var(--accent-color-rgb),0.3);
    }
    /* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–†–û–ó–†–ê–ß–ù–û–ì–û –í–í–û–î–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) --- */
    .input-area-container.has-custom-background-too {
        background-color: rgba(var(--card-bg-rgb), 0.65) !important;
        border-top-color: rgba(var(--accent-color-rgb), 0.2) !important;
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
    }
    .input-area-container.has-custom-background-too #userInput {
        background-color: rgba(var(--input-bg-rgb), 0.7) !important;
        color: var(--text-color);
    }
    .dark-theme .input-area-container.has-custom-background-too #userInput {
        background-color: rgba(var(--input-bg-rgb), 0.7) !important;
    }


    #filePreviewsContainer {
        display: none;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem 0.5rem 0.3rem 0.5rem;
        max-height: 120px;
        overflow-y: auto;
        border-bottom: 1px solid rgba(var(--accent-color-rgb),0.1);
    }
    .file-preview-item {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: var(--input-bg);
        border-radius: calc(var(--border-radius) - 8px);
        padding: 0.3rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        width: 80px;
        height: 80px;
    }
    .file-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: calc(var(--border-radius) - 10px);
    }
    .file-preview-item .file-info {
        font-size: 0.7rem;
        color: var(--text-color);
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        margin-top: 0.2rem;
    }
    .file-preview-item .file-icon-placeholder {
        font-size: 2rem;
        color: var(--accent-color);
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .remove-file-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        z-index: 1;
    }


    .input-row {
      display: flex;
      align-items: flex-end; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –Ω–∏–∂–Ω–µ–º—É –∫—Ä–∞—é */
      gap: 0.5rem;
      position: relative;
      padding: 0 0.5rem;
    }

    .mobile-input-prefix {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 0.4rem;
        flex-shrink: 0;
    }

    #userInput {
      flex-grow: 1;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border-radius: var(--border-radius);
      border: 1px solid transparent;
      background-color: var(--input-bg);
      color: var(--text-color);
      resize: none;
      transition: box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      font-family: inherit;
      min-height: 44px;
      max-height: 150px;
      outline: none;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
      overflow-y: auto;
      line-height: 1.4;
      box-sizing: border-box; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ */
    }
    #userInput:focus {
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
      border-color: var(--accent-color);
      background: #fff;
    }
    .dark-theme #userInput:focus {
      background: var(--sidebar-hover-bg);
    }
    button.send-button, .file-attach-button {
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: filter var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      outline: none;
      white-space: nowrap;
      user-select: none;
      box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-sizing: border-box; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ */
    }
    button.send-button:hover, .file-attach-button:hover {
      filter: brightness(var(--button-hover-brightness));
      box-shadow: 0 4px 15px rgba(var(--accent-color-rgb),0.25);
      transform: translateY(-1px);
    }
    button.send-button:active, .file-attach-button:active {
      transform: scale(var(--button-active-scale)) translateY(0);
      filter: brightness(0.95);
    }
    button.send-button#sendButton {
      padding: 0.8rem 1.5rem; /* –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤—ã—Å–æ—Ç–µ textarea */
      height: 44px; /* –Ø–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
      font-size: 1rem;
      letter-spacing: 0.02em;
    }
    .file-attach-button {
      width: 44px;
      height: 44px;
      font-size: 18px;
    }
    input#fileInput { display: none; }

    .status-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.3rem;
      padding: 0 0.5rem;
      flex-wrap: wrap;
    }
    #messages-status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
      box-shadow: 0 0 8px #ccc;
      transition: background 0.3s var(--transition-normal), box-shadow 0.3s var(--transition-normal);
      flex-shrink: 0;
      margin-bottom: 16px; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
    }
    #messages-status-indicator.active {
      background: #4CAF50;
      box-shadow: 0 0 12px #4CAF50;
      animation: pulseIndicator 1.8s infinite ease-in-out;
    }
    @keyframes pulseIndicator {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }
    .status-container button {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        background: var(--participant-bg);
        color: var(--text-color);
        border: 1px solid var(--accent-color);
    }
    .status-container button:hover {
        background: var(--sidebar-hover-bg);
    }
    .status-container button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    #variantCounter {
        font-weight: 600;
        font-size: 0.9rem;
        user-select: none;
        color: var(--accent-color);
    }

    .memory-box {
      background: var(--input-bg);
      border-radius: calc(var(--border-radius) - 6px);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      color: var(--text-color);
      resize: vertical;
      min-height: 80px;
      max-height: 150px;
      width: 100%;
      font-family: inherit;
      border: 1px solid transparent;
      outline: none;
      transition: box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      font-weight: 500;
      box-sizing: border-box;
    }
    .memory-box:focus {
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
      border-color: var(--accent-color);
      background: #fff;
    }
    .dark-theme .memory-box {
      background: var(--input-bg);
    }
    .dark-theme .memory-box:focus {
      background: var(--sidebar-hover-bg);
    }

    #themeToggle, #toggleSettingsBtn {
      position: fixed;
      background: var(--accent-gradient);
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      cursor: pointer;
      box-shadow: 0 4px 18px rgba(var(--accent-color-rgb),0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s var(--transition-normal), transform 0.2s var(--transition-fast), box-shadow 0.3s var(--transition-normal), filter 0.2s var(--transition-fast);
      z-index: 100;
      outline: none;
    }
    #themeToggle:hover, #toggleSettingsBtn:hover {
      filter: brightness(var(--button-hover-brightness));
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 6px 22px rgba(var(--accent-color-rgb),0.4);
    }
    #themeToggle:active, #toggleSettingsBtn:active {
      transform: scale(var(--button-active-scale));
    }
    #themeToggle { top: 20px; right: 20px; }
    #toggleSettingsBtn { top: 85px; right: 20px; }
    #themeToggle svg { fill: white; width: 24px; height: 24px; transition: transform 0.4s ease-in-out; }
    .dark-theme #themeToggle svg { transform: rotate(180deg); }
    #toggleSettingsBtn span { font-size: 22px; color: white; }

    #lorebookModal .settings-content { max-width: 600px; }
    .lorebook-entry {
      margin-bottom: 1rem;
      padding: 1rem;
      background: rgba(0,0,0,0.03);
      border-radius: calc(var(--border-radius) - 4px);
      border: 1px solid rgba(var(--accent-color-rgb),0.2);
    }
    .dark-theme .lorebook-entry {
        background: rgba(255,255,255,0.04);
        border-color: rgba(var(--accent-color-rgb),0.3);
    }
    .lorebook-entry label { display: block; font-weight: 500; margin-bottom: 0.3rem; font-size: 0.9rem; color: var(--accent-color); }
    .lorebook-entry input, .lorebook-entry textarea {
      width: 100%;
      margin-bottom: 0.5rem;
      box-sizing: border-box;
    }
    .lorebook-entry textarea { min-height: 80px; }

    #backgroundModal .settings-content { max-width: 450px; text-align: center; }
    #backgroundModal input[type="file"] { display: block; margin: 1rem auto; }

    @keyframes slideDownFadeIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUpFadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
        overflow-y: hidden;
        height: var(--app-height);
      }

      .hamburger-btn { display: flex; }
      .mobile-menu-container { display: flex; }

      #sidebarToggleButton { display: none !important; }
      .sidebar { display: none !important; }

      body > #themeToggle, body > #toggleSettingsBtn { display: none !important; }


      .main-content {
          width: 100% !important;
          min-height: 0;
          flex-grow: 1;
          overflow: hidden;
          height: 100%;
      }
      .chat-container {
          padding: 0.8rem 0 0.3rem 0.8rem;
      }
      .chat-container.chat-container-custom-bg {
          padding-left: 0px;
          padding-bottom: 0px;
      }

      .messages {
          padding-left: 0.1rem;
          padding-right: 0.8rem;
      }

      .message-content-wrapper {
          flex-direction: column;
      }
      .message-container .message-content-wrapper {
          align-items: flex-start;
      }
      .message-container.user-container .message-content-wrapper {
          align-items: flex-end;
      }

      .avatar {
          width: 30px;
          height: 30px;
          margin-right: 0;
          margin-left: 0;
          margin-bottom: 0.3rem;
      }
      .message-container.user-container .message-content-wrapper .avatar {
          order: 0;
      }

      .message {
          max-width: 100%;
          padding: 0.5rem 0.8rem;
      }

      .message-buttons {
          padding: 0 0.8rem;
          box-sizing: border-box;
          width: 100%;
          margin-left: 0;
          margin-right: 0;
      }
      .message-container .message-buttons {
          justify-content: flex-start;
      }
      .message-container.user-container .message-buttons {
          justify-content: flex-end;
          padding-right: 0 !important;
      }

      .edit-button-container {
          padding: 0 0.8rem;
          box-sizing: border-box;
          width: 100%;
          margin-left: 0;
          margin-right: 0;
      }
      .message-container .edit-button-container {
          justify-content: flex-start;
      }
      .message-container.user-container .edit-button-container {
          justify-content: flex-end;
          padding-right: 0 !important;
      }

      #groupParticipants { margin-bottom: 1rem; }


      .input-area-container {
        padding: 0.5rem;
      }
      .input-row {
        flex-wrap: nowrap;
        align-items: center; /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤–µ—Ä–Ω–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
        gap: 0.4rem;
        padding: 0;
      }
      .mobile-input-prefix {
        display: flex;
      }

      .input-row > .file-attach-button:not(.mobile-input-prefix .file-attach-button),
      .input-row > #messages-status-indicator:not(.mobile-input-prefix #messages-status-indicator) {
        display: none !important;
      }


      #userInput {
        font-size: 0.95rem;
        padding: 0.7rem 0.9rem;
        min-height: 80px;
      }
      button.send-button#sendButton {
        width: 40px;
        height: 40px;
        padding: 0;
        font-size: 1.2rem;
        line-height: 1;
        border-radius: 50%;
        flex-shrink: 0;
        margin-left: 0.4rem;
      }

      .mobile-input-prefix .file-attach-button {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
        flex-shrink: 0;
      }
      .mobile-input-prefix #messages-status-indicator {
          margin: 0;
          flex-shrink: 0;
          width: 12px;
          height: 12px;
      }
      #messages-status-indicator {
        margin-bottom: 0;
      }

      .settings-content .settings {
        grid-template-columns: 1fr;
      }
      .settings-content .settings > .fieldset-span-1 {
        grid-column: span 1;
      }
      .settings-content .settings .avatar-selection {
        flex-direction: column;
        align-items: stretch;
        grid-column: span 1;
      }
      .settings-content .settings .avatar-selection button {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      .settings-content { padding: 1rem 1.2rem; max-height: 80vh; }


      .message-buttons button { width: 28px; height: 28px; font-size: 14px; }
    }
    @media (min-width: 901px) {
        .hamburger-btn {
            display: none !important;
        }
        #sidebarToggleButton {
            display: flex !important;
        }
        .sidebar {
            display: flex !important;
        }
    }


    @media (max-width: 480px) {
      .avatar {
          width: 28px;
          height: 28px;
          margin-bottom: 0.2rem;
      }
      .message {
          padding: 0.4rem 0.7rem;
      }

      .input-row { gap: 0.2rem; }
      #userInput { min-height: 70px; padding: 0.6rem 0.8rem; font-size: 0.9rem; }
      button.send-button#sendButton,
      .mobile-input-prefix .file-attach-button {
        width: 38px;
        height: 38px;
      }
      .mobile-input-prefix { margin-right: 0.3rem; }


      .memory-box { font-size: 0.9rem; padding: 0.7rem; }
      .settings-content { padding: 1rem; }
      .settings-content legend {font-size: 1rem;}
      .settings-content input, .settings-content textarea, .settings-content select {font-size: 0.9rem; padding: 0.7rem 0.9rem;}
      .settings-content button {font-size: 0.9rem; padding: 0.7rem 1.2rem;}


      .hamburger-btn { top: 10px; left: 10px; width: 40px; height: 40px; }
      .hamburger-btn span { width: 20px; height: 2.5px;}
      .hamburger-btn span::before { transform: translateY(-6px); }
      .hamburger-btn span::after { transform: translateY(6px); }
    }

  </style>

<style>
/* Mobile tab styles - hidden by default (so PC is unaffected) */
.settings-content .tab-buttons { display: none; }
.settings-content .tab-page { display: block; }

@media (max-width: 900px) {
  .settings-content .tab-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    overflow-x: auto;
  }
  .settings-content .tab-buttons button {
    flex: 1;
    padding: 0.6rem;
    font-size: 0.9rem;
    border: 1px solid var(--accent-color);
    border-radius: var(--border-radius);
    background: var(--card-bg);
    color: var(--text-color);
    white-space: nowrap;
  }
  .settings-content .tab-buttons button.active {
    background: var(--accent-gradient);
    color: #fff;
    border-color: transparent;
  }
  .settings-content .tab-page {
    display: none;
    flex-direction: column;
    gap: 1rem;
  }
  .settings-content .tab-page.active {
    display: flex;
  }
  /* Ensure settings grid becomes single column on mobile (for compatibility) */
  .settings-content .settings { display: block; }
}
</style>

<style>
/* Mobile actions panel - hidden on desktop */
.settings-content .mobile-actions { display: none; }

/* buttons look compact on mobile */
.settings-content .mobile-actions .mobile-action-btn {
  padding: 0.6rem 0.8rem;
  border-radius: 10px;
  border: 1px solid rgba(var(--accent-color-rgb),0.12);
  background: var(--input-bg);
  color: var(--text-color);
  font-weight: 600;
  width: 100%;
  box-sizing: border-box;
}

/* two-column small screens */
@media (max-width: 480px) {
  .settings-content .mobile-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
}
@media (min-width: 481px) and (max-width:900px) {
  .settings-content .mobile-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
  .settings-content .mobile-actions .mobile-action-btn { padding: 0.6rem; }
}
/* Keep hidden on desktop explicitly */
@media (min-width: 901px) {
  .settings-content .mobile-actions { display: none !important; }
}
</style>

<style>
@media (min-width: 901px) {
  .settings-content .tab-buttons { display: none !important; }
}
</style>

<style>
@media (max-width: 900px) {
  .settings-content .mobile-actions { 
    display: flex !important; 
  }
  .settings-content .mobile-actions button {
    flex: 1 1 calc(50% - 0.5rem);
    min-width: 120px;
  }
}
@media (max-width: 480px) {
  .settings-content .mobile-actions button {
    flex: 1 1 100%;
  }
}
@media (min-width: 901px) {
  .settings-content .mobile-actions {
    display: none !important;
  }
}
</style>

<style>
/* show mobile color picker only on mobile */
.settings-content .mobile-color-picker { display: none; }
@media (max-width: 900px) {
  .settings-content .mobile-color-picker { display: block !important; }
  .settings-content .mobile-actions { display: grid !important; grid-template-columns: repeat(2, 1fr); gap:0.5rem; }
  .settings-content .mobile-actions .mobile-action-btn { width:100%; }
}
</style>

<style>
/* Animation guard for modal overlays */
#settingsModal, #lorebookModal, #backgroundModal, #greetingSelectModal, #clearChatConfirmModal {
  display: flex !important;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.28s ease, visibility 0.28s ease;
  background: rgba(0,0,0,0); /* keep transparent unless shown */
  padding: 1rem;
  box-sizing: border-box;
}
#settingsModal.modal-show, #lorebookModal.modal-show, #backgroundModal.modal-show, #greetingSelectModal.modal-show, #clearChatConfirmModal.modal-show {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  background: rgba(0,0,0,0.65);
}
/* Ensure inner content still uses existing class .settings-content etc */
</style>
<!-- END IMPORTED MODAL STYLES -->


<!-- AUTO-INJECT: fixes for checkbox layout and appearance -->
<style>
/* Force vertical layout for settings switches and checkbox blocks */
#settingsModal .settings-content div[style*="display: flex; align-items: center"] {
  display: flex !important;
  flex-direction: column !important;
  align-items: flex-start !important;
  gap: 6px !important;
}

/* For any dynamically created wrapper with inline flex row, prefer column */
#settingsModal .settings-content .switch,
#settingsModal .settings-content .switch + label,
#settingsModal .settings-content .switch-wrapper {
  align-self: flex-start;
}

/* Show native checkbox instead of custom slider inside settings modal */
#settingsModal .settings-content .switch input[type="checkbox"] {
  opacity: 1 !important;
  width: 18px !important;
  height: 18px !important;
  position: relative !important;
  margin: 0 !important;
  appearance: checkbox !important;
  -webkit-appearance: checkbox !important;
  accent-color: #ff69b4 !important; /* pink accent */
}

/* Hide the custom slider UI inside settings modal to avoid stripe/bars */
#settingsModal .settings-content .switch .slider {
  display: none !important;
}

/* Label styling: ensure label stands above the checkbox */
#settingsModal .settings-content label[for] {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
}

/* Generic option container fallback */
.settings-content .option-vertical {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-bottom: 10px;
}

/* Make sure on small screens layout stays vertical */
@media (max-width: 900px) {
  #settingsModal .settings-content div[style*="display: flex; align-items: center"] {
    flex-direction: column !important;
  }
}
</style>

</head>
<body>
<!-- Hamburger Menu Button (Mobile) -->
<button aria-controls="mobileMenuContainer" aria-expanded="false" aria-label="–ú–µ–Ω—é" class="hamburger-btn" id="hamburgerBtn">
<span></span>
</button>
<!-- Sidebar Toggle Button (PC) -->
<button aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å" id="sidebarToggleButton" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–∞–Ω–µ–ª—å">&lt;&lt;</button>
<!-- Mobile Menu Flyout -->
<div aria-hidden="true" class="mobile-menu-container" id="mobileMenuContainer">
<div class="mobile-menu-header">
<span class="mobile-menu-title">–ú–µ–Ω—é</span>
</div>
<div id="mobileMenuItemsPlaceholder">
<!-- Content will be injected by JS -->
</div>
</div>
<!-- Floating Action Buttons (Theme, Settings) -->
<button aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" id="themeToggle" tabindex="0" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
<svg aria-hidden="true" focusable="false" id="themeIcon" viewbox="0 0 24 24">
<path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z"></path> </svg>
</button>
<button aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" id="toggleSettingsBtn" tabindex="0" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
<span>‚öôÔ∏è</span>
</button>
<!-- Main Sidebar (PC) -->
<aside aria-label="–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤" class="sidebar" id="sidebar" role="navigation">
<div class="sidebar-header">üí¨ –ß–∞—Ç—ã —Å –±–æ—Ç–∞–º–∏</div>
<div class="chat-list" id="chatList" role="list">
<!-- Character list items will be injected by JS -->
</div>
</aside>
<!-- Main Content Area -->
<main class="main-content" id="mainContent">
<div aria-label="–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞" id="groupParticipants" role="list">
<!-- Group participants will be injected by JS -->
</div>
<div class="chat-container" id="chatContainer">
<div aria-live="polite" aria-relevant="additions" class="messages" id="messages">
<!-- Messages will be injected by JS -->
</div>
<div class="input-area-container">
<div id="filePreviewsContainer">
<!-- File previews will be injected by JS -->
</div>
<div class="input-row" id="mainInputRow">
<div class="mobile-input-prefix">
<!-- Mobile-specific buttons injected by JS -->
</div>
<div aria-label="–°—Ç–∞—Ç—É—Å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" id="messages-status-indicator" title="–°—Ç–∞—Ç—É—Å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"></div>
<textarea aria-label="–ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è" id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" spellcheck="true"></textarea>
<button aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" class="send-button" id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
<div class="status-container" style="justify-content: flex-end; padding-right: 5px;">
<div style="display:flex; align-items:center; gap:10px;">
<button aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç" class="send-button" id="prevVariantBtn" onclick="prevVariant()" style="display:none;">‚Üê –ü—Ä–µ–¥.</button>
<span id="variantCounter" style="font-weight:700; user-select:none; display:none;"></span>
<button aria-label="–°–ª–µ–¥—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç" class="send-button" id="nextVariantBtn" onclick="nextVariant()" style="display:none;">–°–ª–µ–¥. ‚Üí</button>
<button aria-label="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç" class="send-button" id="applyVariantBtn" onclick="applyVariant()" style="display:none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>
</div>
</div>
</div>
</main>
<!-- Settings Modal -->
<div id="settingsModal">
<div class="settings-content">
<button aria-label="–ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" class="close-btn" onclick="closeSettingsModal()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
<h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
<fieldset style="margin-top:1rem; margin-bottom:1.5rem;"> <legend>–†–µ–∂–∏–º —á–∞—Ç–∞</legend>
<div aria-label="–†–µ–∂–∏–º—ã —á–∞—Ç–∞" class="toggle-mode" role="tablist">
<button aria-controls="settingsSection" aria-selected="true" class="selected" id="personalModeBtn" role="tab" tabindex="0">üë§ –õ–∏—á–Ω—ã–π —á–∞—Ç</button>
<button aria-controls="groupParticipants" aria-selected="false" id="groupModeBtn" role="tab" tabindex="0">üë• –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</button>
</div>
</fieldset>
<section aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" class="settings" id="settingsSection"><div class="tab-buttons"><button class="active" onclick="openSettingsTab(1)" type="button">üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</button><button onclick="openSettingsTab(2)" type="button">üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</button><button onclick="openSettingsTab(3)" type="button">üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</button><button onclick="openSettingsTab(4)" type="button">üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</button><button onclick="openSettingsTab(5)" type="button">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</button><button onclick="openSettingsTab(6)" type="button">üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</button><button onclick="openSettingsTab(7)" type="button">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</button><button onclick="openSettingsTab(8)" type="button">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</button><button onclick="openSettingsTab(9)" type="button">üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</button><button onclick="openSettingsTab(10)" type="button">üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</button><button onclick="openSettingsTab(11)" type="button">üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</button></div><div class="tab-page active" id="settingsTab1"><fieldset class="fieldset-span-1"> <legend>üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</legend>
<label for="apiKey">–ö–ª—é—á API (LLM):</label>
<input aria-label="–ö–ª—é—á API LLM" autocomplete="off" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á" type="password"/>
<label for="apiUrl">URL API LLM:</label>
<input aria-label="URL LLM API" id="apiUrl" type="text" value="https://openrouter.ai/api/v1/chat/completions"/>
<label for="model">–ú–æ–¥–µ–ª—å LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):</label>
<input aria-label="–ú–æ–¥–µ–ª—å LLM" id="model" readonly="" type="text" value="deepseek/deepseek-r1-0528:free"/>
<label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0-1):</label>
<input aria-label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ LLM" id="temperature" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 0.7" step="0.1" type="number" value="0.7"/>
<label for="maxTokens">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤:</label>
<input aria-label="–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ LLM" id="maxTokens" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1024" type="number" value="1024"/>
</fieldset></div><div class="tab-page" id="settingsTab2"><fieldset class="fieldset-span-1">
<legend>üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</legend>
<label for="googleApiKey">–ö–ª—é—á Google API:</label>
<input aria-label="–ö–ª—é—á Google API" autocomplete="off" id="googleApiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Google API –∫–ª—é—á" type="password"/>
<label for="googleApiModel">–ú–æ–¥–µ–ª—å Google Gemini:</label>
<select aria-label="–ú–æ–¥–µ–ª—å Google Gemini" id="googleApiModel"></select>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableGoogleApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Gemini API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å Google Gemini API" id="enableGoogleApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset></div><div class="tab-page" id="settingsTab3"><fieldset>
<legend>üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</legend>
<label for="restApiUrl">URL REST API:</label>
<input aria-label="URL REST API" id="restApiUrl" placeholder="URL –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ REST API" type="text"/>
<label for="restApiHeaders">–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON):</label>
<textarea aria-label="–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON)" id="restApiHeaders" placeholder='–ü—Ä–∏–º–µ—Ä: {"Authorization": "Bearer –í–ê–®_–¢–û–ö–ï–ù"}'></textarea>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableRestApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REST API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å REST API" id="enableRestApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset></div><div class="tab-page" id="settingsTab4"><fieldset>
<legend>üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</legend>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
<div>
<label for="characterSelect">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<select aria-label="–í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" disabled="" id="characterSelect"></select>
</div>
<div>
<label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<input aria-label="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
</div>
<label for="characterModel">–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è):</label>
<input aria-label="–ú–æ–¥–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, gpt-4-turbo –∏–ª–∏ –º–æ–¥–µ–ª—å Gemini" type="text"/>
</fieldset></div><div class="tab-page" id="settingsTab5"><fieldset>
<legend>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</legend>
<label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–≤–Ω–µ—à–Ω–æ—Å—Ç—å, —Ä–æ–ª—å, —Ü–µ–ª–∏):</label>
<textarea aria-label="–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏..." style="min-height: 140px;"></textarea>
<label for="personality">–õ–∏—á–Ω–æ—Å—Ç—å (—á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞):</label>
<textarea aria-label="–õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="personality" placeholder="–õ–∏—á–Ω–æ—Å—Ç—å, –º–∞–Ω–µ—Ä–∞ —Ä–µ—á–∏, –ø–æ–≤–µ–¥–µ–Ω–∏–µ..."></textarea>
</fieldset></div><div class="tab-page" id="settingsTab6"><fieldset>
<legend>üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</legend>
<label for="scenario">–°—Ü–µ–Ω–∞—Ä–∏–π (–º–∏—Ä, –æ–∫—Ä—É–∂–µ–Ω–∏–µ):</label>
<textarea aria-label="–°—Ü–µ–Ω–∞—Ä–∏–π" id="scenario" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞, —Å–∏—Ç—É–∞—Ü–∏–∏, —Å–µ—Ç—Ç–∏–Ω–≥–∞..."></textarea>
<label for="mes_example">–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:</label>
<textarea aria-label="–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞" id="mes_example" placeholder="&lt;START&gt;\n–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∏–ª—è..." style="min-height: 140px;"></textarea>
</fieldset></div><div class="tab-page" id="settingsTab7"><fieldset>
<legend>üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</legend>
<label for="welcomeMessage">–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:</label>
<textarea aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" id="welcomeMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —á–∞—Ç–∞"></textarea>
<!-- REMOVED: Alternative Greetings Input Field -->
</fieldset></div><div class="tab-page" id="settingsTab8"><fieldset>
<legend>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</legend>
<label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
<textarea aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç" id="system_prompt" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò (system prompt)"></textarea>
<label for="post_history_instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏:</label>
<textarea aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏" id="post_history_instructions" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"></textarea>
<label for="creator_notes">–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:</label>
<textarea aria-label="–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è" id="creator_notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"></textarea>
</fieldset></div><div class="tab-page" id="settingsTab9"><fieldset class="fieldset-span-1">
<legend>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</legend>
<div>
<label for="mainTextColor">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
<input aria-label="–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞" id="mainTextColor" onchange="applyTextColor(this.value); localStorage.setItem(TEXT_COLOR_STORAGE, this.value);" type="color"/>
</div>
<div style="margin-top: 1rem;">
<label for="chatFontSize">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ: <span id="chatFontSizeIndicator">100%</span></label>
<input aria-label="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ" id="chatFontSize" max="1.5" min="0.8" step="0.05" type="range" value="1"/>
</div>
</fieldset></div><div class="tab-page" id="settingsTab10"><fieldset class="fieldset-span-1">
<legend>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</legend>
<div class="avatar-selection">
<button onclick="showAvatarOptions('link', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_character" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarUrl_character" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_character" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarFileInput_character" type="file"/>
</div>
<div class="avatar-selection" style="margin-top: 1rem;">
<button onclick="showAvatarOptions('link', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_user" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∞–≤–∞—Ç–∞—Ä" id="avatarUrl_user" placeholder="URL –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_user" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" id="avatarFileInput_user" type="file"/>
</div>
</fieldset></div><div class="tab-page" id="settingsTab11"><fieldset>
<legend>üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</legend>
<textarea aria-label="–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" class="memory-box" id="neuralMemory" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ..." spellcheck="true"></textarea>
</fieldset></div><div class="settings-bottom-actions" style="margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;"><button onclick="importCharacterData()" type="button">üì• –ò–º–ø–æ—Ä—Ç JSON</button><button onclick="exportCharacterData()" type="button">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button><button onclick="openBackgroundModal()" type="button">üñºÔ∏è –§–æ–Ω —á–∞—Ç–∞</button><button onclick="openLorebookModal()" type="button">üìö Lorebook</button><button onclick="saveSettings()" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button onclick="clearChat()" type="button">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button></div></section>
<div class="settings-bottom-actions mobile-actions" style="display:none; margin-top: 1rem; flex-wrap: wrap; gap: 0.5rem; justify-content:center;"><button class="mobile-action-btn" onclick="saveSettings()" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å</button><button class="mobile-action-btn" onclick="exportCharacterData()" type="button">üì§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button><button class="mobile-action-btn" onclick="document.getElementById('jsonFileInput') &amp;&amp; document.getElementById('jsonFileInput').click()" type="button">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button><button class="mobile-action-btn" onclick="openClearChatConfirm()" type="button">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button><button class="mobile-action-btn" onclick="openBackgroundModal()" type="button">üñºÔ∏è –§–æ–Ω</button><button class="mobile-action-btn" onclick="openLorebookModal()" type="button">üìö Lorebook</button></div></div>
</div>
<!-- Lorebook Modal -->
<div id="lorebookModal">
<div class="settings-content"> <button aria-label="–ó–∞–∫—Ä—ã—Ç—å Lorebook" class="close-btn" onclick="closeLorebookModal()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
<h2>üìö Lorebook –¥–ª—è "<span id="lorebookCharacterName"></span>"</h2>
<p style="font-size: 0.9rem; color: var(--text-color); opacity: 0.8; margin-bottom: 1rem;">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º, –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ (—Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏) –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –∫–æ—Ç–æ—Ä—É—é –±–æ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –≤—Å—Ç—Ä–µ—Ç–∏—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
<div id="lorebookEntries" style="margin-bottom: 1rem;">
<!-- Lorebook entries injected by JS -->
</div>
<button onclick="addLorebookEntry()" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
</div>
</div>
<!-- Background Modal -->
<div id="backgroundModal">
<div class="settings-content"> <button aria-label="–ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–∞" class="close-btn" onclick="closeBackgroundModal()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
<h2>üñºÔ∏è –§–æ–Ω –¥–ª—è "<span id="backgroundCharacterName"></span>"</h2>
<p style="font-size: 0.9rem; color: var(--text-color); opacity: 0.8; margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–æ–Ω–∞ –æ–±–ª–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.</p>
<input accept="image/*" aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª —Ñ–æ–Ω–∞" id="backgroundFileInput" type="file"/>
<div style="margin-top: 1rem;">
<button onclick="uploadBackground()" type="button">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
<button onclick="deleteBackground()" style="background: #ffcdd2; color:#5f2120;" type="button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω</button>
</div>
</div>
</div>
<!-- Greeting Selection Modal -->
<div id="greetingSelectModal">
<div class="greeting-select-content"> <button aria-label="–ó–∞–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è" class="close-btn" onclick="closeGreetingModal()" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
<h2>üëã –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è <span id="greetingCharacterName"></span></h2>
<div class="greeting-options" id="greetingOptions">
<!-- Greeting options injected by JS -->
</div>
<button onclick="confirmGreetingSelection()" type="button">–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</button>
</div>
</div>
<input accept="image/*,application/*,text/*,*/*" id="fileInput" multiple="" style="display:none;" type="file"/>
<script>
    // --- Global Variables and Constants ---
    if (typeof window.currentMode === 'undefined') window.currentMode = "personal";
    let characters = {};
    let activeCharacter = null;
    let attachedFiles = [];
    let regenerateVariants = [];
    let currentVariantIndex = -1;
    let isBotGenerating = false;
    let shouldScrollToBottom = true;
    let tempImportedCharacterData = null;

    const ROOM_HISTORY_KEY = "roomHistory_v3";
    const MEMORY_KEY = "neuralMemory_v3";
    const API_KEY_STORAGE = "userApiKey_v3";
    const API_URL_STORAGE = "apiUrl_v3";
    const THEME_STORAGE = "themePreference_v3";
    const TEXT_COLOR_STORAGE = "mainTextColor_v3";
    const CHAT_FONT_SIZE_STORAGE = "chatFontSize_v1";
    const SIDEBAR_STATE_STORAGE = "sidebarState_v1";
    const REST_API_URL_STORAGE = "restApiUrl_v2";
    const REST_API_HEADERS_STORAGE = "restApiHeaders_v2";
    const ENABLE_REST_API_STORAGE = "enableRestApi_v2";
    const GOOGLE_API_KEY_STORAGE = "googleApiKey_v1";
    const GOOGLE_API_MODEL_STORAGE = "googleApiModel_v1";
    const ENABLE_GOOGLE_API_STORAGE = "enableGoogleApi_v1";
    const AVAILABLE_GOOGLE_MODELS = [ { id: "gemini-2.0-flash", name: "Gemini 2.0 Flash" }, { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro" }, { id: "gemini-2.5-flash", name: "Gemini 2.5 Flash" }, { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash-Lite" } ];

    let useRestApi = false;
    let restApiUrlValue = "";
    let restApiHeadersValue = {};
    let useGoogleApi = false;
    let googleApiKey = "";
    let googleApiModel = "";

    // --- DOM Elements Cache ---
    const prevVariantBtn = document.getElementById("prevVariantBtn");
    const nextVariantBtn = document.getElementById("nextVariantBtn");
    const applyVariantBtn = document.getElementById("applyVariantBtn");
    const variantCounter = document.getElementById("variantCounter");
    let globalToggleSettingsBtn;
    let globalThemeToggleBtn;
    const sendButton = document.getElementById("sendButton");
    const personalModeBtn = document.getElementById("personalModeBtn");
    const groupModeBtn = document.getElementById("groupModeBtn");
    const messagesBox = document.getElementById("messages");
    const userInput = document.getElementById("userInput");
    const chatFontSizeSlider = document.getElementById("chatFontSize");
    const chatFontSizeIndicator = document.getElementById("chatFontSizeIndicator");
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenuContainer = document.getElementById('mobileMenuContainer');
    const mobileMenuItemsPlaceholder = document.getElementById('mobileMenuItemsPlaceholder');
    const mainInputRow = document.getElementById('mainInputRow');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleButton = document.getElementById('sidebarToggleButton');
    const filePreviewsContainer = document.getElementById('filePreviewsContainer');

    // --- Utility Functions ---

    /**
     * [FIXED] Adds the copy to clipboard functionality.
     * @param {string} text - The text to copy.
     */
    function copyMessageToClipboard(text) {
      if (!text) return;
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      // Prevent screen from scrolling to the element
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";

      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCustomAlert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        } else {
            showCustomAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        showCustomAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞.');
      }

      document.body.removeChild(textArea);
    }

    function setAppHeight() {
      const doc = document.documentElement;
      doc.style.setProperty('--app-height', `${window.innerHeight}px`);
    }

    function setAccentRgb() {
        const rootStyle = getComputedStyle(document.documentElement);
        const accentColor = rootStyle.getPropertyValue('--accent-color').trim();
        if (accentColor.startsWith('#')) {
            const hex = accentColor.substring(1);
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            document.documentElement.style.setProperty('--accent-color-rgb', `${r},${g},${b}`);
        } else if (accentColor.startsWith('rgb')) {
             const match = accentColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
            if (match) {
                document.documentElement.style.setProperty('--accent-color-rgb', `${match[1]},${match[2]},${match[3]}`);
            }
        }
    }

    function isMobileView() {
        return window.innerWidth <= 900;
    }

    // --- Mobile Menu & View Handling ---

    
function setupMobileHamburgerMenu() {{
        const placeholder = mobileMenuItemsPlaceholder;
        if (!placeholder) return;

        // Preserve existing buttons (if present) BEFORE we clear the placeholder.
        let themeBtn = document.getElementById('themeToggle');
        let settingsBtn = document.getElementById('toggleSettingsBtn');

        // Templates to recreate buttons if they get removed elsewhere.
        const themeTemplate = `<button aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" id="themeToggle" tabindex="0" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
<svg aria-hidden="true" focusable="false" id="themeIcon" viewbox="0 0 24 24">
<path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z"></path> </svg>
</button>`;
        const settingsTemplate = `<button aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" id="toggleSettingsBtn" tabindex="0" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
<span>‚öôÔ∏è</span>
</button>`;

        // Clear placeholder (we have references or templates if needed).
        placeholder.innerHTML = '';

        const originalSidebarHeader = document.querySelector('.sidebar .sidebar-header');
        if (originalSidebarHeader) placeholder.appendChild(originalSidebarHeader.cloneNode(true));

        const mobileChatListDiv = document.createElement('div');
        mobileChatListDiv.id = 'mobileMenuChatListInternal';
        mobileChatListDiv.className = 'chat-list';
        placeholder.appendChild(mobileChatListDiv);
        renderChatList(mobileChatListDiv);

        // If original elements existed, move them into the placeholder.
        if (themeBtn && themeBtn.parentElement !== placeholder) {{
            placeholder.appendChild(themeBtn);
        }} else if (!themeBtn) {{
            // Recreate from template (no event listeners are preserved ‚Äî we rebind globals below).
            const tmp = document.createElement('div');
            tmp.innerHTML = themeTemplate;
            const newBtn = tmp.firstElementChild;
            if (newBtn) placeholder.appendChild(newBtn);
        }}

        if (settingsBtn && settingsBtn.parentElement !== placeholder) {{
            placeholder.appendChild(settingsBtn);
        }} else if (!settingsBtn) {{
            const tmp2 = document.createElement('div');
            tmp2.innerHTML = settingsTemplate;
            const newBtn2 = tmp2.firstElementChild;
            if (newBtn2) placeholder.appendChild(newBtn2);
        }}

        // Re-resolve globals so other code that attaches handlers can find these elements.
        globalThemeToggleBtn = document.getElementById('themeToggle');
        globalToggleSettingsBtn = document.getElementById('toggleSettingsBtn');

        // If there are initialization functions that attach listeners, call them here.
        if (typeof attachThemeToggleHandlers === 'function') {{
            attachThemeToggleHandlers(globalThemeToggleBtn);
        }}
        if (typeof attachSettingsHandlers === 'function') {{
            attachSettingsHandlers(globalToggleSettingsBtn);
        }}
    }}


    function restoreDesktopElements() {
        const themeToggleInHamburger = mobileMenuItemsPlaceholder.querySelector('#themeToggle');
        if (themeToggleInHamburger) {
            document.body.appendChild(themeToggleInHamburger);
        }
        const settingsToggleInHamburger = mobileMenuItemsPlaceholder.querySelector('#toggleSettingsBtn');
        if (settingsToggleInHamburger) {
            document.body.appendChild(settingsToggleInHamburger);
        }
    }


    function handleViewChange() {
        setAppHeight();
        const mainContentEl = document.getElementById('mainContent');
        const visibleFileAttachBtn = mainInputRow.querySelector('.file-attach-button');
        const originalStatusIndicator = document.getElementById('messages-status-indicator');
        const pcSidebarToggle = document.getElementById('sidebarToggleButton');

        if (isMobileView()) {
            setupMobileHamburgerMenu();
            sendButton.innerHTML = '‚Üí';
            sendButton.setAttribute('aria-label', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å');

            let mobilePrefixDiv = mainInputRow.querySelector('.mobile-input-prefix');
            if (!mobilePrefixDiv) {
                mobilePrefixDiv = document.createElement('div');
                mobilePrefixDiv.className = 'mobile-input-prefix';
                mainInputRow.insertBefore(mobilePrefixDiv, userInput);
            }
            mobilePrefixDiv.style.display = 'flex';


            let mobileFileAttachBtn = mobilePrefixDiv.querySelector('.file-attach-button');
            if (!mobileFileAttachBtn && visibleFileAttachBtn) {
                mobileFileAttachBtn = visibleFileAttachBtn.cloneNode(true);
                mobileFileAttachBtn.onclick = () => document.getElementById('fileInput').click();
                mobilePrefixDiv.appendChild(mobileFileAttachBtn);
            } else if (mobileFileAttachBtn) {
                 mobileFileAttachBtn.style.display = 'flex';
            }
             if (visibleFileAttachBtn && visibleFileAttachBtn.parentElement === mainInputRow) {
                visibleFileAttachBtn.style.display = 'none';
            }


            let mobileStatusIndicator = mobilePrefixDiv.querySelector('#messages-status-indicator');
            if (!mobileStatusIndicator && originalStatusIndicator) {
                mobileStatusIndicator = originalStatusIndicator.cloneNode(true);
                mobilePrefixDiv.appendChild(mobileStatusIndicator);
            } else if (mobileStatusIndicator) {
                 mobileStatusIndicator.style.display = 'block';
            }
            if (originalStatusIndicator && originalStatusIndicator.parentElement === mainInputRow) {
                 originalStatusIndicator.style.display = 'none';
            }

            if(sidebar) sidebar.style.display = 'none';
            if(pcSidebarToggle) pcSidebarToggle.style.display = 'none';

        } else {
            restoreDesktopElements();
            sendButton.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';

            const mobilePrefixDiv = mainInputRow.querySelector('.mobile-input-prefix');
            if (mobilePrefixDiv) mobilePrefixDiv.style.display = 'none';


            if (visibleFileAttachBtn && visibleFileAttachBtn.parentElement === mainInputRow) {
                 visibleFileAttachBtn.style.display = 'flex';
            }
            if (originalStatusIndicator && originalStatusIndicator.parentElement === mainInputRow) {
                originalStatusIndicator.style.display = 'block';
            }

            if (sidebar) sidebar.style.display = 'flex';
            if(pcSidebarToggle) pcSidebarToggle.style.display = 'flex';
            loadSidebarState();
        }
    }


    // --- Initialization ---
    window.onload = () => {
      setAccentRgb();
      loadSettings();
      loadNeuralMemory();
      loadTheme();
      loadTextColor();
      loadChatTextSize();
      populateGoogleApiModelSelect();

      const statusIndicator = document.getElementById('messages-status-indicator');
      const userInputEl = document.getElementById('userInput');

      let desktopFileAttachButton = mainInputRow.querySelector('.file-attach-button:not(.mobile-input-prefix .file-attach-button)');
      if (!desktopFileAttachButton) {
          desktopFileAttachButton = document.createElement('button');
          desktopFileAttachButton.className = 'file-attach-button';
          desktopFileAttachButton.setAttribute('aria-label', '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          desktopFileAttachButton.title = '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
          desktopFileAttachButton.innerHTML = 'üìé'; // Changed from '?' to 'üìé'
          desktopFileAttachButton.type = 'button';
          desktopFileAttachButton.onclick = () => document.getElementById('fileInput').click();

          if (statusIndicator && statusIndicator.parentElement === mainInputRow) {
            mainInputRow.insertBefore(desktopFileAttachButton, statusIndicator);
          } else if (userInputEl) {
            mainInputRow.insertBefore(desktopFileAttachButton, userInputEl);
          } else {
            mainInputRow.insertBefore(desktopFileAttachButton, mainInputRow.firstChild);
          }
      } else {
         desktopFileAttachButton.innerHTML = 'üìé'; // Changed from '?' to 'üìé'
      }


      renderMode();
      renderChatList();
      renderGroupParticipants();
      setupEventListeners();
      updateVariantControls();
      handleViewChange();
      renderFilePreviews();

      if (activeCharacter) {
        setActiveCharacter(activeCharacter);
      } else {
        displayInitialHelperMessage();
      }
      userInput.style.height = 'auto';
      userInput.style.height = (userInput.scrollHeight) + 'px';
      setAppHeight();
    };


    function displayInitialHelperMessage() {
        if (Object.keys(characters).length === 0 && messagesBox.children.length === 0) {
             const helperP = document.createElement('p');
             helperP.style.textAlign = 'center';
             helperP.style.color = 'var(--text-color)';
             helperP.style.padding = '20px';
             helperP.style.fontStyle = 'italic';
             helperP.style.opacity = '0.7';
             helperP.innerHTML = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã<br>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è), —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç.';
             messagesBox.appendChild(helperP);
        }
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
      if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', () => {
            mobileMenuContainer.classList.toggle('open');
            hamburgerBtn.classList.toggle('open');
            hamburgerBtn.setAttribute('aria-expanded', mobileMenuContainer.classList.contains('open'));
            mobileMenuContainer.setAttribute('aria-hidden', !mobileMenuContainer.classList.contains('open'));
        });
      }
      document.addEventListener('click', (event) => {
        if (mobileMenuContainer && mobileMenuContainer.classList.contains('open') &&
            !mobileMenuContainer.contains(event.target) &&
            hamburgerBtn && !hamburgerBtn.contains(event.target)) {
            mobileMenuContainer.classList.remove('open');
            if (hamburgerBtn) {
                hamburgerBtn.classList.remove('open');
                hamburgerBtn.setAttribute('aria-expanded', 'false');
            }
            mobileMenuContainer.setAttribute('aria-hidden', 'true');
        }
      });

      document.body.addEventListener('click', function(event) {
        const target = event.target.closest('#themeToggle');
        if (target) {
            document.body.classList.toggle("dark-theme");
            const isDark = document.body.classList.contains("dark-theme");
            setTheme(isDark);
            setAccentRgb();
            const savedUserColor = localStorage.getItem(TEXT_COLOR_STORAGE);
            if (savedUserColor) {
                applyTextColor(savedUserColor);
            } else {
                const themeTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                applyTextColor(themeTextColor);
            }
        }
      });
      document.body.addEventListener('click', function(event) {
        if (event.target.closest('#toggleSettingsBtn')) {
            openSettingsModal();
        }
      });


      document.getElementById("settingsModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("settingsModal")) closeSettingsModal();
      });
       document.getElementById("lorebookModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("lorebookModal")) closeLorebookModal();
      });
       document.getElementById("backgroundModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("backgroundModal")) closeBackgroundModal();
      });
      document.getElementById("greetingSelectModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("greetingSelectModal")) closeGreetingModal();
      });

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeSettingsModal();
          closeLorebookModal();
          closeBackgroundModal();
          closeGreetingModal();
          const avatarModal = document.querySelector('.avatar-preview-modal');
          if (avatarModal) document.body.removeChild(avatarModal);
          if (mobileMenuContainer && mobileMenuContainer.classList.contains('open')) {
            mobileMenuContainer.classList.remove('open');
            if (hamburgerBtn) {
                 hamburgerBtn.classList.remove('open');
                 hamburgerBtn.setAttribute('aria-expanded', 'false');
            }
            mobileMenuContainer.setAttribute('aria-hidden', 'true');
          }
        }
      });
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
      document.getElementById('chatContainer').addEventListener('click', (e) => {
        const inputContainer = document.querySelector('.input-area-container');
        // Check if the clicked element or any of its parents is the userInput or a child of inputContainer
        if (inputContainer && !inputContainer.contains(e.target)) {
            userInput.blur(); // Blur the input if click is outside
        }
      });

      sendButton.addEventListener("click", sendMessage);
      userInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });
      userInput.addEventListener('input', () => {
          userInput.style.height = 'auto';
          userInput.style.height = (userInput.scrollHeight) + 'px';
      });

      personalModeBtn.addEventListener('click', () => switchMode("personal"));
      groupModeBtn.addEventListener('click', () => switchMode("group"));


      document.getElementById("apiKey").addEventListener("input", () => saveToStorage(API_KEY_STORAGE, document.getElementById("apiKey").value.trim()));
      document.getElementById("apiUrl").addEventListener("input", () => saveToStorage(API_URL_STORAGE, document.getElementById("apiUrl").value.trim()));

      document.getElementById("googleApiKey").addEventListener("input", () => {
          googleApiKey = document.getElementById("googleApiKey").value.trim();
          saveToStorage(GOOGLE_API_KEY_STORAGE, googleApiKey);
      });
      document.getElementById("googleApiModel").addEventListener("change", () => {
          googleApiModel = document.getElementById("googleApiModel").value;
          saveToStorage(GOOGLE_API_MODEL_STORAGE, googleApiModel);
      });
      document.getElementById("enableGoogleApi").addEventListener("change", (event) => {
          useGoogleApi = event.target.checked;
          saveToStorage(ENABLE_GOOGLE_API_STORAGE, useGoogleApi.toString());
      });


      document.getElementById("neuralMemory").addEventListener("input", () => saveToStorage(MEMORY_KEY, document.getElementById("neuralMemory").value));
      document.getElementById("mainTextColor").addEventListener("input", (e) => {
          applyTextColor(e.target.value);
          saveToStorage(TEXT_COLOR_STORAGE, e.target.value);
      });
      chatFontSizeSlider.addEventListener("input", (e) => {
          applyChatTextSize(e.target.value);
          saveToStorage(CHAT_FONT_SIZE_STORAGE, e.target.value);
          chatFontSizeIndicator.textContent = `${Math.round(e.target.value * 100)}%`;
      });

      if (sidebarToggleButton) {
        sidebarToggleButton.addEventListener('click', toggleSidebar);
      }

      setupRestApiSwitch();
      setupFileAttach();
      setupScrollHandler();
      setupAvatarClickHandler();
      window.addEventListener('resize', handleViewChange);
    }

    // --- Sidebar Toggle (PC) ---
    function toggleSidebar() {
        if (!sidebar) return;
        sidebar.classList.toggle('collapsed');
        const isCollapsed = sidebar.classList.contains('collapsed');
        if (sidebarToggleButton) {
            sidebarToggleButton.innerHTML = isCollapsed ? '&gt;&gt;' : '&lt;&lt;';
            sidebarToggleButton.setAttribute('aria-label', isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å' : '–°–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å');
        }
        localStorage.setItem(SIDEBAR_STATE_STORAGE, isCollapsed ? 'collapsed' : 'expanded');
        applyBackground(getCurrentCharacterName());
    }

    function loadSidebarState() {
        if (isMobileView() || !sidebar) {
             if(sidebar) sidebar.classList.add('collapsed');
             return;
        }
        const state = localStorage.getItem(SIDEBAR_STATE_STORAGE);
        const isCollapsed = state === 'collapsed';
        sidebar.classList.toggle('collapsed', isCollapsed);
        if (sidebarToggleButton) {
            sidebarToggleButton.innerHTML = isCollapsed ? '&gt;&gt;' : '&lt;&lt;';
            sidebarToggleButton.setAttribute('aria-label', isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å' : '–°–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å');
        }
    }


    // --- Theme and Color Management ---
    function setTheme(isDark) {
      localStorage.setItem(THEME_STORAGE, isDark ? "dark" : "light");
      const themeIconPath = isDark ?
        '<path d="M12 3.6A8.4 8.4 0 003.6 12 8.4 8.4 0 0012 20.4a8.4 8.4 0 008.4-8.4A8.4 8.4 0 0012 3.6zm0 14.4a6 6 0 110-12 6 6 0 010 12zM12 7a1 1 0 00-1 1v3H8a1 1 0 000 2h3v3a1 1 0 002 0v-3h3a1 1 0 000-2h-3V8a1 1 0 00-1-1z"/>'
        : '<path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z"/>';
      const themeIconEl = document.getElementById("themeIcon");
      if (themeIconEl) themeIconEl.innerHTML = themeIconPath;
    }
    function loadTheme() {
      const savedTheme = localStorage.getItem(THEME_STORAGE);
      const isDark = savedTheme === "dark";
      document.body.classList.toggle("dark-theme", isDark);
      setTheme(isDark);
      setAccentRgb();
    }
    function applyTextColor(color) {
        document.documentElement.style.setProperty('--text-color', color);
        document.documentElement.style.setProperty('--bold-text-color', color);
    }
    function loadTextColor() {
        const savedColor = localStorage.getItem(TEXT_COLOR_STORAGE);
        const colorPicker = document.getElementById("mainTextColor");
        if (savedColor) {
            applyTextColor(savedColor);
            if(colorPicker) colorPicker.value = savedColor;
        } else {
            const defaultThemeColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            applyTextColor(defaultThemeColor);
            if(colorPicker) colorPicker.value = defaultThemeColor;
        }
    }

    // --- Chat Font Size ---
    function applyChatTextSize(sizeMultiplier) {
        document.documentElement.style.setProperty('--chat-font-size-multiplier', sizeMultiplier);
        if (chatFontSizeIndicator) chatFontSizeIndicator.textContent = `${Math.round(sizeMultiplier * 100)}%`;
    }

    function loadChatTextSize() {
        const savedSize = localStorage.getItem(CHAT_FONT_SIZE_STORAGE);
        const defaultSize = 1;
        const sizeToApply = savedSize ? parseFloat(savedSize) : defaultSize;
        applyChatTextSize(sizeToApply);
        if (chatFontSizeSlider) chatFontSizeSlider.value = sizeToApply;
    }


    // --- Modal Handling ---
    function openSettingsModal() {
        const modal = document.getElementById("settingsModal");
        modal.style.display = "flex";
        if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            modal.classList.add('above-hamburger');
        }
        document.getElementById("personalModeBtn").classList.toggle("selected", currentMode === "personal");
        document.getElementById("personalModeBtn").setAttribute("aria-selected", currentMode === "personal");
        document.getElementById("groupModeBtn").classList.toggle("selected", currentMode === "group");
        document.getElementById("groupModeBtn").setAttribute("aria-selected", currentMode === "group");
    }
    function closeSettingsModal() {
        const modal = document.getElementById("settingsModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
    }
    function openLorebookModal() {
      const name = getCurrentCharacterName();
      if (!name || !characters[name]) return showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
      document.getElementById("lorebookCharacterName").textContent = name;
      renderLorebookEntries(name);
      const modal = document.getElementById("lorebookModal");
      modal.style.display = "flex";
      const settingsModal = document.getElementById("settingsModal");
      if (settingsModal.style.display === "flex") {
          const settingsZIndex = parseInt(window.getComputedStyle(settingsModal).zIndex, 10) || 1000;
          modal.style.zIndex = settingsZIndex + 10;
      } else if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            modal.classList.add('above-hamburger');
      } else {
          modal.style.zIndex = '';
      }
    }
    function closeLorebookModal() {
        const modal = document.getElementById("lorebookModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
        modal.style.zIndex = '';
    }
    function openBackgroundModal() {
      const name = getCurrentCharacterName();
      if (!name) return showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
      document.getElementById("backgroundCharacterName").textContent = name;
      const modal = document.getElementById("backgroundModal");
      modal.style.display = "flex";
      const settingsModal = document.getElementById("settingsModal");
      if (settingsModal.style.display === "flex") {
          const settingsZIndex = parseInt(window.getComputedStyle(settingsModal).zIndex, 10) || 1000;
          modal.style.zIndex = settingsZIndex + 10;
      } else if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            modal.classList.add('above-hamburger');
      } else {
          modal.style.zIndex = '';
      }
    }
    function closeBackgroundModal() {
        const modal = document.getElementById("backgroundModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
        modal.style.zIndex = '';
    }

    function openGreetingModal(characterName, greetings) {
        document.getElementById("greetingCharacterName").textContent = characterName;
        const optionsContainer = document.getElementById("greetingOptions");
        optionsContainer.innerHTML = "";
        let selectedGreeting = null;

        greetings.forEach((greeting, index) => {
            const optionDiv = document.createElement("div");
            optionDiv.className = "greeting-option";
            optionDiv.textContent = greeting.length > 150 ? greeting.substring(0, 150) + "..." : greeting;
            optionDiv.dataset.fullGreeting = greeting;
            if (index === 0) {
                optionDiv.classList.add("selected");
                selectedGreeting = greeting;
            }
            optionDiv.addEventListener("click", () => {
                optionsContainer.querySelectorAll(".greeting-option").forEach(opt => opt.classList.remove("selected"));
                optionDiv.classList.add("selected");
                selectedGreeting = greeting;
            });
            optionsContainer.appendChild(optionDiv);
        });

        const greetingModal = document.getElementById("greetingSelectModal");
        greetingModal.style.display = "flex";
        greetingModal.style.zIndex = '';
        greetingModal.classList.remove('above-hamburger');

        const settingsModal = document.getElementById("settingsModal");
        if (settingsModal.style.display === "flex") {
            const settingsZIndex = parseInt(window.getComputedStyle(settingsModal).zIndex, 10) || 1000;
            greetingModal.style.zIndex = settingsZIndex + 10;
        } else if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            greetingModal.classList.add('above-hamburger');
        }
    }

    function closeGreetingModal() {
        const modal = document.getElementById("greetingSelectModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
        modal.style.zIndex = '';
        tempImportedCharacterData = null;
    }
    function confirmGreetingSelection() {
        const selectedOption = document.querySelector("#greetingOptions .greeting-option.selected");
        if (selectedOption && tempImportedCharacterData) {
            tempImportedCharacterData.character.welcomeMessage = selectedOption.dataset.fullGreeting;
            finalizeImport(tempImportedCharacterData);
        }
        closeGreetingModal();
    }


    // --- Mode Switching (Personal/Group) ---
    function switchMode(mode) {
      if (currentMode === mode) return;
      currentMode = mode;

      const settingsPersonalBtn = document.querySelector('#settingsModal #personalModeBtn');
      const settingsGroupBtn = document.querySelector('#settingsModal #groupModeBtn');
      if (settingsPersonalBtn) {
        settingsPersonalBtn.classList.toggle("selected", mode === "personal");
        settingsPersonalBtn.setAttribute("aria-selected", mode === "personal");
      }
      if (settingsGroupBtn) {
        settingsGroupBtn.classList.toggle("selected", mode === "group");
        settingsGroupBtn.setAttribute("aria-selected", mode === "group");
      }

      renderMode();
      clearVariants();
    }

    function renderMode() {
      document.getElementById("groupParticipants").style.display = currentMode === "group" ? "flex" : "none";
      document.getElementById("characterSelect").disabled = currentMode === "group";
      shouldScrollToBottom = true;
      loadAndRenderMessages();
      renderGroupParticipants();
      updateVariantControls();
    }

    // --- Data Storage Utilities ---
    function saveToStorage(key, value) {
      if (value !== undefined && value !== null) localStorage.setItem(key, value);
      else localStorage.removeItem(key);
    }

    // --- Settings Load/Save ---
    function loadSettings() {
      characters = JSON.parse(localStorage.getItem("characters_v3")) || {};
      document.getElementById("apiKey").value = localStorage.getItem(API_KEY_STORAGE) || "";
      document.getElementById("apiUrl").value = localStorage.getItem(API_URL_STORAGE) || "https://openrouter.ai/api/v1/chat/completions";

      restApiUrlValue = localStorage.getItem(REST_API_URL_STORAGE) || "";
      document.getElementById("restApiUrl").value = restApiUrlValue;
      const headersString = localStorage.getItem(REST_API_HEADERS_STORAGE) || "";
      document.getElementById("restApiHeaders").value = headersString;
      try { restApiHeadersValue = headersString ? JSON.parse(headersString) : {}; }
      catch (e) { console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ REST API:", e); restApiHeadersValue = {}; }
      useRestApi = localStorage.getItem(ENABLE_REST_API_STORAGE) === "true";
      document.getElementById("enableRestApi").checked = useRestApi;

      googleApiKey = localStorage.getItem(GOOGLE_API_KEY_STORAGE) || "";
      document.getElementById("googleApiKey").value = googleApiKey;
      googleApiModel = localStorage.getItem(GOOGLE_API_MODEL_STORAGE) || (AVAILABLE_GOOGLE_MODELS.length > 0 ? AVAILABLE_GOOGLE_MODELS[0].id : "");
      document.getElementById("googleApiModel").value = googleApiModel;
      useGoogleApi = localStorage.getItem(ENABLE_GOOGLE_API_STORAGE) === "true";
      document.getElementById("enableGoogleApi").checked = useGoogleApi;



      if (!activeCharacter && Object.keys(characters).length > 0) {
        activeCharacter = Object.keys(characters)[0];
      }

      // --- Restore temperature and maxTokens from localStorage (ensure persistence even after dynamic settings re-render) ---
      try {
        const storedTemp = localStorage.getItem('temperature');
        const storedMax = localStorage.getItem('maxTokens');
        const tempEl = document.getElementById('temperature');
        const maxEl = document.getElementById('maxTokens');
        if (tempEl && storedTemp !== null) tempEl.value = storedTemp;
        if (maxEl && storedMax !== null) maxEl.value = storedMax;

        // Attach listeners so future changes are persisted (idempotent)
        function saveTemp() { try { if (tempEl) localStorage.setItem('temperature', tempEl.value); } catch(e){console.warn(e);} }
        function saveMax() { try { if (maxEl) localStorage.setItem('maxTokens', maxEl.value); } catch(e){console.warn(e);} }
        if (tempEl && !tempEl.__charis_persist_attached) { tempEl.addEventListener('input', saveTemp); tempEl.addEventListener('change', saveTemp); tempEl.__charis_persist_attached = true; }
        if (maxEl && !maxEl.__charis_persist_attached) { maxEl.addEventListener('input', saveMax); maxEl.addEventListener('change', saveMax); maxEl.__charis_persist_attached = true; }
      } catch(e){ console.warn('settings persistence injection error', e); }

      populateCharacterSelect();
    }
    function loadNeuralMemory() {
      document.getElementById("neuralMemory").value = localStorage.getItem(MEMORY_KEY) || "";
    }

    /**
     * [FIXED] Saves settings and handles avatar file uploads by resizing and compressing them.
     */
    async function saveSettings() {
      const name = document.getElementById("characterName").value.trim();
      if (!name) return showCustomAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");

      const isNewChar = !characters[name];
      const charData = characters[name] || {};

      // --- Update character data from all form fields ---
      charData.name = name;
      charData.description = document.getElementById("description").value;
      charData.personality = document.getElementById("personality").value;
      charData.scenario = document.getElementById("scenario").value;
      charData.mes_example = document.getElementById("mes_example").value;
      charData.welcomeMessage = document.getElementById("welcomeMessage").value;
      // Removed: charData.alternate_greetings = document.getElementById("alternate_greetings").value.split('\n').map(g => g.trim()).filter(g => g);
      // When saving, we don't take alternate_greetings from UI, they are only imported.
      // If charData.alternate_greetings doesn't exist or is empty, initialize it as an empty array.
      if (!charData.alternate_greetings || !Array.isArray(charData.alternate_greetings)) {
          charData.alternate_greetings = [];
      }


      // Advanced prompts
      charData.system_prompt = document.getElementById("system_prompt").value;
      charData.post_history_instructions = document.getElementById("post_history_instructions").value;
      charData.creator_notes = document.getElementById("creator_notes").value;

      charData.model = document.getElementById("characterModel").value.trim() || document.getElementById("model").value;
      charData.lorebook = charData.lorebook || [];

      // Await avatar processing
      const charAvatarFromFile = await handleAvatarUpload('character');
      const userAvatarFromFile = await handleAvatarUpload('user');

      // Prioritize file upload, then URL input, then existing, then default placeholder
      if (charAvatarFromFile) {
          charData.avatarCharacter = charAvatarFromFile;
      } else if (document.getElementById("avatarUrl_character").value) {
          charData.avatarCharacter = document.getElementById("avatarUrl_character").value;
      } else if (!charData.avatarCharacter || charData.avatarCharacter.startsWith('data:image')) {
          charData.avatarCharacter = "https://placehold.co/100x100/FF7AAC/FFFFFF?text=–ë–æ—Ç";
      }

      if (userAvatarFromFile) {
          charData.avatarUser = userAvatarFromFile;
      } else if (document.getElementById("avatarUrl_user").value) {
          charData.avatarUser = document.getElementById("avatarUrl_user").value;
      } else if (!charData.avatarUser || charData.avatarUser.startsWith('data:image')) {
          charData.avatarUser = "https://placehold.co/100x100/7AC5FF/FFFFFF?text=–í—ã";
      }


      // Save REST API settings
      restApiUrlValue = document.getElementById("restApiUrl").value.trim();
      saveToStorage(REST_API_URL_STORAGE, restApiUrlValue);
      const headersString = document.getElementById("restApiHeaders").value.trim();
      saveToStorage(REST_API_HEADERS_STORAGE, headersString);
      try { restApiHeadersValue = headersString ? JSON.parse(headersString) : {}; }
      catch (e) { showCustomAlert("–û—à–∏–±–∫–∞ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ REST API. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."); console.error("–ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö REST API:", e); restApiHeadersValue = {};}
      useRestApi = document.getElementById("enableRestApi").checked;
      saveToStorage(ENABLE_REST_API_STORAGE, useRestApi.toString());

      // Save Google API settings
      googleApiKey = document.getElementById("googleApiKey").value.trim();
      saveToStorage(GOOGLE_API_KEY_STORAGE, googleApiKey);
      googleApiModel = document.getElementById("googleApiModel").value;
      saveToStorage(GOOGLE_API_MODEL_STORAGE, googleApiModel);
      useGoogleApi = document.getElementById("enableGoogleApi").checked;
      saveToStorage(ENABLE_GOOGLE_API_STORAGE, useGoogleApi.toString());

      characters[name] = charData;
      localStorage.setItem("characters_v3", JSON.stringify(characters));

      populateCharacterSelect();
      renderChatList(document.getElementById('chatList'));
      const hamburgerChatListContainer = document.getElementById('mobileMenuChatListInternal');
      if (hamburgerChatListContainer) renderChatList(hamburgerChatListContainer);

      renderGroupParticipants();

      if (isNewChar || activeCharacter !== name) {
          setActiveCharacter(name);
      } else {
          loadAndRenderMessages();
          applyBackground(name);
      }
      document.getElementById("characterSelect").value = name;
      animateSaveButton();
      showCustomAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω.`);
      closeSettingsModal();
    }

    function populateGoogleApiModelSelect() {
        const selectEl = document.getElementById("googleApiModel");
        if (!selectEl) return;
        selectEl.innerHTML = "";
        AVAILABLE_GOOGLE_MODELS.forEach(model => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            selectEl.appendChild(option);
        });
        selectEl.value = localStorage.getItem(GOOGLE_API_MODEL_STORAGE) || (AVAILABLE_GOOGLE_MODELS.length > 0 ? AVAILABLE_GOOGLE_MODELS[0].id : "");
    }


    function animateSaveButton() {
      const btn = document.querySelector('.settings-content button[onclick="saveSettings()"]');
      if (!btn) return;
      const originalText = btn.textContent;
      btn.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
      btn.style.background = "linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)";
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 1500);
    }

    function showAvatarOptions(option, target) {
      document.getElementById(`avatarLinkInput_${target}`).style.display = option === 'link' ? 'block' : 'none';
      document.getElementById(`avatarFileInputWrapper_${target}`).style.display = option === 'file' ? 'block' : 'none';
    }

    /**
     * [FIXED] Handles avatar file upload. Resizes and compresses the image to prevent
     * localStorage size limit issues before converting to a Data URL.
     * @param {string} target - 'character' or 'user'.
     * @returns {Promise<string|null>} A promise that resolves with the compressed Data URL or null.
     */
    async function handleAvatarUpload(target) {
        const fileInput = document.getElementById(`avatarFileInput_${target}`);
        if (!fileInput || fileInput.files.length === 0) {
            return null;
        }
        const file = fileInput.files[0];
        const MAX_WIDTH = 256;
        const MAX_HEIGHT = 256;

        return new Promise((resolve) => {
            const img = document.createElement("img");
            const reader = new FileReader();

            reader.onload = (e) => {
                img.src = e.target.result; // Load file into an image element
            };

            img.onerror = () => {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.");
                resolve(null); // Resolve with null if the image fails to load
            };

            img.onload = () => {
                // Resize the image on a canvas
                const canvas = document.createElement("canvas");
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);

                // Get a compressed data URL (jpeg is usually smaller for photos)
                const dataUrl = canvas.toDataURL("image/jpeg", 0.85); 
                resolve(dataUrl);
            };
            
            reader.readAsDataURL(file);
        });
    }


    // --- Character List and Selection ---
    function populateCharacterSelect() {
      const select = document.getElementById("characterSelect");
      if (!select) return;
      const currentVal = select.value;
      select.innerHTML = "<option value=\"\" disabled>-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ --</option>";
      const sortedNames = Object.keys(characters).sort((a, b) => a.localeCompare(b, 'ru'));

      for (const name of sortedNames) {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      }
      if (characters[currentVal]) select.value = currentVal;
      else if (activeCharacter && characters[activeCharacter]) select.value = activeCharacter;
      else if (sortedNames.length > 0) select.value = "";

      select.onchange = () => {
          if (select.value) setActiveCharacter(select.value);
          clearVariants();
      };
    }

    function renderChatList(targetContainerEl = null) {
      const container = targetContainerEl || document.getElementById("chatList");
      if (!container) {
        return;
      }

      container.innerHTML = "";
      const fragment = document.createDocumentFragment();
      const sortedNames = Object.keys(characters).sort((a, b) => a.localeCompare(b, 'ru'));

      if (sortedNames.length === 0 && container.id === "chatList") {
          container.innerHTML = `<p style="text-align:center; font-style:italic; opacity:0.7; padding:1rem;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.</p>`;
          return;
      }

      for (const name of sortedNames) {
        const char = characters[name];
        const chatItem = document.createElement("div");
        chatItem.className = "chat-item";
        if (activeCharacter === name && currentMode === "personal") chatItem.classList.add("active");
        chatItem.setAttribute("role", "listitem");
        chatItem.setAttribute("tabindex", "0");

        const avatarSrc = char.avatarCharacter || "https://placehold.co/80x80/FF7AAC/FFFFFF?text=" + name.charAt(0);
        chatItem.innerHTML = `
          <img src="${avatarSrc}" alt="–ê–≤–∞—Ç–∞—Ä ${name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/FF7AAC/FFFFFF?text=?';"/>
          <div class="chat-name" title="${name}">${name}</div>
          <button class="delete-char-btn" aria-label="–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${name}" title="–£–¥–∞–ª–∏—Ç—å ${name}">√ó</button>
        `;
        chatItem.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-char-btn')) return;
            setActiveCharacter(name);
            switchMode("personal");
            clearVariants();
            if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
                mobileMenuContainer.classList.remove('open');
                if(hamburgerBtn) hamburgerBtn.classList.remove('open');
            }
        });
        chatItem.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                if (e.target.classList.contains('delete-char-btn')) {
                    e.target.click();
                } else {
                    setActiveCharacter(name);
                    switchMode("personal");
                    clearVariants();
                     if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
                        mobileMenuContainer.classList.remove('open');
                        if(hamburgerBtn) hamburgerBtn.classList.remove('open');
                    }
                }
            }
        });

        chatItem.querySelector('.delete-char-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            showCustomConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${name}" –∏ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å –Ω–∏–º? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`, () => {
              delete characters[name];
              localStorage.setItem("characters_v3", JSON.stringify(characters));
              localStorage.removeItem(getChatKey(name));

              if (activeCharacter === name) {
                activeCharacter = Object.keys(characters)[0] || null;
                if (activeCharacter) {
                  setActiveCharacter(activeCharacter);
                } else {
                  // Clear all fields if no characters left
                  ['characterName', 'description', 'personality', 'scenario', 'mes_example', 'welcomeMessage', 'characterModel', 'system_prompt', 'post_history_instructions', 'creator_notes', 'avatarUrl_character', 'avatarUrl_user'].forEach(id => document.getElementById(id).value = '');
                  // For alternate_greetings, we no longer have an input field, so just ensure it's handled as an empty array or null if needed.
                  loadAndRenderMessages();
                  applyBackground(null);
                  displayInitialHelperMessage();
                }
              }
              renderChatList(document.getElementById('chatList'));
              const hamburgerChatList = document.getElementById('mobileMenuChatListInternal');
              if (hamburgerChatList) renderChatList(hamburgerChatList);

              renderGroupParticipants();
              populateCharacterSelect();
              clearVariants();
            });
        });
        fragment.appendChild(chatItem);
      }
      container.appendChild(fragment);
    }


    function renderGroupParticipants() {
      const container = document.getElementById("groupParticipants");
      container.innerHTML = "";
      if (currentMode !== "group" || Object.keys(characters).length === 0) {
        container.style.display = "none";
        return;
      }
      container.style.display = "flex";
      const fragment = document.createDocumentFragment();
      const sortedNames = Object.keys(characters).sort((a, b) => a.localeCompare(b, 'ru'));

      for (const name of sortedNames) {
        const char = characters[name];
        const participant = document.createElement("div");
        participant.className = "participant";
        participant.title = `–û—Ç–≤–µ—Ç–∏—Ç—å –æ—Ç –∏–º–µ–Ω–∏ ${name}`;
        participant.setAttribute("role", "button");
        participant.setAttribute("tabindex", "0");
        const avatarSrc = char.avatarCharacter || 'https://placehold.co/80x80/FF7AAC/FFFFFF?text=' + name.charAt(0);
        participant.innerHTML = `
          <img src="${avatarSrc}" alt="–ê–≤–∞—Ç–∞—Ä ${name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/FF7AAC/FFFFFF?text=?';"/>
          <div>${name}</div>
        `;
        participant.addEventListener('click', () => {
            showCustomConfirm(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ ${name}?`, () => {
                 respondToLastMessage(name);
            });
        });
        participant.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                showCustomConfirm(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ ${name}?`, () => {
                     respondToLastMessage(name);
                });
            }
        });
        fragment.appendChild(participant);
      }
      if (sortedNames.length === 0) {
          container.innerHTML = `<p style="text-align:center; font-style:italic; opacity:0.7; padding:0.5rem;">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>`;
      } else {
          container.appendChild(fragment);
      }
    }


    function setActiveCharacter(name) {
      if (!characters[name]) {
        console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
        activeCharacter = null;
        return;
      }
      activeCharacter = name;
      const ch = characters[name];

      // --- Populate all settings fields for the active character ---
      document.getElementById("characterName").value = name;
      document.getElementById("description").value = ch.description || "";
      document.getElementById("personality").value = ch.personality || "";
      document.getElementById("scenario").value = ch.scenario || "";
      document.getElementById("mes_example").value = ch.mes_example || "";
      document.getElementById("welcomeMessage").value = ch.welcomeMessage || "";
      // Removed: document.getElementById("alternate_greetings").value = (ch.alternate_greetings || []).join('\n');
      document.getElementById("system_prompt").value = ch.system_prompt || "";
      document.getElementById("post_history_instructions").value = ch.post_history_instructions || "";
      document.getElementById("creator_notes").value = ch.creator_notes || "";
      document.getElementById("characterModel").value = ch.model || "";
      
      // Update avatar URL input fields based on character data
      const avatarUrlInputChar = document.getElementById("avatarUrl_character");
      if (ch.avatarCharacter && !ch.avatarCharacter.startsWith('data:image')) {
          avatarUrlInputChar.value = ch.avatarCharacter;
          showAvatarOptions('link', 'character');
      } else {
          avatarUrlInputChar.value = "";
          showAvatarOptions('file', 'character'); // Default to file input if it's a data URL or missing
      }
      
      const avatarUrlInputUser = document.getElementById("avatarUrl_user");
      if (ch.avatarUser && !ch.avatarUser.startsWith('data:image')) {
          avatarUrlInputUser.value = ch.avatarUser;
          showAvatarOptions('link', 'user');
      } else {
          avatarUrlInputUser.value = "";
          showAvatarOptions('file', 'user'); // Default to file input if it's a data URL or missing
      }


      if (document.getElementById("characterSelect").value !== name) {
          document.getElementById("characterSelect").value = name;
      }

      shouldScrollToBottom = true;
      loadAndRenderMessages();
      renderChatList(document.getElementById('chatList'));
      const hamburgerChatList = document.getElementById('mobileMenuChatListInternal');
      if (hamburgerChatList) renderChatList(hamburgerChatList);

      applyBackground(name);
      clearVariants();
    }

    function getCurrentCharacterName() {
      if (currentMode === "personal") {
        return activeCharacter || (Object.keys(characters).length > 0 ? Object.keys(characters)[0] : null);
      }
      return null;
    }

    // --- Chat History Management ---
    function getChatKey(name) { return `chatHistory_v3_${name}`; }
    function saveChat(name, messages) {
      if (!name) return;
      try {
        localStorage.setItem(getChatKey(name), JSON.stringify(messages));
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞ –≤ localStorage:", e);
        showCustomAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è.");
      }
      allMessages = messages;
    }
    function loadChat(name) {
      if (!name) return [];
      let msgs = JSON.parse(localStorage.getItem(getChatKey(name)) || "[]");
      return msgs.map(msg => ({ ...msg, attachments: msg.attachments || null }));
    }
    function saveRoomChat(messages) {
        try {
            localStorage.setItem(ROOM_HISTORY_KEY, JSON.stringify(messages));
        } catch(e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞ –∫–æ–º–Ω–∞—Ç—ã –≤ localStorage:", e);
            showCustomAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è.");
        }
        allMessages = messages;
    }
    function loadRoomChat() {
      let msgs = JSON.parse(localStorage.getItem(ROOM_HISTORY_KEY) || "[]");
      return msgs.map(msg => ({ ...msg, attachments: msg.attachments || null }));
    }

    let allMessages = [];

    function loadAndRenderMessages(scrollToIndex = -1) {
        messagesBox.innerHTML = "";
        let characterForBackground = null;

        if (currentMode === "personal") {
            const name = getCurrentCharacterName();
            if (!name) {
                displayInitialHelperMessage();
                applyBackground(null);
                allMessages = [];
                return;
            }
            allMessages = loadChat(name);
            characterForBackground = name;
            if (allMessages.length === 0 && characters[name]?.welcomeMessage) {
                const welcome = characters[name].welcomeMessage;
                const welcomeMsgObject = { role: "assistant", content: welcome, avatar: characters[name].avatarCharacter, attachments: null };
                allMessages.push(welcomeMsgObject);
                saveChat(name, allMessages);
            } else if (allMessages.length === 0) {
                 const helperP = document.createElement('p');
                 helperP.style.textAlign = 'center'; helperP.style.color = 'var(--text-color)'; helperP.style.padding = '20px'; helperP.style.fontStyle = 'italic'; helperP.style.opacity = '0.7';
                 helperP.textContent = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!';
                 messagesBox.appendChild(helperP);
            }
        } else {
            allMessages = loadRoomChat();
            characterForBackground = null;
            if (allMessages.length === 0) {
                const helperP = document.createElement('p');
                helperP.style.textAlign = 'center'; helperP.style.color = 'var(--text-color)'; helperP.style.padding = '20px'; helperP.style.fontStyle = 'italic'; helperP.style.opacity = '0.7';
                helperP.textContent = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!';
                messagesBox.appendChild(helperP);
            }
        }
        applyBackground(characterForBackground);

        const fragment = document.createDocumentFragment();
        allMessages.forEach((msg, i) => {
            const container = createMessageContainerDOM(msg, i);
            fragment.appendChild(container);
        });
        messagesBox.appendChild(fragment);

        if (scrollToIndex !== -1 && scrollToIndex < allMessages.length) {
            const targetMsgEl = messagesBox.children[scrollToIndex];
            if (targetMsgEl) targetMsgEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
        } else if (shouldScrollToBottom) {
            scrollToBottom(true);
            shouldScrollToBottom = false;
        }
    }


    // --- Message DOM Manipulation ---
    function createMessageContainerDOM(msgData, index) {
      const container = document.createElement("div");
      container.className = "message-container";
      container.dataset.index = index;

      let senderName, msgClass, roleForButtons, avatarUrl;
      const charNameForMsg = getCurrentCharacterName();

      if (currentMode === "personal") {
        senderName = msgData.role === "user" ? "–í—ã" : charNameForMsg;
        msgClass = msgData.role === "user" ? "user" : (msgData.role === "system" ? "system" : (msgData.role === "api" ? "api" : ""));
        roleForButtons = msgData.role;
        if (msgData.role === "user") {
          avatarUrl = characters[charNameForMsg]?.avatarUser || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
        } else if (msgData.role === "assistant") {
          avatarUrl = characters[charNameForMsg]?.avatarCharacter || "https://placehold.co/80x80/FF7AAC/FFFFFF?text=" + (charNameForMsg ? charNameForMsg.charAt(0) : "–ë");
        } else {
          avatarUrl = msgData.role === "system" ? "https://placehold.co/80x80/CCCCCC/FFFFFF?text=S" : "https://placehold.co/80x80/80D0C0/FFFFFF?text=A";
        }
      } else {
        senderName = msgData.sender || (msgData.role === "user" ? "–í—ã" : "–°–∏—Å—Ç–µ–º–∞");
        msgClass = (msgData.sender === "–í—ã" || msgData.role === "user") ? "user" : (msgData.role === "system" ? "system" : (msgData.role === "api" ? "api" : ""));
        roleForButtons = msgData.role;
        if (msgData.sender === "–í—ã") {
          const anyUserAvatar = Object.values(characters).find(c => c.avatarUser)?.avatarUser;
          avatarUrl = anyUserAvatar || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
        } else if (characters[msgData.sender]) {
          avatarUrl = characters[msgData.sender].avatarCharacter || "https://placehold.co/80x80/FF7AAC/FFFFFF?text=" + msgData.sender.charAt(0);
        } else {
          avatarUrl = msgData.role === "system" ? "https://placehold.co/80x80/CCCCCC/FFFFFF?text=S" : "https://placehold.co/80x80/80D0C0/FFFFFF?text=A";
        }
      }
      avatarUrl = msgData.avatar || avatarUrl;
      if (msgClass === "user") container.classList.add("user-container");

      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';

      const avatarImg = document.createElement("img");
      avatarImg.src = avatarUrl || "https://placehold.co/80x80/CCCCCC/FFFFFF?text=?";
      avatarImg.alt = `–ê–≤–∞—Ç–∞—Ä ${senderName}`;
      avatarImg.className = "avatar";
      avatarImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/80x80/CCCCCC/FFFFFF?text=?'; };


      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${msgClass}`;

      let htmlContent = "";
      let textPart = msgData.content ? marked.parse(msgData.content) : '';
      htmlContent = `<strong>${senderName}:</strong>${textPart}`;
      messageDiv.innerHTML = htmlContent;

      if (msgData.attachments && msgData.attachments.length > 0) {
        const attachmentsGrid = document.createElement('div');
        attachmentsGrid.className = 'attachments-grid';
        msgData.attachments.forEach(att => {
            if (att.type && att.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = att.src;
                img.alt = att.name || '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                img.className = 'attached-image';
                attachmentsGrid.appendChild(img);
            } else {
                const fileLink = document.createElement('a');
                fileLink.href = att.src;
                fileLink.target = '_blank';
                fileLink.className = 'attached-file-link';
                fileLink.download = att.name || 'file';
                fileLink.innerHTML = `<span class="file-icon">üìÑ</span> ${att.name || '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª'}`;
                attachmentsGrid.appendChild(fileLink);
            }
        });
        messageDiv.appendChild(attachmentsGrid);
      }


      contentWrapper.appendChild(avatarImg);
      contentWrapper.appendChild(messageDiv);
      container.appendChild(contentWrapper);

      if (index !== null && roleForButtons !== "system" && senderName !== "API" && senderName !== "–°–∏—Å—Ç–µ–º–∞") {
        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "message-buttons";

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn"; copyBtn.title = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
        copyBtn.setAttribute("aria-label", "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        copyBtn.addEventListener("click", () => copyMessageToClipboard(msgData.content || ""));
        buttonsDiv.appendChild(copyBtn);

        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn"; editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.setAttribute("aria-label", "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        editBtn.addEventListener("click", () => startEditingMessage(container, index));
        buttonsDiv.appendChild(editBtn);

        if (roleForButtons === "assistant") {
          const regenBtn = document.createElement("button");
          regenBtn.className = "regen-btn"; regenBtn.title = "–†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å";
          regenBtn.setAttribute("aria-label", "–†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç");
          regenBtn.addEventListener("click", () => regenerateMessage(index));
          if (isBotGenerating) regenBtn.disabled = true;
          buttonsDiv.appendChild(regenBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn"; delBtn.title = "–£–¥–∞–ª–∏—Ç—å";
        delBtn.setAttribute("aria-label", "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        delBtn.addEventListener("click", () => deleteMessage(index));
        buttonsDiv.appendChild(delBtn);

        container.appendChild(buttonsDiv);
      }
      return container;
    }

    function appendNewMessageToDOM(msgData, index) {
        const container = createMessageContainerDOM(msgData, index);
        messagesBox.appendChild(container);
        requestAnimationFrame(() => {
            container.style.opacity = 1;
            container.style.transform = 'translateY(0)';
        });
        if (shouldScrollToBottom) {
            scrollToBottom(true);
        }
    }

    function updateMessageInDOM(index, newMsgData) {
        const oldContainer = messagesBox.querySelector(`.message-container[data-index="${index}"]`);
        if (oldContainer) {
            const newContainer = createMessageContainerDOM(newMsgData, index);
            messagesBox.replaceChild(newContainer, oldContainer);
             requestAnimationFrame(() => {
                newContainer.style.opacity = 1;
                newContainer.style.transform = 'translateY(0)';
            });
        }
    }
    function removeMessageFromDOM(index) {
        const containerToRemove = messagesBox.querySelector(`.message-container[data-index="${index}"]`);
        if (containerToRemove) {
            messagesBox.removeChild(containerToRemove);
            const messageContainers = messagesBox.querySelectorAll('.message-container');
            messageContainers.forEach((container, newIdx) => {
                container.dataset.index = newIdx;
            });
        }
    }


    function scrollToBottom(force = false) {
      if (force || messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 100) {
        messagesBox.scrollTop = messagesBox.scrollHeight;
      }
    }

    // --- Message Editing ---
    function startEditingMessage(container, index) {
      const messageContentWrapper = container.querySelector(".message-content-wrapper");
      const messageButtons = container.querySelector(".message-buttons");
      if (!messageContentWrapper || container.querySelector(".message-edit-area")) return;

      let originalText = allMessages[index].content;

      messageContentWrapper.style.display = "none";
      if (messageButtons) messageButtons.style.display = "none";

      const editArea = document.createElement("textarea");
      editArea.className = "message-edit-area";
      editArea.value = originalText;
      editArea.style.height = 'auto';
      editArea.style.height = (Math.max(80, editArea.scrollHeight)) + 'px';
      editArea.addEventListener('input', () => {
          editArea.style.height = 'auto';
          editArea.style.height = (Math.max(80, editArea.scrollHeight)) + 'px';
      });

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; saveBtn.className = "send-button";
      saveBtn.style.marginRight = "0.5rem";

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "–û—Ç–º–µ–Ω–∞"; cancelBtn.className = "send-button";
      cancelBtn.style.background = "var(--participant-bg)"; cancelBtn.style.color = "var(--text-color)";

      const btnContainer = document.createElement("div");
      btnContainer.className = "edit-button-container";
      btnContainer.appendChild(saveBtn); btnContainer.appendChild(cancelBtn);

      container.insertBefore(editArea, messageContentWrapper);
      container.insertBefore(btnContainer, editArea.nextSibling);
      editArea.focus();

      saveBtn.onclick = () => {
        const newText = editArea.value.trim();
        const currentMessageAttachments = allMessages[index]?.attachments;
        if (!newText && (!currentMessageAttachments || currentMessageAttachments.length === 0)) {
            return showCustomAlert("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π.");
        }
        updateMessageContent(index, newText);

        if (allMessages[index].role === 'user' || allMessages[index].sender === '–í—ã') {
            const charToRespondName = currentMode === 'personal' ? getCurrentCharacterName() : getLastBotSender(index);
            if (charToRespondName && characters[charToRespondName]) {
                triggerBotResponseAfterEdit(index, charToRespondName);
            }
        }
      };
      cancelBtn.onclick = () => {
        messageContentWrapper.style.display = "flex";
        if (messageButtons) messageButtons.style.display = "flex";
        container.removeChild(editArea);
        container.removeChild(btnContainer);
      };
    }

    function getLastBotSender(currentUserMsgIndex) {
        if (currentMode !== 'group') return null;
        for (let i = currentUserMsgIndex - 1; i >= 0; i--) {
            if (allMessages[i].role === 'assistant' && allMessages[i].sender && characters[allMessages[i].sender]) {
                return allMessages[i].sender;
            }
        }
        return Object.keys(characters).length > 0 ? Object.keys(characters)[0] : null;
    }

    async function triggerBotResponseAfterEdit(editedUserMessageIndex, characterNameToRespond) {
        const charDataForApi = characters[characterNameToRespond];
        if (!charDataForApi) return;

        const historyUpToEdited = allMessages.slice(0, editedUserMessageIndex + 1);
        const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
        const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;

        if (allMessages.length > editedUserMessageIndex + 1) {
            allMessages.splice(editedUserMessageIndex + 1);
             if (currentMode === "personal") saveChat(getCurrentCharacterName(), allMessages);
             else saveRoomChat(allMessages);
            loadAndRenderMessages(editedUserMessageIndex);
        }

        const systemPromptText = getSystemContent(charDataForApi, allMessages[editedUserMessageIndex].content);

        if (useGoogleApi && googleApiKey && googleApiModel) {
            let geminiContents = [];
            historyUpToEdited.forEach(m => {
                let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
                let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${m.content}` : m.content;

                let parts = [];
                if (textContent) parts.push({ text: textContent });
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                    m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                    });
                } else if (m.attachments) {
                     parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }

                if (parts.length > 0) {
                     if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                        console.warn("Consecutive roles for Gemini (after edit), appending parts:", role);
                        geminiContents[geminiContents.length - 1].parts.push(...parts);
                    } else {
                        geminiContents.push({ role: role, parts: parts });
                    }
                }
            });
            let lastValidRoleAfterEdit = null;
            geminiContents = geminiContents.filter(item => {
                if (item.role === lastValidRoleAfterEdit) return false;
                lastValidRoleAfterEdit = item.role;
                return true;
            });

            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ systemPromptText (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã) —á—Ç–æ–±—ã Gemini —É—á–∏—Ç—ã–≤–∞–ª –∏—Ö —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
            try {
                const postEl = document.getElementById('post_history_instructions');
                const postInstr = postEl ? postEl.value.trim() : '';
                if (postInstr) {
                    // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü systemPromptText, –æ—Ç–¥–µ–ª—è—è –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                    systemPromptText = (systemPromptText ? systemPromptText + "\n\n" : "") + postInstr;
                }
            } catch(e){ console.error('post history instructions append error', e); }
        await fetchGeminiChatCompletion(
                googleApiKey, googleApiModel, systemPromptText, geminiContents,
                temperature, max_tokens, characterNameToRespond,
                allMessages, charDataForApi.avatarCharacter, true
            );

        } else {
            let messagesForAPI = [{ role: "system", content: systemPromptText }];
            messagesForAPI.push(...historyUpToEdited.map(m => {
                let apiMsgContentArray = [];
                if (m.content) apiMsgContentArray.push({ type: "text", text: m.content });
                // Append post-history instructions as system (if present)
                try {
                    const postEl = document.getElementById('post_history_instructions');
                    const postInstr = postEl ? postEl.value.trim() : '';
                    if (postInstr) {
                        messagesForAPI.push({ role: "system", content: postInstr });
                    }
                } catch(e){ console.error('post history instructions append error', e); }
                
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                    m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                         apiMsgContentArray.push({ type: "image_url", image_url: { url: att.src } });
                    });
                } else if (m.attachments) {
                     apiMsgContentArray.push({ type: "text", text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }
                const finalContent = apiMsgContentArray.length === 1 && apiMsgContentArray[0].type === "text" ? apiMsgContentArray[0].text : apiMsgContentArray;

                return {
                    role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                    content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${finalContent}` : finalContent
                };
            }));

            const apiKey = document.getElementById("apiKey").value;
            const apiUrl = document.getElementById("apiUrl").value;
            const modelForApi = charDataForApi.model || document.getElementById("model").value;

            await fetchChatCompletion(
                apiUrl, apiKey, modelForApi, messagesForAPI,
                temperature, max_tokens, characterNameToRespond,
                allMessages, charDataForApi.avatarCharacter, true
            );
        }
    }


    function updateMessageContent(index, newContent) {
      if (index < 0 || index >= allMessages.length) return;
      const msgToUpdate = allMessages[index];
      msgToUpdate.content = newContent;

      if (currentMode === "personal") {
        const name = getCurrentCharacterName();
        if (!name) return;
        saveChat(name, allMessages);
      } else {
        saveRoomChat(allMessages);
      }
      updateMessageInDOM(index, msgToUpdate);
    }

    function deleteMessage(index) {
      if (index < 0 || index >= allMessages.length) return;
      showCustomConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?", () => {
        allMessages.splice(index, 1);

        if (currentMode === "personal") {
          const name = getCurrentCharacterName();
          if (!name) return;
          saveChat(name, allMessages);
        } else {
          saveRoomChat(allMessages);
        }
        removeMessageFromDOM(index);
        clearVariants();
        if (allMessages.length === 0) {
            loadAndRenderMessages();
        }
      });
    }

    // --- Message Regeneration ---
    async function regenerateMessage(index) {
        if (isBotGenerating) return;
        if (index < 0 || index >= allMessages.length || allMessages[index].role !== 'assistant') {
            showCustomAlert("–ú–æ–∂–Ω–æ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.");
            return;
        }

        isBotGenerating = true;
        updateRegenerateButtonsState(true);
        setStatusActive(true);

        const characterForResponse = currentMode === "personal" ? getCurrentCharacterName() : allMessages[index].sender;
        if (!characterForResponse || !characters[characterForResponse]) {
            showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.");
            isBotGenerating = false; updateRegenerateButtonsState(false); setStatusActive(false);
            return;
        }
        const charData = characters[characterForResponse];

        let userMsgIndex = -1;
        for (let i = index - 1; i >= 0; i--) {
            const msg = allMessages[i];
            const isUserMsg = (currentMode === "personal" && msg.role === "user") ||
                              (currentMode === "group" && (msg.sender === "–í—ã" || msg.role === "user"));
            if (isUserMsg) {
                userMsgIndex = i;
                break;
            }
        }
        if (userMsgIndex === -1) {
            showCustomAlert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.");
            isBotGenerating = false; updateRegenerateButtonsState(false); setStatusActive(false);
            return;
        }

        if (regenerateVariants.length === 0 || currentVariantIndex === -1) {
            regenerateVariants = [JSON.parse(JSON.stringify(allMessages))];
            currentVariantIndex = 0;
        }

        const historyForAPI = allMessages.slice(0, index);
        const userMessageContentForSystem = allMessages[userMsgIndex].content;

        const targetMessageContainer = messagesBox.querySelector(`.message-container[data-index="${index}"]`);
        const messageDivToUpdate = targetMessageContainer ? targetMessageContainer.querySelector('.message') : null;

        if (messageDivToUpdate) {
            messageDivToUpdate.innerHTML = `<strong>${characterForResponse}:</strong> ...—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...`;
            scrollToBottom(true);
        }

        let newVariantChatState;

        try {
            let reply;
            const systemPromptText = getSystemContent(charData, userMessageContentForSystem);

            if (useGoogleApi && googleApiKey && googleApiModel) {
                let geminiContents = [];
                 historyForAPI.forEach(m => {
                    let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
                    let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${m.content}` : m.content;
                    let parts = [];
                    if (textContent) parts.push({ text: textContent });
                    if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                        m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                            parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                        });
                    } else if (m.attachments) {
                        parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                    }
                    if (parts.length > 0) {
                         if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                             console.warn("Consecutive roles for Gemini (regen), appending parts:", role);
                             geminiContents[geminiContents.length - 1].parts.push(...parts);
                         } else {
                            geminiContents.push({ role: role, parts: parts });
                         }
                    }
                });
                let lastValidRoleRegen = null;
                geminiContents = geminiContents.filter(item => {
                    if (item.role === lastValidRoleRegen) return false;
                    lastValidRoleRegen = item.role;
                    return true;
                });

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${googleApiModel}:generateContent?key=${googleApiKey}`;
                const geminiRequestBody = {
                    systemInstruction: { parts: [{ text: systemPromptText }] },
                    contents: geminiContents,
                    generationConfig: {
                        temperature: parseFloat(document.getElementById("temperature").value) || 0.7,
                        maxOutputTokens: parseInt(document.getElementById("maxTokens").value) || 1024
                    }
                };
                const response = await fetch(geminiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(geminiRequestBody)
                });
                if (!response.ok) throw new Error(`Google API –û—à–∏–±–∫–∞: ${response.status} ${await response.text()}`);
                const result = await response.json();
                reply = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (!reply && !(result.candidates && result.candidates[0].finishReason === "MAX_TOKENS")) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Google API.");

                newVariantChatState = JSON.parse(JSON.stringify(allMessages.slice(0, index)));
                const newBotMsgData = {
                    ...allMessages[index],
                    content: reply,
                    attachments: null,
                };
                newVariantChatState.push(newBotMsgData);
                if (allMessages.length > index + 1) {
                    newVariantChatState.push(...JSON.parse(JSON.stringify(allMessages.slice(index + 1))));
                }
                regenerateVariants.push(newVariantChatState);
                currentVariantIndex = regenerateVariants.length - 1;
                allMessages = [...newVariantChatState];
                if (currentMode === "personal") saveChat(getCurrentCharacterName(), allMessages);
                else saveRoomChat(allMessages);
                updateMessageInDOM(index, allMessages[index]);
                scrollToBottom(true);
                shouldScrollToBottom = false;

            } else {
                shouldScrollToBottom = true;
                let messagesForStdAPI = [{ role: "system", content: systemPromptText }];
                messagesForStdAPI.push(...historyForAPI.map(m => {
                     let apiContentArray = [];
                     if (m.content) apiContentArray.push({ type: "text", text: m.content });
                // Append '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏' –∫–∞–∫ system-—Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ)
                try {
                    const postEl = document.getElementById('post_history_instructions');
                    const postInstr = postEl ? postEl.value.trim() : '';
                    if (postInstr) {
                        messagesForStdAPI.push({ role: "system", content: postInstr });
                    }
                } catch(e){ console.error('post history instructions append error', e); }
                
                     if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                         m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                              apiContentArray.push({ type: "image_url", image_url: { url: att.src } });
                         });
                     } else if (m.attachments) {
                         apiContentArray.push({ type: "text", text: ` [–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                     }
                     const finalContent = apiContentArray.length === 1 && apiContentArray[0].type === "text" ? apiContentArray[0].text : apiContentArray;
                    return {
                        role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                        content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${finalContent}` : finalContent
                    };
                }));

                const apiKey = document.getElementById("apiKey").value;
                const apiUrl = document.getElementById("apiUrl").value;
                const model = charData.model || document.getElementById("model").value;
                const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
                const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model, messages: messagesForStdAPI, stream: true, max_tokens, temperature })
                });
                if (!response.ok) throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status} ${await response.text()}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let streamedContent = "";
                reply = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n").filter(line => line.trim().startsWith("data: "));
                    for (const line of lines) {
                        if (line.includes("[DONE]")) break;
                        const jsonString = line.replace(/^data: /, "");
                        try {
                            const parsed = JSON.parse(jsonString);
                            const content = parsed.choices?.[0]?.delta?.content;
                            if (content) {
                                streamedContent += content;
                                reply = removeThoughts(streamedContent);
                                if (messageDivToUpdate) {
                                    messageDivToUpdate.innerHTML = `<strong>${characterForResponse}:</strong>${marked.parse(reply)}`;
                                    scrollToBottom(true);
                                }
                            }
                        } catch (e) { /* console.warn("Stream parsing error:", e, jsonString); */ }
                    }
                }
                if (!reply && streamedContent) reply = removeThoughts(streamedContent);

                newVariantChatState = JSON.parse(JSON.stringify(allMessages.slice(0, index)));
                const newBotMsgDataStreaming = {
                    ...allMessages[index],
                    content: reply,
                    attachments: null,
                };
                newVariantChatState.push(newBotMsgDataStreaming);
                if (allMessages.length > index + 1) {
                    newVariantChatState.push(...JSON.parse(JSON.stringify(allMessages.slice(index + 1))));
                }
                regenerateVariants.push(newVariantChatState);
                currentVariantIndex = regenerateVariants.length - 1;
                allMessages = [...newVariantChatState];
                if (currentMode === "personal") saveChat(getCurrentCharacterName(), allMessages);
                else saveRoomChat(allMessages);
                if (!messageDivToUpdate) {
                    updateMessageInDOM(index, allMessages[index]);
                }
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:", err);
            if (messageDivToUpdate) {
                 const originalMessageOfCurrentVariant = regenerateVariants[currentVariantIndex] ? regenerateVariants[currentVariantIndex][index] : null;
                 const veryFirstOriginalMessage = regenerateVariants[0] ? regenerateVariants[0][index] : null;
                 const messageToRevertTo = originalMessageOfCurrentVariant || veryFirstOriginalMessage;

                 if (messageToRevertTo) {
                    updateMessageInDOM(index, messageToRevertTo);
                    allMessages[index] = JSON.parse(JSON.stringify(messageToRevertTo));
                 } else {
                    messageDivToUpdate.innerHTML = `<strong>${characterForResponse}:</strong> –û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${err.message}`;
                 }
            } else {
                appendNewMessageToDOM({ sender: "–°–∏—Å—Ç–µ–º–∞", content: `–û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${err.message}`, role: "system" }, allMessages.length);
            }
        } finally {
            setStatusActive(false);
            isBotGenerating = false;
            updateRegenerateButtonsState(false);
            updateVariantControls();
            if (shouldScrollToBottom) { scrollToBottom(true); shouldScrollToBottom = false; }
            userInput.focus();
        }
    }


    function updateRegenerateButtonsState(disable) {
        const regenBtns = document.querySelectorAll('.message-buttons .regen-btn');
        regenBtns.forEach(btn => btn.disabled = disable);
    }


    function renderSpecificChatState(chatState) {
        messagesBox.innerHTML = "";
        const fragment = document.createDocumentFragment();
        chatState.forEach((msg, i) => {
            const container = createMessageContainerDOM(msg, i);
            fragment.appendChild(container);
        });
        messagesBox.appendChild(fragment);
        scrollToBottom(true);
    }


    function updateVariantControls() {
      const hasVariants = regenerateVariants.length > 1;
      [prevVariantBtn, nextVariantBtn, applyVariantBtn, variantCounter].forEach(el => {
          if (el) el.style.display = hasVariants ? "inline-block" : "none";
      });
      if (!hasVariants) {
        if (variantCounter) variantCounter.textContent = "";
        if(prevVariantBtn) prevVariantBtn.disabled = true;
        if(nextVariantBtn) nextVariantBtn.disabled = true;
        return;
      }
      if (currentVariantIndex < 0 && regenerateVariants.length > 0) currentVariantIndex = 0;
      if (currentVariantIndex >= regenerateVariants.length) currentVariantIndex = regenerateVariants.length - 1;

      if (variantCounter) variantCounter.textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${currentVariantIndex + 1} / ${regenerateVariants.length}`;
      if (prevVariantBtn) prevVariantBtn.disabled = currentVariantIndex === 0;
      if (nextVariantBtn) nextVariantBtn.disabled = currentVariantIndex === regenerateVariants.length - 1;
    }
    function prevVariant() { if (currentVariantIndex > 0) { currentVariantIndex--; renderVariant(); updateVariantControls(); } }
    function nextVariant() { if (currentVariantIndex < regenerateVariants.length - 1) { currentVariantIndex++; renderVariant(); updateVariantControls(); } }
    function applyVariant() {
      if (currentVariantIndex < 0 || currentVariantIndex >= regenerateVariants.length) return;
      const variantToApply = regenerateVariants[currentVariantIndex];
      allMessages = [...variantToApply];

      if (currentMode === "personal") {
        const name = getCurrentCharacterName();
        if (!name) return;
        saveChat(name, allMessages);
      } else {
        saveRoomChat(allMessages);
      }
      clearVariantsAndRender();
    }
    function renderVariant() {
      if (currentVariantIndex < 0 || currentVariantIndex >= regenerateVariants.length) return;
      renderSpecificChatState(regenerateVariants[currentVariantIndex]);
    }
    function clearVariants() { regenerateVariants = []; currentVariantIndex = -1; updateVariantControls(); }
    function clearVariantsAndRender() {
        clearVariants();
        shouldScrollToBottom = true;
        loadAndRenderMessages();
    }


    function getNeuralMemory() { return document.getElementById("neuralMemory").value.trim(); }

    function getSystemContent(charData, userMessage) {
        const memory = getNeuralMemory();
        const dateTime = new Date().toLocaleString('ru-RU', { dateStyle: 'full', timeStyle: 'short' });
        const dateTimeInfo = `[–¢–µ–∫—É—â–∏–µ –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è]: ${dateTime}`;

        // Build a comprehensive character definition string
        let characterDefinition = "";
        if (charData.description) characterDefinition += `[–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞]\n${charData.description}\n\n`;
        if (charData.personality) characterDefinition += `[–õ–∏—á–Ω–æ—Å—Ç—å]\n${charData.personality}\n\n`;
        if (charData.scenario) characterDefinition += `[–°—Ü–µ–Ω–∞—Ä–∏–π]\n${charData.scenario}\n\n`;
        if (charData.mes_example) characterDefinition += `[–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞]\n${charData.mes_example}\n\n`;

        // Start building the final system prompt
        let systemContent = `${characterDefinition.trim()}\n\n${dateTimeInfo}`;

        if (memory) {
            systemContent += `\n\n[–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏)]:\n${memory}`;
        }

        // Add character's specific system_prompt if it exists
        if (charData.system_prompt) {
            systemContent += `\n\n[–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]\n${charData.system_prompt}`;
        }

        // Check lorebook entries against the user's message
        if (charData.lorebook && charData.lorebook.length > 0 && userMessage) {
            const triggeredEntries = charData.lorebook.filter(entry =>
                entry.triggers && entry.triggers.some(trigger => userMessage.toLowerCase().includes(trigger.toLowerCase().trim()))
            );
            if (triggeredEntries.length > 0) {
                const loreInfo = triggeredEntries.map(entry => {
                    let entryPrefix = "- ";
                    if (entry.entryName) {
                        entryPrefix = `- [${entry.entryName}]: `;
                    }
                    return `${entryPrefix}${entry.info}`;
                }).join("\n");
                systemContent += `\n\n[–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ Lorebook (–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)]:\n${loreInfo}`;
            }
        }
        return systemContent.trim();
    }


    async function sendToRestApi(userMessageContent, attachmentsArray = null) {
        if (!restApiUrlValue) {
            appendNewMessageToDOM({sender:"–°–∏—Å—Ç–µ–º–∞", content:"URL REST API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.", role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"}, allMessages.length);
            return;
        }
        setStatusActive(true);
        const apiPlaceholderAvatar = "https://placehold.co/80x80/80D0C0/FFFFFF?text=A";
        const placeholderMsgData = {sender:"API", content:"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ REST API...", role:"api", avatar: apiPlaceholderAvatar, attachments: attachmentsArray};
        allMessages.push(placeholderMsgData);
        appendNewMessageToDOM(placeholderMsgData, allMessages.length -1);


        try {
            const requestBody = { message: userMessageContent, attachments: attachmentsArray };
            const response = await fetch(restApiUrlValue, {
                method: "POST",
                headers: { "Content-Type": "application/json", ...restApiHeadersValue },
                body: JSON.stringify(requestBody)
            });

            const placeholderIndex = allMessages.findIndex(m => m.content === "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ REST API..." && m.sender === "API");
            if (placeholderIndex > -1) {
                allMessages.splice(placeholderIndex, 1);
                removeMessageFromDOM(placeholderIndex);
            }


            const responseData = await response.json();
            if (!response.ok) throw new Error(`API –û—à–∏–±–∫–∞: ${response.status} - ${responseData.error || JSON.stringify(responseData)}`);

            let apiReplyText = responseData.reply || responseData.message || JSON.stringify(responseData.data) || JSON.stringify(responseData);
            const apiReplyMsgData = {sender:"API", content:apiReplyText, role:"api", avatar: apiPlaceholderAvatar, attachments: responseData.attachments};
            allMessages.push(apiReplyMsgData);
            appendNewMessageToDOM(apiReplyMsgData, allMessages.length - 1);


        } catch (error) {
            console.error("REST API –û—à–∏–±–∫–∞:", error);
            const placeholderIndexOnError = allMessages.findIndex(m => m.content === "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ REST API..." && m.sender === "API");
            if (placeholderIndexOnError > -1) {
                 allMessages.splice(placeholderIndexOnError, 1);
                removeMessageFromDOM(placeholderIndexOnError);
            }
            const errorMsgData = {sender:"–°–∏—Å—Ç–µ–º–∞", content:`–û—à–∏–±–∫–∞ REST API: ${error.message}`, role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
            allMessages.push(errorMsgData);
            appendNewMessageToDOM(errorMsgData, allMessages.length - 1);

        } finally {
            setStatusActive(false);
            scrollToBottom(true);
            userInput.focus();
        }
    }
    function setupRestApiSwitch() {
        const enableRestApiCheckbox = document.getElementById("enableRestApi");
        enableRestApiCheckbox.addEventListener("change", () => {
            useRestApi = enableRestApiCheckbox.checked;
            saveToStorage(ENABLE_REST_API_STORAGE, useRestApi.toString());
        });
    }

    async function respondToLastMessage(characterName) {
      if (isBotGenerating) return;
      isBotGenerating = true;
      updateRegenerateButtonsState(true);

      const currentGroupMessages = [...allMessages];
      if (currentGroupMessages.length === 0) {
          showCustomAlert("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–≤–µ—Ç–∞.");
          isBotGenerating = false; updateRegenerateButtonsState(false); return;
      }
      if (!characters[characterName]) {
          showCustomAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${characterName}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
          isBotGenerating = false; updateRegenerateButtonsState(false); return;
      }

      const charData = characters[characterName];
      let lastUserMessageForContext = "";
      let lastUserMessageAttachments = null;
      for (let i = currentGroupMessages.length -1; i >= 0; i--) {
          if ((currentGroupMessages[i].sender === "–í—ã" || currentGroupMessages[i].role === "user")) {
              lastUserMessageForContext = currentGroupMessages[i].content;
              lastUserMessageAttachments = currentGroupMessages[i].attachments;
              break;
          }
      }

      const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
      const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;
      const systemPromptText = getSystemContent(charData, lastUserMessageForContext);


      if (useGoogleApi && googleApiKey && googleApiModel) {
        let geminiContents = [];
        currentGroupMessages.forEach(m => {
            let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
            let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender) ? `${m.sender}: ${m.content}` : m.content;

            let parts = [];
            if (textContent) parts.push({ text: textContent });
            if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                 m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                    parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                 });
            } else if (m.attachments) {
                parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
            }

            if (parts.length > 0) {
                 if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                     console.warn("Consecutive roles for Gemini (respondToLast), appending parts:", role);
                     geminiContents[geminiContents.length - 1].parts.push(...parts);
                 } else {
                    geminiContents.push({ role: role, parts: parts });
                 }
            }
        });
        let lastValidRoleGroup = null;
        geminiContents = geminiContents.filter(item => {
            if (item.role === lastValidRoleGroup) return false;
            lastValidRoleGroup = item.role;
            return true;
        });

        await fetchGeminiChatCompletion(
            googleApiKey, googleApiModel, systemPromptText, geminiContents,
            temperature, max_tokens, characterName, allMessages, charData.avatarCharacter
        );

      } else {
        const model = charData.model || document.getElementById("model").value;
        const apiKey = document.getElementById("apiKey").value;
        const apiUrl = document.getElementById("apiUrl").value;
        const messagesForAPI = [
          { role: "system", content: systemPromptText },
          ...currentGroupMessages.map(m => {
              let apiContentArray = [];
              if (m.content) apiContentArray.push({ type: "text", text: m.content });
              if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                   m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        apiContentArray.push({ type: "image_url", image_url: { url: att.src } });
                   });
              } else if (m.attachments) {
                  apiContentArray.push({ type: "text", text: ` [–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
              }

              const finalContent = apiContentArray.length === 1 && apiContentArray[0].type === "text" ? apiContentArray[0].text : apiContentArray;
              return {
                  role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                  content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender) ? `${m.sender}: ${finalContent}` : finalContent
              }
          })
        ];
        await fetchChatCompletion(apiUrl, apiKey, model, messagesForAPI, temperature, max_tokens, characterName, allMessages, charData.avatarCharacter);
      }
    }


    async function sendMessage() {
        if (isBotGenerating && !useRestApi && !(useGoogleApi && googleApiKey && googleApiModel) ) {
            return;
        }

        const messageContent = userInput.value.trim();
        if (!messageContent && attachedFiles.length === 0) return;

        clearVariants();
        const originalPlaceholder = userInput.placeholder;
        userInput.value = "";
        userInput.placeholder = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
        userInput.disabled = true;
        userInput.style.height = 'auto';
        userInput.style.height = (userInput.scrollHeight) + 'px';


        let userAvatarUrl;
        let activeCharNameForUserMsg = getCurrentCharacterName();
        let attachmentsDataArray = [];

        if (attachedFiles.length > 0) {
            for (const file of attachedFiles) {
                 attachmentsDataArray.push({
                    name: file.name,
                    type: file.type,
                    src: await readFileAsDataURL(file)
                });
            }
        }

        const userMsgObject = {
            role: "user",
            content: messageContent,
            attachments: attachmentsDataArray.length > 0 ? attachmentsDataArray : null
        };

        if (currentMode === "personal") {
            if (!activeCharNameForUserMsg) {
                showCustomAlert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.");
                userInput.placeholder = originalPlaceholder; userInput.disabled = false; userInput.focus(); return;
            }
            userAvatarUrl = characters[activeCharNameForUserMsg]?.avatarUser || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
            userMsgObject.avatar = userAvatarUrl;
            allMessages.push(userMsgObject);
            saveChat(activeCharNameForUserMsg, allMessages);
        } else {
            const anyUserAvatar = Object.values(characters).find(c => c.avatarUser)?.avatarUser;
            userAvatarUrl = anyUserAvatar || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
            userMsgObject.sender = "–í—ã";
            userMsgObject.avatar = userAvatarUrl;
            allMessages.push(userMsgObject);
            saveRoomChat(allMessages);
        }

        appendNewMessageToDOM(userMsgObject, allMessages.length - 1);
        shouldScrollToBottom = true;

        attachedFiles = [];
        renderFilePreviews();
        document.getElementById("fileInput").value = "";

        const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
        const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;

        let charToRespondName, charDataForApi, systemContextMsgForLLM;
        if (currentMode === "personal") {
            charToRespondName = activeCharNameForUserMsg;
            charDataForApi = characters[charToRespondName];
            systemContextMsgForLLM = messageContent;
        } else {
            let lastBotSender = null;
            for (let i = allMessages.length - 2; i >= 0; i--) {
                if (allMessages[i].role === 'assistant' && allMessages[i].sender && characters[allMessages[i].sender]) {
                    lastBotSender = allMessages[i].sender; break;
                }
            }
            charToRespondName = lastBotSender || (Object.keys(characters).length > 0 ? Object.keys(characters)[0] : null);
            if (!charToRespondName || !characters[charToRespondName]) {
                const sysMsg = {sender:"–°–∏—Å—Ç–µ–º–∞", content:"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ.", role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
                allMessages.push(sysMsg); appendNewMessageToDOM(sysMsg, allMessages.length - 1);
                userInput.placeholder = originalPlaceholder; userInput.disabled = false; userInput.focus(); return;
            }
            charDataForApi = characters[charToRespondName];
            systemContextMsgForLLM = messageContent;
        }

        const systemPromptText = getSystemContent(charDataForApi, systemContextMsgForLLM);

        if (useGoogleApi && googleApiKey && googleApiModel) {
            isBotGenerating = true;
            updateRegenerateButtonsState(true);
            setStatusActive(true);
            shouldScrollToBottom = true;

            let geminiContents = [];
            allMessages.forEach(m => {
                let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
                let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${m.content}` : m.content;

                let parts = [];
                if (textContent) parts.push({ text: textContent });
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                     m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                     });
                } else if (m.attachments) {
                    parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }


                if (parts.length > 0) {
                    if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                        console.warn("Consecutive roles for Gemini (send), appending parts:", role);
                         geminiContents[geminiContents.length - 1].parts.push(...parts);
                    } else {
                        geminiContents.push({ role: role, parts: parts });
                    }
                }
            });
            let lastValidRoleSend = null;
            geminiContents = geminiContents.filter(item => {
                if (item.role === lastValidRoleSend) return false;
                lastValidRoleSend = item.role;
                return true;
            });


            await fetchGeminiChatCompletion(
                googleApiKey, googleApiModel, systemPromptText, geminiContents,
                temperature, max_tokens, charToRespondName, allMessages, charDataForApi.avatarCharacter
            );


        } else if (useRestApi && restApiUrlValue) {
            shouldScrollToBottom = true;
            await sendToRestApi(messageContent, attachmentsDataArray);
        } else {
            isBotGenerating = true;
            updateRegenerateButtonsState(true);
            setStatusActive(true);
            shouldScrollToBottom = true;

            let messagesForAPI = [{ role: "system", content: systemPromptText }];
            messagesForAPI.push(...allMessages.map(m => {
                let apiMsgContentArray = [];
                if (m.content) apiMsgContentArray.push({ type: "text", text: m.content });
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                     m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        apiMsgContentArray.push({ type: "image_url", image_url: { url: att.src } });
                     });
                } else if (m.attachments) {
                    apiMsgContentArray.push({ type: "text", text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }

                const finalContent = apiMsgContentArray.length === 1 && apiMsgContentArray[0].type === "text" ? apiMsgContentArray[0].text : apiMsgContentArray;
                return {
                    role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                    content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${finalContent}` : finalContent
                };
            }));

            const apiKey = document.getElementById("apiKey").value;
            const apiUrl = document.getElementById("apiUrl").value;
            const modelForApi = charDataForApi.model || document.getElementById("model").value;

            await fetchChatCompletion(apiUrl, apiKey, modelForApi, messagesForAPI, temperature, max_tokens, charToRespondName, allMessages, charDataForApi.avatarCharacter);
        }
        userInput.placeholder = originalPlaceholder; userInput.disabled = false;
        userInput.focus(); // Keep focus on the input field
    }

    async function fetchGeminiChatCompletion(gApiKey, gModel, systemInstructionText, geminiContents, temperature, maxOutputTokens, apiCharacterName, chatArrayToUpdateRef, botAvatarUrl, isAfterEdit = false) {
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${gModel}:generateContent?key=${gApiKey}`;

        const requestBody = {
            systemInstruction: { parts: [{ text: systemInstructionText }] },
            contents: geminiContents,
            generationConfig: {
                temperature: temperature,
                maxOutputTokens: maxOutputTokens
            }
        };

        setStatusActive(true);

        const placeholderMsgData = { content: "...", role: "assistant", avatar: botAvatarUrl, attachments: null };
        if (currentMode === "group") {
            placeholderMsgData.sender = apiCharacterName;
        }

        let placeholderIndex = -1;
        if (!isAfterEdit) {
            chatArrayToUpdateRef.push(placeholderMsgData);
            placeholderIndex = chatArrayToUpdateRef.length - 1;
            appendNewMessageToDOM(placeholderMsgData, placeholderIndex);
        } else {
             chatArrayToUpdateRef.push(placeholderMsgData);
             placeholderIndex = chatArrayToUpdateRef.length - 1;
             appendNewMessageToDOM(placeholderMsgData, placeholderIndex);
        }


        try {
            const response = await fetch(geminiApiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`Google API –û—à–∏–±–∫–∞: ${response.status} - ${errorBody}`);
            }
            const result = await response.json();
            const reply = result.candidates?.[0]?.content?.parts?.[0]?.text || "";

            if (!reply && !(result.candidates && result.candidates[0].finishReason === "MAX_TOKENS")) {
                 throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Google API –∏–ª–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
            }

            chatArrayToUpdateRef[placeholderIndex].content = reply;
            chatArrayToUpdateRef[placeholderIndex].attachments = null;
            if (currentMode === "group") {
                 chatArrayToUpdateRef[placeholderIndex].sender = apiCharacterName;
            }

            updateMessageInDOM(placeholderIndex, chatArrayToUpdateRef[placeholderIndex]);
            scrollToBottom(true);
            shouldScrollToBottom = false;

            if (currentMode === "personal") saveChat(getCurrentCharacterName(), chatArrayToUpdateRef);
            else saveRoomChat(chatArrayToUpdateRef);

        } catch (err) {
            console.error("fetchGeminiChatCompletion –û—à–∏–±–∫–∞:", err);
            if (chatArrayToUpdateRef[placeholderIndex] && chatArrayToUpdateRef[placeholderIndex].content === "...") {
                chatArrayToUpdateRef.splice(placeholderIndex, 1);
                removeMessageFromDOM(placeholderIndex);
            }
            const errorMsgData = {sender:"–°–∏—Å—Ç–µ–º–∞", content:`–û—à–∏–±–∫–∞ Google Gemini API: ${err.message}`, role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
            chatArrayToUpdateRef.push(errorMsgData);
            appendNewMessageToDOM(errorMsgData, chatArrayToUpdateRef.length - 1);
        } finally {
            setStatusActive(false);
            isBotGenerating = false;
            updateRegenerateButtonsState(false);
            if (shouldScrollToBottom) { scrollToBottom(true); shouldScrollToBottom = false; }
            userInput.focus();
        }
    }


    async function fetchChatCompletion(apiUrl, apiKey, model, messagesForAPI, temperature, max_tokens, apiCharacterName, chatArrayToUpdateRef, botAvatarUrl, isAfterEdit = false) {
      const requestBody = { model, messages: messagesForAPI, stream: true, max_tokens, temperature };
      setStatusActive(true);
      shouldScrollToBottom = true;

      const placeholderMsgData = { content: "...", role: "assistant", avatar: botAvatarUrl, attachments: null };
      if (currentMode === "group") {
          placeholderMsgData.sender = apiCharacterName;
      }

      chatArrayToUpdateRef.push(placeholderMsgData);
      const placeholderIndex = chatArrayToUpdateRef.length - 1;
      appendNewMessageToDOM(placeholderMsgData, placeholderIndex);

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
          body: JSON.stringify(requestBody)
        });
        if (!response.ok) throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status} ${await response.text()}`);

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let reply = "", streamedContent = "";

        const streamingMessageContainer = messagesBox.querySelector(`.message-container[data-index="${placeholderIndex}"]`);
        const streamingMessageDiv = streamingMessageContainer?.querySelector(".message");


        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split("\n").filter(line => line.trim().startsWith("data: "));
          for (const line of lines) {
            if (line.includes("[DONE]")) break;
            const jsonString = line.replace(/^data: /, "");
            try {
              const parsed = JSON.parse(jsonString);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                streamedContent += content;
                reply = removeThoughts(streamedContent);
                if (streamingMessageDiv) {
                  streamingMessageDiv.innerHTML = `<strong>${apiCharacterName}:</strong>${marked.parse(reply)}`;
                  scrollToBottom(true);
                }
              }
            } catch (e) { /* console.warn("Stream parsing error:", e, jsonString); */ }
          }
        }
        if (!reply && streamedContent) reply = removeThoughts(streamedContent);

        chatArrayToUpdateRef[placeholderIndex].content = reply;
        chatArrayToUpdateRef[placeholderIndex].attachments = null;
        if (currentMode === "group") {
            chatArrayToUpdateRef[placeholderIndex].sender = apiCharacterName;
        }

        if (!streamingMessageDiv) {
            updateMessageInDOM(placeholderIndex, chatArrayToUpdateRef[placeholderIndex]);
        }

        if (currentMode === "personal") saveChat(getCurrentCharacterName(), chatArrayToUpdateRef);
        else saveRoomChat(chatArrayToUpdateRef);


      } catch (err) {
        console.error("fetchChatCompletion –û—à–∏–±–∫–∞:", err);
        if (chatArrayToUpdateRef[placeholderIndex] && chatArrayToUpdateRef[placeholderIndex].content === "...") {
            chatArrayToUpdateRef.splice(placeholderIndex, 1);
            removeMessageFromDOM(placeholderIndex);
        }
        const errorMsgData = {sender:"–°–∏—Å—Ç–µ–º–∞", content:`–û—à–∏–±–∫–∞ LLM: ${err.message}`, role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
        chatArrayToUpdateRef.push(errorMsgData);
        appendNewMessageToDOM(errorMsgData, chatArrayToUpdateRef.length - 1);

      } finally {
        setStatusActive(false);
        isBotGenerating = false;
        updateRegenerateButtonsState(false);
        if (shouldScrollToBottom) { scrollToBottom(true); shouldScrollToBottom = false; }
      }
    }


    function removeThoughts(text) { return text.replace(/<think>[\s\S]*?<\/think>/g, '').trim(); }

    function clearMessages() {
      showCustomConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.", () => {
        let initialMessages = [];
        if (currentMode === "personal") {
          const name = getCurrentCharacterName();
          if (!name) return;
          const charData = characters[name];
          if (charData && charData.welcomeMessage) {
              initialMessages.push({ role: "assistant", content: charData.welcomeMessage, avatar: charData.avatarCharacter, attachments: null });
          }
          saveChat(name, initialMessages);
        } else {
          saveRoomChat(initialMessages);
        }
        shouldScrollToBottom = true;
        loadAndRenderMessages();
        clearVariants();
      });
    }

    function exportCharacterData() {
      const name = getCurrentCharacterName();
      if (!name || !characters[name]) return showCustomAlert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");

      const charData = characters[name];
      const chatHistory = loadChat(name);

      const dataToExport = {
        spec: "chara_card_v2",
        spec_version: "2.0",
        data: {
            name: charData.name || "",
            description: charData.description || "",
            personality: charData.personality || "",
            scenario: charData.scenario || "",
            first_mes: charData.welcomeMessage || "",
            mes_example: charData.mes_example || "",
            creator_notes: charData.creator_notes || "",
            system_prompt: charData.system_prompt || "",
            post_history_instructions: charData.post_history_instructions || "",
            alternate_greetings: charData.alternate_greetings || [],
            tags: [], // Tags not implemented in UI yet
            creator: "", // Creator not implemented in UI yet
            character_version: "", // Version not implemented in UI yet
            avatar: "none", // Placeholder, actual avatar is in our app's format
            extensions: {}
        }
      };

      const fullExportData = {
          character: charData,
          messages: chatHistory,
          version: "2.0",
          format: "llm_chatbot_rp_v3_full",
          tavern_card: dataToExport
      };

      const blob = new Blob([JSON.stringify(fullExportData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `${name}_–ø–µ—Ä—Å–æ–Ω–∞–∂_–∏_—á–∞—Ç.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showCustomAlert(`–î–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${name}" –∏ –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.`);
    }

    function importCharacterData() { document.getElementById("jsonFileInput").click(); }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedJson = JSON.parse(e.target.result);
          let charDataToProcess;

          // Check for our app's full format first
          if (importedJson.format === "llm_chatbot_rp_v3_full" && importedJson.character) {
              console.log("Importing llm_chatbot_rp_v3_full format");
              charDataToProcess = {
                  character: importedJson.character,
                  messages: importedJson.messages || [],
              };
          }
          // Then check for standard TavernAI/Chub format
          else if (importedJson.spec === "chara_card_v2" && importedJson.data) {
            console.log("Importing chara_card_v2 format");
            const tavernData = importedJson.data;
            charDataToProcess = {
              character: {
                name: tavernData.name || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π",
                description: tavernData.description || "",
                personality: tavernData.personality || "",
                scenario: tavernData.scenario || "",
                mes_example: tavernData.mes_example || "",
                welcomeMessage: tavernData.first_mes || "",
                alternate_greetings: tavernData.alternate_greetings || [],
                system_prompt: tavernData.system_prompt || "",
                post_history_instructions: tavernData.post_history_instructions || "",
                creator_notes: tavernData.creator_notes || "",
                avatarCharacter: tavernData.avatar || "https://placehold.co/100x100/FF7AAC/FFFFFF?text=–ë–æ—Ç", // Use TavernAI avatar or default
                avatarUser: document.getElementById("avatarUrl_user").value || "https://placehold.co/100x100/7AC5FF/FFFFFF?text=–í—ã",
                model: document.getElementById("characterModel").value || document.getElementById("model").value,
                lorebook: [],
              },
              messages: [],
              _tavernData: tavernData // Keep original data for reference
            };

            if (tavernData.character_book && tavernData.character_book.entries) {
                charDataToProcess.character.lorebook = tavernData.character_book.entries.map(entry => ({
                    entryName: entry.name || "",
                    triggers: entry.keys || [],
                    info: entry.content || ""
                })).filter(lbEntry => (lbEntry.triggers.length > 0 && lbEntry.info) || lbEntry.entryName);
            }
          } else {
            throw new Error("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ JSON.");
          }

          tempImportedCharacterData = charDataToProcess;

          if (charDataToProcess._tavernData) {
            const greetings = [];
            if (charDataToProcess._tavernData.first_mes) greetings.push(charDataToProcess._tavernData.first_mes);
            if (charDataToProcess._tavernData.alternate_greetings && charDataToProcess._tavernData.alternate_greetings.length > 0) {
                greetings.push(...charDataToProcess._tavernData.alternate_greetings);
            }

            if (greetings.length > 1) {
                openGreetingModal(charDataToProcess.character.name, greetings); return;
            } else if (greetings.length === 1) {
                charDataToProcess.character.welcomeMessage = greetings[0];
            }
          }
          finalizeImport(charDataToProcess);

        } catch (err) {
          showCustomAlert(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞: ${err.message}`); console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", err);
          tempImportedCharacterData = null;
        } finally {
            event.target.value = null;
        }
      };
      reader.readAsText(file);
    }

    function finalizeImport(dataToImport) {
        if (!dataToImport || !dataToImport.character) {
            console.error("–î–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ–ø–æ–ª–Ω—ã–µ.");
            showCustomAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–º–ø–æ—Ä—Ç, –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ.");
            return;
        }
        const charData = dataToImport.character;
        const charName = charData.name;

        // Ensure all fields exist on the object to prevent errors
        const fullCharData = {
          name: charName,
          description: charData.description || "",
          personality: charData.personality || "",
          scenario: charData.scenario || "",
          mes_example: charData.mes_example || "",
          welcomeMessage: charData.welcomeMessage || "",
          alternate_greetings: charData.alternate_greetings || [],
          system_prompt: charData.system_prompt || "",
          post_history_instructions: charData.post_history_instructions || "",
          creator_notes: charData.creator_notes || "",
          model: charData.model || document.getElementById("model").value,
          avatarCharacter: charData.avatarCharacter || "https://placehold.co/100x100/FF7AAC/FFFFFF?text=–ë–æ—Ç",
          avatarUser: charData.avatarUser || document.getElementById("avatarUrl_user").value || "https://placehold.co/100x100/7AC5FF/FFFFFF?text=–í—ã",
          lorebook: charData.lorebook || [],
          backgroundImage: charData.backgroundImage || null
        };

        characters[charName] = fullCharData;
        saveChat(charName, dataToImport.messages || []);
        localStorage.setItem("characters_v3", JSON.stringify(characters));

        populateCharacterSelect();
        setActiveCharacter(charName);
        document.getElementById("characterSelect").value = charName;

        showCustomAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${charName}" —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
        closeSettingsModal();
        tempImportedCharacterData = null;
    }


    function setupFileAttach() {
        const hiddenFileInput = document.getElementById("fileInput");
        if(hiddenFileInput) {
            hiddenFileInput.addEventListener("change", (event) => {
                if (event.target.files.length > 0) {
                    Array.from(event.target.files).forEach(file => attachedFiles.push(file));
                    renderFilePreviews();
                    userInput.placeholder = `${attachedFiles.length} —Ñ–∞–π–ª(–æ–≤) –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ.`;
                }
                event.target.value = null;
            });
        }
    }

    function renderFilePreviews() {
        filePreviewsContainer.innerHTML = "";
        if (attachedFiles.length === 0) {
            filePreviewsContainer.style.display = "none";
            if (!userInput.value.trim()) {
                 userInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
            }
            return;
        }
        filePreviewsContainer.style.display = "flex";

        attachedFiles.forEach((file, index) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'file-preview-item';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = '–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                attachedFiles.splice(index, 1);
                renderFilePreviews();
                 if (attachedFiles.length > 0) {
                    userInput.placeholder = `${attachedFiles.length} —Ñ–∞–π–ª(–æ–≤) –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ.`;
                } else if (!userInput.value.trim()) {
                     userInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
                }
            };
            previewItem.appendChild(removeBtn);

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => URL.revokeObjectURL(img.src);
                previewItem.appendChild(img);
            } else {
                const icon = document.createElement('div');
                icon.className = 'file-icon-placeholder';
                icon.textContent = 'üìÑ';
                previewItem.appendChild(icon);
            }
            const fileName = document.createElement('div');
            fileName.className = 'file-info';
            fileName.textContent = file.name;
            fileName.title = file.name;
            previewItem.appendChild(fileName);

            filePreviewsContainer.appendChild(previewItem);
        });
    }


    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }


    function renderLorebookEntries(characterName) {
      const container = document.getElementById("lorebookEntries");
      container.innerHTML = "";
      const character = characters[characterName];
      if (!character || !character.lorebook || character.lorebook.length === 0) {
        container.innerHTML = "<p style='font-style:italic; opacity:0.7;'>–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</p>"; return;
      }
      character.lorebook.forEach((entry, index) => {
        const entryDiv = document.createElement("div");
        entryDiv.className = "lorebook-entry";
        entryDiv.innerHTML = `
          <div>
            <label for="lore-entryName-${index}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–ò–º—è):</label>
            <input type="text" id="lore-entryName-${index}" value="${entry.entryName || ""}" data-index="${index}" oninput="updateLorebookField(${index}, 'entryName', this.value)" />
          </div>
          <div>
            <label for="lore-triggers-${index}">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <input type="text" id="lore-triggers-${index}" value="${(entry.triggers || []).join(', ')}" data-index="${index}" oninput="updateLorebookField(${index}, 'triggers', this.value)" />
          </div>
          <div>
            <label for="lore-info-${index}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
            <textarea id="lore-info-${index}" data-index="${index}" oninput="updateLorebookField(${index}, 'info', this.value)">${entry.info || ""}</textarea>
          </div>
          <button type="button" onclick="deleteLorebookEntry(${index})" style="background: #ffcdd2; color:#5f2120; font-size:0.9rem; padding: 0.5rem 0.8rem;">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        `;
        container.appendChild(entryDiv);
      });
    }

    function updateLorebookField(index, field, value) {
        const charName = getCurrentCharacterName();
        if (!charName || !characters[charName] || !characters[charName].lorebook[index]) return;

        if (field === 'entryName') {
            characters[charName].lorebook[index].entryName = value.trim();
        } else if (field === 'triggers') {
            characters[charName].lorebook[index].triggers = value.split(',').map(t => t.trim()).filter(t => t);
        } else if (field === 'info') {
            characters[charName].lorebook[index].info = value.trim();
        }
        localStorage.setItem("characters_v2", JSON.stringify(characters));
    }

    function addLorebookEntry() {
      const charName = getCurrentCharacterName();
      if (!charName || !characters[charName]) return showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
      characters[charName].lorebook = characters[charName].lorebook || [];
      characters[charName].lorebook.push({ entryName: "", triggers: [], info: "" }); // Add new empty entry with entryName
      localStorage.setItem("characters_v2", JSON.stringify(characters));
      renderLorebookEntries(charName);
    }

    function deleteLorebookEntry(index) {
      const charName = getCurrentCharacterName();
      if (!charName || !characters[charName] || !characters[charName].lorebook) return;
      showCustomConfirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏–∑ Lorebook?", () => {
        characters[charName].lorebook.splice(index, 1);
        localStorage.setItem("characters_v2", JSON.stringify(characters));
        renderLorebookEntries(charName);
      });
    }

    function uploadBackground() {
      const name = getCurrentCharacterName(); // Get current character
      if (!name || !characters[name]) return showCustomAlert("–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      const fileInput = document.getElementById("backgroundFileInput");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          characters[name].backgroundImage = e.target.result; // Store as dataURL
          localStorage.setItem("characters_v2", JSON.stringify(characters)); // Save
          applyBackground(name); // Apply immediately
          closeBackgroundModal(); // Close modal
        };
        reader.readAsDataURL(file);
      } else {
        showCustomAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
      }
      fileInput.value = ""; // Reset file input
    }
    function deleteBackground() {
      const name = getCurrentCharacterName();
      if (!name || !characters[name]) return showCustomAlert("–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      delete characters[name].backgroundImage; // Remove property
      localStorage.setItem("characters_v2", JSON.stringify(characters)); // Save
      applyBackground(name); // Re-apply (will remove background)
      closeBackgroundModal();
    }

    function applyBackground(characterName) {
      const messagesDiv = document.querySelector('.messages');
      const chatContainerDiv = document.getElementById('chatContainer');
      const inputAreaContainer = document.querySelector('.input-area-container');

      if (!messagesDiv || !chatContainerDiv || !inputAreaContainer) return;

      const character = characterName ? characters[characterName] : null;
      const backgroundImage = character?.backgroundImage;

      if (backgroundImage && currentMode === "personal") {
        chatContainerDiv.style.backgroundImage = `url(${backgroundImage})`;
        chatContainerDiv.style.backgroundSize = 'cover';
        chatContainerDiv.style.backgroundPosition = 'center';
        chatContainerDiv.style.backgroundRepeat = 'no-repeat';
        chatContainerDiv.classList.add('chat-container-custom-bg'); // Add class to adjust padding

        messagesDiv.classList.add('has-custom-background');
        inputAreaContainer.classList.add('has-custom-background-too');
      } else {
        chatContainerDiv.style.backgroundImage = 'none';
        chatContainerDiv.classList.remove('chat-container-custom-bg'); // Remove class to revert padding

        messagesDiv.classList.remove('has-custom-background');
        inputAreaContainer.classList.remove('has-custom-background-too');
      }
    }


    function setupAvatarClickHandler() {
      document.addEventListener('click', function(e) {
        const targetElement = e.target;
        // Check if clicked on an avatar in a message, or an attached image in a message, or an image in file preview
        if (targetElement.classList.contains('avatar')) {
          const avatarSrc = targetElement.src;
          previewImage(avatarSrc);
        }
        else if (targetElement.classList.contains('attached-image')) { // Image inside a message bubble
          const imageSrc = targetElement.src;
          previewImage(imageSrc);
        }
        else if (targetElement.tagName === 'IMG' && targetElement.closest('.file-preview-item')) { // Image in the file preview area before sending
             const imageSrc = targetElement.src;
             previewImage(imageSrc);
        }
      });
    }

    function previewImage(src) {
        // Remove existing modal if any
        const existingModal = document.querySelector('.avatar-preview-modal');
        if (existingModal) document.body.removeChild(existingModal);

        const modal = document.createElement('div');
        modal.className = 'avatar-preview-modal';
        // Basic styling for the modal (overlay)
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.8)'; // Dark overlay
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '2000'; // High z-index to be on top
        modal.style.cursor = 'zoom-out'; // Indicate it can be closed by clicking
        // Image styling within the modal
        modal.innerHTML = `
            <img src="${src}" style="max-width:90vw; max-height:90vh; object-fit:contain; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.5);" />
        `;
        // Close modal on click
        modal.addEventListener('click', () => document.body.removeChild(modal));
        document.body.appendChild(modal);
    }


    function setupScrollHandler() {
      messagesBox.addEventListener("scroll", () => {
        // If user scrolls up, disable auto-scroll to bottom
        const nearBottom = messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 100;
        if (!nearBottom) {
            shouldScrollToBottom = false; // User has scrolled away from the bottom
        }
        // Auto-scroll is re-enabled when a new message is sent or bot responds (by setting shouldScrollToBottom = true)
      });
    }

    function showCustomAlert(message) {
        const messageBox = document.createElement('div');
        messageBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--accent-color);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
            z-index: 3000;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
        `;
        messageBox.textContent = message;
        document.body.appendChild(messageBox);
        setTimeout(() => {
            messageBox.style.opacity = 1;
        }, 10); // Small delay to trigger transition
        setTimeout(() => {
            messageBox.style.opacity = 0;
            messageBox.addEventListener('transitionend', () => messageBox.remove());
        }, 2000); // Disappear after 2 seconds
    }

    
function showCustomConfirm(message, onConfirm) {
        // Prevent multiple confirm boxes stacking
        if (document.querySelector('.custom-confirm-overlay')) {
            // If one exists, optionally bring it to front (do nothing)
            return;
        }
        // Create an overlay to host the confirm box (so IDs inside won't clash)
        const overlay = document.createElement('div');
        overlay.className = 'custom-confirm-overlay';
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2999;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        // Create confirm box inside overlay
        const confirmBox = document.createElement('div');
        confirmBox.className = 'custom-confirm-box';
        confirmBox.style.cssText = `
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 3000;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            max-width: 95%;
            box-sizing: border-box;
        `;
        confirmBox.innerHTML = `
            <div style="margin-bottom:12px; white-space:pre-wrap;">${message}</div>
            <div style="display:flex; gap:0.6rem; justify-content:flex-end;">
                <button type="button" data-confirm="no" style="padding:0.6rem 0.9rem; border-radius:8px; background:transparent; border:1px solid rgba(var(--accent-color-rgb),0.12); color:var(--text-color);">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" data-confirm="yes" style="padding:0.6rem 0.9rem; border-radius:8px; background:var(--accent-gradient); color:#fff; border: none;">–î–∞</button>
            </div>
        `;
        overlay.appendChild(confirmBox);
        document.body.appendChild(overlay);

        // Prevent clicks from propagating to underlying UI
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                // clicking outside will close the dialog
                overlay.remove();
            }
        });

        // Buttons
        const btnYes = confirmBox.querySelector('[data-confirm="yes"]');
        const btnNo = confirmBox.querySelector('[data-confirm="no"]');

        // Helper to cleanup
        const cleanup = () => {
            try { overlay.remove(); } catch (e) {}
        };

        btnYes.addEventListener('click', (e) => {
            e.stopPropagation();
            // Disable to prevent double clicks
            btnYes.disabled = true;
            if (typeof onConfirm === 'function') {
                try { onConfirm(); } catch (err) { console.error(err); }
            }
            cleanup();
        });

        btnNo.addEventListener('click', (e) => {
            e.stopPropagation();
            cleanup();
        });

        // Accessibility: focus yes button
        btnYes.focus();
    }



    function setStatusActive(active) {
      const currentStatusIndicator = document.getElementById("messages-status-indicator");
      // The mobile prefix container and its cloned indicator might not always exist if the DOM structure changes.
      // It's safer to query for it within the mobile prefix div if it's consistently there.
      const mobilePrefixDiv = mainInputRow.querySelector('.mobile-input-prefix');
      const clonedStatusIndicator = mobilePrefixDiv ? mobilePrefixDiv.querySelector('#messages-status-indicator') : null;


      if (currentStatusIndicator) {
        currentStatusIndicator.classList.toggle("active", active);
        currentStatusIndicator.title = active ? "–ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞..." : "–ù–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      }
      if (clonedStatusIndicator) { // Also update the cloned indicator if it exists (for mobile view)
        clonedStatusIndicator.classList.toggle("active", active);
        clonedStatusIndicator.title = active ? "–ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞..." : "–ù–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      }
    }

  </script>
<script>
// Original (PC) settings content (from original file)
if (typeof window.originalSettingsHTML === 'undefined') {
  window.originalSettingsHTML = `
<fieldset class="fieldset-span-1"> <legend>üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</legend>
<label for="apiKey">–ö–ª—é—á API (LLM):</label>
<input aria-label="–ö–ª—é—á API LLM" autocomplete="off" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á" type="password"/>
<label for="apiUrl">URL API LLM:</label>
<input aria-label="URL LLM API" id="apiUrl" type="text" value="https://openrouter.ai/api/v1/chat/completions"/>
<label for="model">–ú–æ–¥–µ–ª—å LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):</label>
<input aria-label="–ú–æ–¥–µ–ª—å LLM" id="model" readonly="" type="text" value="deepseek/deepseek-r1-0528:free"/>
<label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0-1):</label>
<input aria-label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ LLM" id="temperature" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 0.7" step="0.1" type="number" value="0.7"/>
<label for="maxTokens">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤:</label>
<input aria-label="–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ LLM" id="maxTokens" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1024" type="number" value="1024"/>
</fieldset>
<fieldset class="fieldset-span-1">
<legend>üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</legend>
<label for="googleApiKey">–ö–ª—é—á Google API:</label>
<input aria-label="–ö–ª—é—á Google API" autocomplete="off" id="googleApiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Google API –∫–ª—é—á" type="password"/>
<label for="googleApiModel">–ú–æ–¥–µ–ª—å Google Gemini:</label>
<select aria-label="–ú–æ–¥–µ–ª—å Google Gemini" id="googleApiModel"></select>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableGoogleApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Gemini API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å Google Gemini API" id="enableGoogleApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset>
<fieldset>
<legend>üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</legend>
<label for="restApiUrl">URL REST API:</label>
<input aria-label="URL REST API" id="restApiUrl" placeholder="URL –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ REST API" type="text"/>
<label for="restApiHeaders">–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON):</label>
<textarea aria-label="–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON)" id="restApiHeaders" placeholder='–ü—Ä–∏–º–µ—Ä: {"Authorization": "Bearer –í–ê–®_–¢–û–ö–ï–ù"}'></textarea>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableRestApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REST API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å REST API" id="enableRestApi" type="checkbox">
<span class="slider round"></span>
</input></label>
</div>
</fieldset>
<fieldset>
<legend>üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</legend>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
<div>
<label for="characterSelect">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<select aria-label="–í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" disabled="" id="characterSelect"></select>
</div>
<div>
<label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<input aria-label="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
</div>
<label for="characterModel">–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è):</label>
<input aria-label="–ú–æ–¥–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, gpt-4-turbo –∏–ª–∏ –º–æ–¥–µ–ª—å Gemini" type="text"/>
</fieldset>
<fieldset>
<legend>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</legend>
<label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–≤–Ω–µ—à–Ω–æ—Å—Ç—å, —Ä–æ–ª—å, —Ü–µ–ª–∏):</label>
<textarea aria-label="–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏..." style="min-height: 140px;"></textarea>
<label for="personality">–õ–∏—á–Ω–æ—Å—Ç—å (—á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞):</label>
<textarea aria-label="–õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="personality" placeholder="–õ–∏—á–Ω–æ—Å—Ç—å, –º–∞–Ω–µ—Ä–∞ —Ä–µ—á–∏, –ø–æ–≤–µ–¥–µ–Ω–∏–µ..."></textarea>
</fieldset>
<fieldset>
<legend>üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</legend>
<label for="scenario">–°—Ü–µ–Ω–∞—Ä–∏–π (–º–∏—Ä, –æ–∫—Ä—É–∂–µ–Ω–∏–µ):</label>
<textarea aria-label="–°—Ü–µ–Ω–∞—Ä–∏–π" id="scenario" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞, —Å–∏—Ç—É–∞—Ü–∏–∏, —Å–µ—Ç—Ç–∏–Ω–≥–∞..."></textarea>
<label for="mes_example">–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:</label>
<textarea aria-label="–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞" id="mes_example" placeholder="&lt;START&gt;\\n–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∏–ª—è..." style="min-height: 140px;"></textarea>
</fieldset>
<fieldset>
<legend>üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</legend>
<label for="welcomeMessage">–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:</label>
<textarea aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" id="welcomeMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —á–∞—Ç–∞"></textarea>
<!-- REMOVED: Alternative Greetings Input Field -->
</fieldset>
<fieldset>
<legend>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</legend>
<label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
<textarea aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç" id="system_prompt" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò (system prompt)"></textarea>
<label for="post_history_instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏:</label>
<textarea aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏" id="post_history_instructions" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"></textarea>
<label for="creator_notes">–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:</label>
<textarea aria-label="–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è" id="creator_notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"></textarea>
</fieldset>
<fieldset class="fieldset-span-1">
<legend>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</legend>
<div>
<label for="mainTextColor">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
<input aria-label="–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞" id="mainTextColor" type="color"/>
</div>
<div style="margin-top: 1rem;">
<label for="chatFontSize">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ: <span id="chatFontSizeIndicator">100%</span></label>
<input aria-label="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ" id="chatFontSize" max="1.5" min="0.8" step="0.05" type="range" value="1"/>
</div>
</fieldset>
<fieldset class="fieldset-span-1">
<legend>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</legend>
<div class="avatar-selection">
<button onclick="showAvatarOptions('link', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_character" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarUrl_character" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_character" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarFileInput_character" type="file"/>
</div>
<div class="avatar-selection" style="margin-top: 1rem;">
<button onclick="showAvatarOptions('link', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_user" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∞–≤–∞—Ç–∞—Ä" id="avatarUrl_user" placeholder="URL –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_user" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" id="avatarFileInput_user" type="file"/>
</div>
</fieldset>
<fieldset>
<legend>üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</legend>
<textarea aria-label="–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" class="memory-box" id="neuralMemory" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ..." spellcheck="true"></textarea>
</fieldset>
<div style="grid-column: span 2; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top:1rem;">
<button onclick="saveSettings()" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å</button>
<button onclick="clearMessages()" style="background: #ffcdd2; color:#5f2120;" type="button">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
<button onclick="exportCharacterData()" type="button">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
<button onclick="importCharacterData()" type="button">üì• –ò–º–ø–æ—Ä—Ç JSON</button>
<input accept=".json, .card" id="jsonFileInput" onchange="handleFileUpload(event)" style="display:none" type="file"/>
<button onclick="openLorebookModal()" type="button">üìö Lorebook</button>
<button onclick="openBackgroundModal()" type="button">üñºÔ∏è –§–æ–Ω —á–∞—Ç–∞</button>
</div>
`;
}

// Mobile (tabbed) settings content (from modified file)
const mobileSettingsHTML = `<div class="tab-buttons"><button class="active" onclick="openSettingsTab(1)" type="button">üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</button><button onclick="openSettingsTab(2)" type="button">üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</button><button onclick="openSettingsTab(3)" type="button">üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</button><button onclick="openSettingsTab(4)" type="button">üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</button><button onclick="openSettingsTab(5)" type="button">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</button><button onclick="openSettingsTab(6)" type="button">üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</button><button onclick="openSettingsTab(7)" type="button">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</button><button onclick="openSettingsTab(8)" type="button">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</button><button onclick="openSettingsTab(9)" type="button">üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</button><button onclick="openSettingsTab(10)" type="button">üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</button><button onclick="openSettingsTab(11)" type="button">üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</button></div><div class="tab-page active" id="settingsTab1"><fieldset class="fieldset-span-1"> <legend>üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</legend>
<label for="apiKey">–ö–ª—é—á API (LLM):</label>
<input aria-label="–ö–ª—é—á API LLM" autocomplete="off" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á" type="password"/>
<label for="apiUrl">URL API LLM:</label>
<input aria-label="URL LLM API" id="apiUrl" type="text" value="https://openrouter.ai/api/v1/chat/completions"/>
<label for="model">–ú–æ–¥–µ–ª—å LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):</label>
<input aria-label="–ú–æ–¥–µ–ª—å LLM" id="model" readonly="" type="text" value="deepseek/deepseek-r1-0528:free"/>
<label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0-1):</label>
<input aria-label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ LLM" id="temperature" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 0.7" step="0.1" type="number" value="0.7"/>
<label for="maxTokens">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤:</label>
<input aria-label="–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ LLM" id="maxTokens" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1024" type="number" value="1024"/>
</fieldset></div><div class="tab-page" id="settingsTab2"><fieldset class="fieldset-span-1">
<legend>üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</legend>
<label for="googleApiKey">–ö–ª—é—á Google API:</label>
<input aria-label="–ö–ª—é—á Google API" autocomplete="off" id="googleApiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Google API –∫–ª—é—á" type="password"/>
<label for="googleApiModel">–ú–æ–¥–µ–ª—å Google Gemini:</label>
<select aria-label="–ú–æ–¥–µ–ª—å Google Gemini" id="googleApiModel"></select>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableGoogleApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Gemini API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å Google Gemini API" id="enableGoogleApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset></div><div class="tab-page" id="settingsTab3"><fieldset>
<legend>üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</legend>
<label for="restApiUrl">URL REST API:</label>
<input aria-label="URL REST API" id="restApiUrl" placeholder="URL –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ REST API" type="text"/>
<label for="restApiHeaders">–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON):</label>
<textarea aria-label="–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON)" id="restApiHeaders" placeholder='–ü—Ä–∏–º–µ—Ä: {"Authorization": "Bearer –í–ê–®_–¢–û–ö–ï–ù"}'></textarea>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableRestApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REST API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å REST API" id="enableRestApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset></div><div class="tab-page" id="settingsTab4"><fieldset>
<legend>üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</legend>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
<div>
<label for="characterSelect">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<select aria-label="–í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" disabled="" id="characterSelect"></select>
</div>
<div>
<label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<input aria-label="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
</div>
<label for="characterModel">–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è):</label>
<input aria-label="–ú–æ–¥–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, gpt-4-turbo –∏–ª–∏ –º–æ–¥–µ–ª—å Gemini" type="text"/>
</fieldset></div><div class="tab-page" id="settingsTab5"><fieldset>
<legend>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</legend>
<label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–≤–Ω–µ—à–Ω–æ—Å—Ç—å, —Ä–æ–ª—å, —Ü–µ–ª–∏):</label>
<textarea aria-label="–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏..." style="min-height: 140px;"></textarea>
<label for="personality">–õ–∏—á–Ω–æ—Å—Ç—å (—á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞):</label>
<textarea aria-label="–õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="personality" placeholder="–õ–∏—á–Ω–æ—Å—Ç—å, –º–∞–Ω–µ—Ä–∞ —Ä–µ—á–∏, –ø–æ–≤–µ–¥–µ–Ω–∏–µ..."></textarea>
</fieldset></div><div class="tab-page" id="settingsTab6"><fieldset>
<legend>üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</legend>
<label for="scenario">–°—Ü–µ–Ω–∞—Ä–∏–π (–º–∏—Ä, –æ–∫—Ä—É–∂–µ–Ω–∏–µ):</label>
<textarea aria-label="–°—Ü–µ–Ω–∞—Ä–∏–π" id="scenario" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞, —Å–∏—Ç—É–∞—Ü–∏–∏, —Å–µ—Ç—Ç–∏–Ω–≥–∞..."></textarea>
<label for="mes_example">–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:</label>
<textarea aria-label="–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞" id="mes_example" placeholder="&lt;START&gt;\\n–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∏–ª—è..." style="min-height: 140px;"></textarea>
</fieldset></div><div class="tab-page" id="settingsTab7"><fieldset>
<legend>üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</legend>
<label for="welcomeMessage">–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:</label>
<textarea aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" id="welcomeMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —á–∞—Ç–∞"></textarea>
<!-- REMOVED: Alternative Greetings Input Field -->
</fieldset></div><div class="tab-page" id="settingsTab8"><fieldset>
<legend>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</legend>
<label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
<textarea aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç" id="system_prompt" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò (system prompt)"></textarea>
<label for="post_history_instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏:</label>
<textarea aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏" id="post_history_instructions" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"></textarea>
<label for="creator_notes">–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:</label>
<textarea aria-label="–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è" id="creator_notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"></textarea>
</fieldset></div><div class="tab-page" id="settingsTab9"><fieldset class="fieldset-span-1">
<legend>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</legend>
<div>
<label for="mainTextColor">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
<input aria-label="–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞" id="mainTextColor" type="color"/>
</div>
<div style="margin-top: 1rem;">
<label for="chatFontSize">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ: <span id="chatFontSizeIndicator">100%</span></label>
<input aria-label="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ" id="chatFontSize" max="1.5" min="0.8" step="0.05" type="range" value="1"/>
</div>
</fieldset></div><div class="tab-page" id="settingsTab10"><fieldset class="fieldset-span-1">
<legend>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</legend>
<div class="avatar-selection">
<button onclick="showAvatarOptions('link', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_character" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarUrl_character" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_character" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarFileInput_character" type="file"/>
</div>
<div class="avatar-selection" style="margin-top: 1rem;">
<button onclick="showAvatarOptions('link', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_user" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∞–≤–∞—Ç–∞—Ä" id="avatarUrl_user" placeholder="URL –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_user" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" id="avatarFileInput_user" type="file"/>
</div>
</fieldset></div><div class="tab-page" id="settingsTab11"><fieldset>
<legend>üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</legend>
<textarea aria-label="–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" class="memory-box" id="neuralMemory" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ..." spellcheck="true"></textarea>
</fieldset></div>`;

let _settingsLayoutIsMobile = null;
function applySettingsLayout() {
  const container = document.getElementById('settingsSection');
  if (!container) return;
  const nowIsMobile = window.innerWidth <= 900;

  // If layout mode didn't change (only height changed - e.g. keyboard), skip.
  if (_settingsLayoutIsMobile === nowIsMobile) return;

  // If user is actively editing inside settings, avoid swapping layout mid-edit.
  try {
    const active = document.activeElement;
    if (container.contains(active) && (['INPUT','TEXTAREA','SELECT'].includes(active.tagName) || active.isContentEditable)) {
      return;
    }
  } catch (e) { /* ignore */ }

  // Preserve values of inputs by id before replacing innerHTML.
  const fields = Array.from(container.querySelectorAll('input,textarea,select'));
  const saved = {};
  fields.forEach(f => {
    if (!f.id) return;
    saved[f.id] = { value: f.value, checked: f.checked, selectedIndex: f.selectedIndex };
  });

  if (!nowIsMobile) {
    if (container.innerHTML.trim() !== originalSettingsHTML.trim()) {
      container.innerHTML = originalSettingsHTML;
    }
  } else {
    if (container.innerHTML.trim() !== mobileSettingsHTML.trim()) {
      container.innerHTML = mobileSettingsHTML;
    }
  }

  // Re-init bindings and mobile tabs if available
  if (typeof initMobileTabs === 'function') initMobileTabs();
  if (typeof initSettingsBindings === 'function') initSettingsBindings();

  // Try to restore saved values
  Object.keys(saved).forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      if (el.tagName === 'SELECT') el.selectedIndex = saved[id].selectedIndex;
      else if (el.type === 'checkbox' || el.type === 'radio') el.checked = saved[id].checked;
      else el.value = saved[id].value;
    } catch (e) {}
  });

  // Ensure model select lists and character select are repopulated
  if (typeof populateGoogleApiModelSelect === 'function') populateGoogleApiModelSelect();
  if (typeof populateCharacterSelect === 'function') populateCharacterSelect();
  // loadSettings will refresh values from localStorage if available
  if (typeof loadSettings === 'function') loadSettings();

  _settingsLayoutIsMobile = nowIsMobile;
}

// Run once on DOM ready, and on resize (debounced). Avoid swapping on small height changes.
window.addEventListener('DOMContentLoaded', function(){ applySettingsLayout(); });
window.addEventListener('resize', function(){
  clearTimeout(window._settingsResizeTimeout);
  window._settingsResizeTimeout = setTimeout(applySettingsLayout, 150);
});
</script>
<script>
function openSettingsTab(tabIndex) {
  const pages = document.querySelectorAll('.settings-content .tab-page');
  const buttons = document.querySelectorAll('.settings-content .tab-buttons button');
  pages.forEach((p, idx) => {
    p.classList.toggle('active', idx === tabIndex - 1);
  });
  buttons.forEach((b, idx) => {
    b.classList.toggle('active', idx === tabIndex - 1);
  });
  // scroll to top of modal to show content
  const modal = document.getElementById('settingsModal');
  if (modal) modal.scrollTop = 0;
}
</script>
<input accept=".json, .card" id="jsonFileInput" onchange="if(typeof handleFileUpload === 'function'){handleFileUpload(event);} else if(typeof importCharacterData === 'function'){importCharacterData(event)}" style="display:none" type="file"/>
<script>
// Ensure clearChat exists and works for both personal and group modes
function clearChat() {
  try {
    // Prefer using existing globals if present
    const mode = typeof currentMode !== 'undefined' ? currentMode : (document.getElementById('groupParticipants') ? 'group' : 'personal');
    if (mode === 'personal') {
      const name = typeof getCurrentCharacterName === 'function' ? getCurrentCharacterName() : (window.activeCharacter || null);
      if (!name) {
        if (typeof showCustomAlert === 'function') showCustomAlert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –≤—ã–±—Ä–∞–Ω.');
        return;
      }
      if (typeof getChatKey === 'function') {
        localStorage.setItem(getChatKey(name), JSON.stringify([]));
      } else {
        localStorage.setItem('chatHistory_v3_' + name, JSON.stringify([]));
      }
      if (typeof allMessages !== 'undefined') allMessages = [];
      if (typeof loadAndRenderMessages === 'function') {
        loadAndRenderMessages();
      } else {
        const messagesBox = document.getElementById('messages');
        if (messagesBox) messagesBox.innerHTML = '';
      }
    } else {
      // group/room mode
      const roomKey = typeof ROOM_HISTORY_KEY !== 'undefined' ? ROOM_HISTORY_KEY : 'room_history_v3';
      localStorage.setItem(roomKey, JSON.stringify([]));
      if (typeof allMessages !== 'undefined') allMessages = [];
      if (typeof loadAndRenderMessages === 'function') {
        loadAndRenderMessages();
      } else {
        const messagesBox = document.getElementById('messages');
        if (messagesBox) messagesBox.innerHTML = '';
      }
    }
    // give user feedback if function exists
    if (typeof showCustomAlert === 'function') showCustomAlert('–ß–∞—Ç –æ—á–∏—â–µ–Ω.');
  } catch (e) {
    console.error('clearChat error', e);
    if (typeof showCustomAlert === 'function') showCustomAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —á–∞—Ç–∞.');
  }
}
</script>
<div id="clearChatConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 1100; align-items:center; justify-content:center;">
<div class="settings-content" style="max-width:420px; width:90%; padding:1rem; text-align:center;">
<h3 style="margin-top:0;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É</h3>
<p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
<div style="display:flex; gap:0.5rem; justify-content:center; margin-top:1rem;">
<button onclick="confirmClearChat()" style="background:var(--accent-gradient);" type="button">–î–∞, –æ—á–∏—Å—Ç–∏—Ç—å</button>
<button onclick="closeClearChatConfirm()" style="background:var(--input-bg); color:var(--text-color); border:1px solid rgba(var(--accent-color-rgb),0.12);" type="button">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>
</div>
<script>
function openClearChatConfirm() {
  const modal = document.getElementById('clearChatConfirmModal');
  if(modal) modal.style.display = 'flex';
}
function closeClearChatConfirm() {
  const modal = document.getElementById('clearChatConfirmModal');
  if(modal) modal.style.display = 'none';
}
function confirmClearChat() {
  closeClearChatConfirm();
  if (typeof clearChat === 'function') {
    clearChat();
  } else {
    // fallback: try to clear via previous implementation
    try {
      const name = (typeof getCurrentCharacterName === 'function') ? getCurrentCharacterName() : (window.activeCharacter || null);
      if (name) {
        localStorage.setItem('chatHistory_v3_' + name, JSON.stringify([]));
      }
      if (typeof allMessages !== 'undefined') allMessages = [];
      if (typeof loadAndRenderMessages === 'function') loadAndRenderMessages();
      if (typeof showCustomAlert === 'function') showCustomAlert('–ß–∞—Ç –æ—á–∏—â–µ–Ω.');
    } catch (e) { console.error(e); }
  }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    var saved = localStorage.getItem(TEXT_COLOR_STORAGE);
    if(saved) {
      var main = document.getElementById('mainTextColor');
      if(main) main.value = saved;
      var mobile = document.getElementById('mainTextColor_mobile');
      if(mobile) mobile.value = saved;
      applyTextColor(saved);
    } else {
      var main = document.getElementById('mainTextColor');
      var mobile = document.getElementById('mainTextColor_mobile');
      if(main && mobile) {
        mobile.value = main.value;
      }
    }
  } catch(e){ console.error(e); }
});
</script>
<script>
function initSettingsBindings() {
  try {
    const colorInput = document.getElementById('mainTextColor');
    if (colorInput && !colorInput._hasBinding) {
      colorInput.addEventListener('input', (e) => {
        if (typeof applyTextColor === 'function') applyTextColor(e.target.value);
        if (typeof saveToStorage === 'function') saveToStorage(TEXT_COLOR_STORAGE, e.target.value);
        else localStorage.setItem(TEXT_COLOR_STORAGE, e.target.value);
      });
      colorInput._hasBinding = true;
    }
    // ensure chat font size slider works
    const chatFontSizeSlider = document.getElementById('chatFontSize');
    const chatFontSizeIndicator = document.getElementById('chatFontSizeIndicator');
    if (chatFontSizeSlider && !chatFontSizeSlider._hasBinding) {
      chatFontSizeSlider.addEventListener('input', (e) => {
        const v = parseFloat(e.target.value);
        if (typeof applyChatTextSize === 'function') applyChatTextSize(v);
        try {
          if (typeof saveToStorage === 'function') saveToStorage(CHAT_FONT_SIZE_STORAGE, v);
          else localStorage.setItem(CHAT_FONT_SIZE_STORAGE, v);
        } catch(e){}
        if (chatFontSizeIndicator) chatFontSizeIndicator.textContent = `${Math.round(v*100)}%`;
      });
      chatFontSizeSlider._hasBinding = true;
    }
  } catch(e){ console.error('initSettingsBindings err', e); }
}

function initMobileTabs() {
  try {
    const container = document.getElementById('settingsSection');
    if (!container) return;
    const btns = container.querySelectorAll('.tab-buttons button');
    btns.forEach((b, idx) => {
      b.onclick = function(){ openSettingsTab(idx+1); };
    });
    // ensure tab pages have proper active states for first tab
    const pages = container.querySelectorAll('.tab-page');
    if (pages && pages.length) {
      pages.forEach((p,i)=> p.classList.toggle('active', i===0));
    }
  } catch(e){ console.error('initMobileTabs err', e); }
}

// run once to attach if DOM already ready
document.addEventListener('DOMContentLoaded', function(){ initSettingsBindings(); initMobileTabs(); });
</script>

<!-- MODAL SCRIPTS IMPORTED FROM index_animation_fixed.html -->
<script>
    // --- Global Variables and Constants ---
    if (typeof window.currentMode === 'undefined') window.currentMode = "personal";
    let characters = {};
    let activeCharacter = null;
    let attachedFiles = [];
    let regenerateVariants = [];
    let currentVariantIndex = -1;
    let isBotGenerating = false;
    let shouldScrollToBottom = true;
    let tempImportedCharacterData = null;

    const ROOM_HISTORY_KEY = "roomHistory_v3";
    const MEMORY_KEY = "neuralMemory_v3";
    const API_KEY_STORAGE = "userApiKey_v3";
    const API_URL_STORAGE = "apiUrl_v3";
    const THEME_STORAGE = "themePreference_v3";
    const TEXT_COLOR_STORAGE = "mainTextColor_v3";
    const CHAT_FONT_SIZE_STORAGE = "chatFontSize_v1";
    const SIDEBAR_STATE_STORAGE = "sidebarState_v1";
    const REST_API_URL_STORAGE = "restApiUrl_v2";
    const REST_API_HEADERS_STORAGE = "restApiHeaders_v2";
    const ENABLE_REST_API_STORAGE = "enableRestApi_v2";
    const GOOGLE_API_KEY_STORAGE = "googleApiKey_v1";
    const GOOGLE_API_MODEL_STORAGE = "googleApiModel_v1";
    const ENABLE_GOOGLE_API_STORAGE = "enableGoogleApi_v1";
    const AVAILABLE_GOOGLE_MODELS = [ { id: "gemini-2.0-flash", name: "Gemini 2.0 Flash" }, { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro" }, { id: "gemini-2.5-flash", name: "Gemini 2.5 Flash" }, { id: "gemini-2.5-flash-lite", name: "Gemini 2.5 Flash-Lite" } ];

    let useRestApi = false;
    let restApiUrlValue = "";
    let restApiHeadersValue = {};
    let useGoogleApi = false;
    let googleApiKey = "";
    let googleApiModel = "";

    // --- DOM Elements Cache ---
    const prevVariantBtn = document.getElementById("prevVariantBtn");
    const nextVariantBtn = document.getElementById("nextVariantBtn");
    const applyVariantBtn = document.getElementById("applyVariantBtn");
    const variantCounter = document.getElementById("variantCounter");
    let globalToggleSettingsBtn;
    let globalThemeToggleBtn;
    const sendButton = document.getElementById("sendButton");
    const personalModeBtn = document.getElementById("personalModeBtn");
    const groupModeBtn = document.getElementById("groupModeBtn");
    const messagesBox = document.getElementById("messages");
    const userInput = document.getElementById("userInput");
    const chatFontSizeSlider = document.getElementById("chatFontSize");
    const chatFontSizeIndicator = document.getElementById("chatFontSizeIndicator");
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenuContainer = document.getElementById('mobileMenuContainer');
    const mobileMenuItemsPlaceholder = document.getElementById('mobileMenuItemsPlaceholder');
    const mainInputRow = document.getElementById('mainInputRow');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleButton = document.getElementById('sidebarToggleButton');
    const filePreviewsContainer = document.getElementById('filePreviewsContainer');

    // --- Utility Functions ---

    /**
     * [FIXED] Adds the copy to clipboard functionality.
     * @param {string} text - The text to copy.
     */
    function copyMessageToClipboard(text) {
      if (!text) return;
      const textArea = document.createElement("textarea");
      textArea.value = text;
      
      // Prevent screen from scrolling to the element
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";

      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCustomAlert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        } else {
            showCustomAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç.');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        showCustomAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞.');
      }

      document.body.removeChild(textArea);
    }

    function setAppHeight() {
      const doc = document.documentElement;
      doc.style.setProperty('--app-height', `${window.innerHeight}px`);
    }

    function setAccentRgb() {
        const rootStyle = getComputedStyle(document.documentElement);
        const accentColor = rootStyle.getPropertyValue('--accent-color').trim();
        if (accentColor.startsWith('#')) {
            const hex = accentColor.substring(1);
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            document.documentElement.style.setProperty('--accent-color-rgb', `${r},${g},${b}`);
        } else if (accentColor.startsWith('rgb')) {
             const match = accentColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
            if (match) {
                document.documentElement.style.setProperty('--accent-color-rgb', `${match[1]},${match[2]},${match[3]}`);
            }
        }
    }

    function isMobileView() {
        return window.innerWidth <= 900;
    }

    // --- Mobile Menu & View Handling ---

    function setupMobileHamburgerMenu() {
        const placeholder = mobileMenuItemsPlaceholder;
        if (!placeholder) return;
        placeholder.innerHTML = '';

        const originalSidebarHeader = document.querySelector('.sidebar .sidebar-header');
        if (originalSidebarHeader) placeholder.appendChild(originalSidebarHeader.cloneNode(true));

        const mobileChatListDiv = document.createElement('div');
        mobileChatListDiv.id = 'mobileMenuChatListInternal';
        mobileChatListDiv.className = 'chat-list';
        placeholder.appendChild(mobileChatListDiv);
        renderChatList(mobileChatListDiv);

        globalThemeToggleBtn = document.getElementById('themeToggle');
        if (globalThemeToggleBtn && globalThemeToggleBtn.parentElement !== placeholder) {
             placeholder.appendChild(globalThemeToggleBtn);
        }

        globalToggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        if (globalToggleSettingsBtn && globalToggleSettingsBtn.parentElement !== placeholder) {
            placeholder.appendChild(globalToggleSettingsBtn);
        }
    }

    function restoreDesktopElements() {
        const themeToggleInHamburger = mobileMenuItemsPlaceholder.querySelector('#themeToggle');
        if (themeToggleInHamburger) {
            document.body.appendChild(themeToggleInHamburger);
        }
        const settingsToggleInHamburger = mobileMenuItemsPlaceholder.querySelector('#toggleSettingsBtn');
        if (settingsToggleInHamburger) {
            document.body.appendChild(settingsToggleInHamburger);
        }
    }


    function handleViewChange() {
        setAppHeight();
        const mainContentEl = document.getElementById('mainContent');
        const visibleFileAttachBtn = mainInputRow.querySelector('.file-attach-button');
        const originalStatusIndicator = document.getElementById('messages-status-indicator');
        const pcSidebarToggle = document.getElementById('sidebarToggleButton');

        if (isMobileView()) {
            setupMobileHamburgerMenu();
            sendButton.innerHTML = '‚Üí';
            sendButton.setAttribute('aria-label', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å');

            let mobilePrefixDiv = mainInputRow.querySelector('.mobile-input-prefix');
            if (!mobilePrefixDiv) {
                mobilePrefixDiv = document.createElement('div');
                mobilePrefixDiv.className = 'mobile-input-prefix';
                mainInputRow.insertBefore(mobilePrefixDiv, userInput);
            }
            mobilePrefixDiv.style.display = 'flex';


            let mobileFileAttachBtn = mobilePrefixDiv.querySelector('.file-attach-button');
            if (!mobileFileAttachBtn && visibleFileAttachBtn) {
                mobileFileAttachBtn = visibleFileAttachBtn.cloneNode(true);
                mobileFileAttachBtn.onclick = () => document.getElementById('fileInput').click();
                mobilePrefixDiv.appendChild(mobileFileAttachBtn);
            } else if (mobileFileAttachBtn) {
                 mobileFileAttachBtn.style.display = 'flex';
            }
             if (visibleFileAttachBtn && visibleFileAttachBtn.parentElement === mainInputRow) {
                visibleFileAttachBtn.style.display = 'none';
            }


            let mobileStatusIndicator = mobilePrefixDiv.querySelector('#messages-status-indicator');
            if (!mobileStatusIndicator && originalStatusIndicator) {
                mobileStatusIndicator = originalStatusIndicator.cloneNode(true);
                mobilePrefixDiv.appendChild(mobileStatusIndicator);
            } else if (mobileStatusIndicator) {
                 mobileStatusIndicator.style.display = 'block';
            }
            if (originalStatusIndicator && originalStatusIndicator.parentElement === mainInputRow) {
                 originalStatusIndicator.style.display = 'none';
            }

            if(sidebar) sidebar.style.display = 'none';
            if(pcSidebarToggle) pcSidebarToggle.style.display = 'none';

        } else {
            restoreDesktopElements();
            sendButton.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';

            const mobilePrefixDiv = mainInputRow.querySelector('.mobile-input-prefix');
            if (mobilePrefixDiv) mobilePrefixDiv.style.display = 'none';


            if (visibleFileAttachBtn && visibleFileAttachBtn.parentElement === mainInputRow) {
                 visibleFileAttachBtn.style.display = 'flex';
            }
            if (originalStatusIndicator && originalStatusIndicator.parentElement === mainInputRow) {
                originalStatusIndicator.style.display = 'block';
            }

            if (sidebar) sidebar.style.display = 'flex';
            if(pcSidebarToggle) pcSidebarToggle.style.display = 'flex';
            loadSidebarState();
        }
    }


    // --- Initialization ---
    window.onload = () => {
      setAccentRgb();
      loadSettings();
      loadNeuralMemory();
      loadTheme();
      loadTextColor();
      loadChatTextSize();
      populateGoogleApiModelSelect();

      const statusIndicator = document.getElementById('messages-status-indicator');
      const userInputEl = document.getElementById('userInput');

      let desktopFileAttachButton = mainInputRow.querySelector('.file-attach-button:not(.mobile-input-prefix .file-attach-button)');
      if (!desktopFileAttachButton) {
          desktopFileAttachButton = document.createElement('button');
          desktopFileAttachButton.className = 'file-attach-button';
          desktopFileAttachButton.setAttribute('aria-label', '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          desktopFileAttachButton.title = '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
          desktopFileAttachButton.innerHTML = 'üìé'; // Changed from '?' to 'üìé'
          desktopFileAttachButton.type = 'button';
          desktopFileAttachButton.onclick = () => document.getElementById('fileInput').click();

          if (statusIndicator && statusIndicator.parentElement === mainInputRow) {
            mainInputRow.insertBefore(desktopFileAttachButton, statusIndicator);
          } else if (userInputEl) {
            mainInputRow.insertBefore(desktopFileAttachButton, userInputEl);
          } else {
            mainInputRow.insertBefore(desktopFileAttachButton, mainInputRow.firstChild);
          }
      } else {
         desktopFileAttachButton.innerHTML = 'üìé'; // Changed from '?' to 'üìé'
      }


      renderMode();
      renderChatList();
      renderGroupParticipants();
      setupEventListeners();
      updateVariantControls();
      handleViewChange();
      renderFilePreviews();

      if (activeCharacter) {
        setActiveCharacter(activeCharacter);
      } else {
        displayInitialHelperMessage();
      }
      userInput.style.height = 'auto';
      userInput.style.height = (userInput.scrollHeight) + 'px';
      setAppHeight();
    };


    function displayInitialHelperMessage() {
        if (Object.keys(characters).length === 0 && messagesBox.children.length === 0) {
             const helperP = document.createElement('p');
             helperP.style.textAlign = 'center';
             helperP.style.color = 'var(--text-color)';
             helperP.style.padding = '20px';
             helperP.style.fontStyle = 'italic';
             helperP.style.opacity = '0.7';
             helperP.innerHTML = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã<br>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (‚öôÔ∏è), —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç.';
             messagesBox.appendChild(helperP);
        }
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
      if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', () => {
            mobileMenuContainer.classList.toggle('open');
            hamburgerBtn.classList.toggle('open');
            hamburgerBtn.setAttribute('aria-expanded', mobileMenuContainer.classList.contains('open'));
            mobileMenuContainer.setAttribute('aria-hidden', !mobileMenuContainer.classList.contains('open'));
        });
      }
      document.addEventListener('click', (event) => {
        if (mobileMenuContainer && mobileMenuContainer.classList.contains('open') &&
            !mobileMenuContainer.contains(event.target) &&
            hamburgerBtn && !hamburgerBtn.contains(event.target)) {
            mobileMenuContainer.classList.remove('open');
            if (hamburgerBtn) {
                hamburgerBtn.classList.remove('open');
                hamburgerBtn.setAttribute('aria-expanded', 'false');
            }
            mobileMenuContainer.setAttribute('aria-hidden', 'true');
        }
      });

      document.body.addEventListener('click', function(event) {
        const target = event.target.closest('#themeToggle');
        if (target) {
            document.body.classList.toggle("dark-theme");
            const isDark = document.body.classList.contains("dark-theme");
            setTheme(isDark);
            setAccentRgb();
            const savedUserColor = localStorage.getItem(TEXT_COLOR_STORAGE);
            if (savedUserColor) {
                applyTextColor(savedUserColor);
            } else {
                const themeTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                applyTextColor(themeTextColor);
            }
        }
      });
      document.body.addEventListener('click', function(event) {
        if (event.target.closest('#toggleSettingsBtn')) {
            openSettingsModal();
        }
      });


      document.getElementById("settingsModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("settingsModal")) closeSettingsModal();
      });
       document.getElementById("lorebookModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("lorebookModal")) closeLorebookModal();
      });
       document.getElementById("backgroundModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("backgroundModal")) closeBackgroundModal();
      });
      document.getElementById("greetingSelectModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("greetingSelectModal")) closeGreetingModal();
      });

      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeSettingsModal();
          closeLorebookModal();
          closeBackgroundModal();
          closeGreetingModal();
          const avatarModal = document.querySelector('.avatar-preview-modal');
          if (avatarModal) document.body.removeChild(avatarModal);
          if (mobileMenuContainer && mobileMenuContainer.classList.contains('open')) {
            mobileMenuContainer.classList.remove('open');
            if (hamburgerBtn) {
                 hamburgerBtn.classList.remove('open');
                 hamburgerBtn.setAttribute('aria-expanded', 'false');
            }
            mobileMenuContainer.setAttribute('aria-hidden', 'true');
          }
        }
      });
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±–∏—Ä–∞–µ–º —Ñ–æ–∫—É—Å —Å –ø–æ–ª—è –≤–≤–æ–¥–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
      document.getElementById('chatContainer').addEventListener('click', (e) => {
        const inputContainer = document.querySelector('.input-area-container');
        // Check if the clicked element or any of its parents is the userInput or a child of inputContainer
        if (inputContainer && !inputContainer.contains(e.target)) {
            userInput.blur(); // Blur the input if click is outside
        }
      });

      sendButton.addEventListener("click", sendMessage);
      userInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });
      userInput.addEventListener('input', () => {
          userInput.style.height = 'auto';
          userInput.style.height = (userInput.scrollHeight) + 'px';
      });

      personalModeBtn.addEventListener('click', () => switchMode("personal"));
      groupModeBtn.addEventListener('click', () => switchMode("group"));


      document.getElementById("apiKey").addEventListener("input", () => saveToStorage(API_KEY_STORAGE, document.getElementById("apiKey").value.trim()));
      document.getElementById("apiUrl").addEventListener("input", () => saveToStorage(API_URL_STORAGE, document.getElementById("apiUrl").value.trim()));

      document.getElementById("googleApiKey").addEventListener("input", () => {
          googleApiKey = document.getElementById("googleApiKey").value.trim();
          saveToStorage(GOOGLE_API_KEY_STORAGE, googleApiKey);
      });
      document.getElementById("googleApiModel").addEventListener("change", () => {
          googleApiModel = document.getElementById("googleApiModel").value;
          saveToStorage(GOOGLE_API_MODEL_STORAGE, googleApiModel);
      });
      document.getElementById("enableGoogleApi").addEventListener("change", (event) => {
          useGoogleApi = event.target.checked;
          saveToStorage(ENABLE_GOOGLE_API_STORAGE, useGoogleApi.toString());
      });


      document.getElementById("neuralMemory").addEventListener("input", () => saveToStorage(MEMORY_KEY, document.getElementById("neuralMemory").value));
      document.getElementById("mainTextColor").addEventListener("input", (e) => {
          applyTextColor(e.target.value);
          saveToStorage(TEXT_COLOR_STORAGE, e.target.value);
      });
      chatFontSizeSlider.addEventListener("input", (e) => {
          applyChatTextSize(e.target.value);
          saveToStorage(CHAT_FONT_SIZE_STORAGE, e.target.value);
          chatFontSizeIndicator.textContent = `${Math.round(e.target.value * 100)}%`;
      });

      if (sidebarToggleButton) {
        sidebarToggleButton.addEventListener('click', toggleSidebar);
      }

      setupRestApiSwitch();
      setupFileAttach();
      setupScrollHandler();
      setupAvatarClickHandler();
      window.addEventListener('resize', handleViewChange);
    }

    // --- Sidebar Toggle (PC) ---
    function toggleSidebar() {
        if (!sidebar) return;
        sidebar.classList.toggle('collapsed');
        const isCollapsed = sidebar.classList.contains('collapsed');
        if (sidebarToggleButton) {
            sidebarToggleButton.innerHTML = isCollapsed ? '&gt;&gt;' : '&lt;&lt;';
            sidebarToggleButton.setAttribute('aria-label', isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å' : '–°–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å');
        }
        localStorage.setItem(SIDEBAR_STATE_STORAGE, isCollapsed ? 'collapsed' : 'expanded');
        applyBackground(getCurrentCharacterName());
    }

    function loadSidebarState() {
        if (isMobileView() || !sidebar) {
             if(sidebar) sidebar.classList.add('collapsed');
             return;
        }
        const state = localStorage.getItem(SIDEBAR_STATE_STORAGE);
        const isCollapsed = state === 'collapsed';
        sidebar.classList.toggle('collapsed', isCollapsed);
        if (sidebarToggleButton) {
            sidebarToggleButton.innerHTML = isCollapsed ? '&gt;&gt;' : '&lt;&lt;';
            sidebarToggleButton.setAttribute('aria-label', isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å' : '–°–≤–µ—Ä–Ω—É—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å');
        }
    }


    // --- Theme and Color Management ---
    function setTheme(isDark) {
      localStorage.setItem(THEME_STORAGE, isDark ? "dark" : "light");
      const themeIconPath = isDark ?
        '<path d="M12 3.6A8.4 8.4 0 003.6 12 8.4 8.4 0 0012 20.4a8.4 8.4 0 008.4-8.4A8.4 8.4 0 0012 3.6zm0 14.4a6 6 0 110-12 6 6 0 010 12zM12 7a1 1 0 00-1 1v3H8a1 1 0 000 2h3v3a1 1 0 002 0v-3h3a1 1 0 000-2h-3V8a1 1 0 00-1-1z"/>'
        : '<path d="M21 12.79A9 9 0 0112.21 3 7 7 0 1021 12.79z"/>';
      const themeIconEl = document.getElementById("themeIcon");
      if (themeIconEl) themeIconEl.innerHTML = themeIconPath;
    }
    function loadTheme() {
      const savedTheme = localStorage.getItem(THEME_STORAGE);
      const isDark = savedTheme === "dark";
      document.body.classList.toggle("dark-theme", isDark);
      setTheme(isDark);
      setAccentRgb();
    }
    function applyTextColor(color) {
        document.documentElement.style.setProperty('--text-color', color);
        document.documentElement.style.setProperty('--bold-text-color', color);
    }
    function loadTextColor() {
        const savedColor = localStorage.getItem(TEXT_COLOR_STORAGE);
        const colorPicker = document.getElementById("mainTextColor");
        if (savedColor) {
            applyTextColor(savedColor);
            if(colorPicker) colorPicker.value = savedColor;
        } else {
            const defaultThemeColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            applyTextColor(defaultThemeColor);
            if(colorPicker) colorPicker.value = defaultThemeColor;
        }
    }

    // --- Chat Font Size ---
    function applyChatTextSize(sizeMultiplier) {
        document.documentElement.style.setProperty('--chat-font-size-multiplier', sizeMultiplier);
        if (chatFontSizeIndicator) chatFontSizeIndicator.textContent = `${Math.round(sizeMultiplier * 100)}%`;
    }

    function loadChatTextSize() {
        const savedSize = localStorage.getItem(CHAT_FONT_SIZE_STORAGE);
        const defaultSize = 1;
        const sizeToApply = savedSize ? parseFloat(savedSize) : defaultSize;
        applyChatTextSize(sizeToApply);
        if (chatFontSizeSlider) chatFontSizeSlider.value = sizeToApply;
    }


    // --- Modal Handling ---
    function openSettingsModal() {
        const modal = document.getElementById("settingsModal");
        modal.style.display = "flex";
        if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            modal.classList.add('above-hamburger');
        }
        document.getElementById("personalModeBtn").classList.toggle("selected", currentMode === "personal");
        document.getElementById("personalModeBtn").setAttribute("aria-selected", currentMode === "personal");
        document.getElementById("groupModeBtn").classList.toggle("selected", currentMode === "group");
        document.getElementById("groupModeBtn").setAttribute("aria-selected", currentMode === "group");
    }
    function closeSettingsModal() {
        const modal = document.getElementById("settingsModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
    }
    function openLorebookModal() {
      const name = getCurrentCharacterName();
      if (!name || !characters[name]) return showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
      document.getElementById("lorebookCharacterName").textContent = name;
      renderLorebookEntries(name);
      const modal = document.getElementById("lorebookModal");
      modal.style.display = "flex";
      const settingsModal = document.getElementById("settingsModal");
      if (settingsModal.style.display === "flex") {
          const settingsZIndex = parseInt(window.getComputedStyle(settingsModal).zIndex, 10) || 1000;
          modal.style.zIndex = settingsZIndex + 10;
      } else if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            modal.classList.add('above-hamburger');
      } else {
          modal.style.zIndex = '';
      }
    }
    function closeLorebookModal() {
        const modal = document.getElementById("lorebookModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
        modal.style.zIndex = '';
    }
    function openBackgroundModal() {
      const name = getCurrentCharacterName();
      if (!name) return showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
      document.getElementById("backgroundCharacterName").textContent = name;
      const modal = document.getElementById("backgroundModal");
      modal.style.display = "flex";
      const settingsModal = document.getElementById("settingsModal");
      if (settingsModal.style.display === "flex") {
          const settingsZIndex = parseInt(window.getComputedStyle(settingsModal).zIndex, 10) || 1000;
          modal.style.zIndex = settingsZIndex + 10;
      } else if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            modal.classList.add('above-hamburger');
      } else {
          modal.style.zIndex = '';
      }
    }
    function closeBackgroundModal() {
        const modal = document.getElementById("backgroundModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
        modal.style.zIndex = '';
    }

    function openGreetingModal(characterName, greetings) {
        document.getElementById("greetingCharacterName").textContent = characterName;
        const optionsContainer = document.getElementById("greetingOptions");
        optionsContainer.innerHTML = "";
        let selectedGreeting = null;

        greetings.forEach((greeting, index) => {
            const optionDiv = document.createElement("div");
            optionDiv.className = "greeting-option";
            optionDiv.textContent = greeting.length > 150 ? greeting.substring(0, 150) + "..." : greeting;
            optionDiv.dataset.fullGreeting = greeting;
            if (index === 0) {
                optionDiv.classList.add("selected");
                selectedGreeting = greeting;
            }
            optionDiv.addEventListener("click", () => {
                optionsContainer.querySelectorAll(".greeting-option").forEach(opt => opt.classList.remove("selected"));
                optionDiv.classList.add("selected");
                selectedGreeting = greeting;
            });
            optionsContainer.appendChild(optionDiv);
        });

        const greetingModal = document.getElementById("greetingSelectModal");
        greetingModal.style.display = "flex";
        greetingModal.style.zIndex = '';
        greetingModal.classList.remove('above-hamburger');

        const settingsModal = document.getElementById("settingsModal");
        if (settingsModal.style.display === "flex") {
            const settingsZIndex = parseInt(window.getComputedStyle(settingsModal).zIndex, 10) || 1000;
            greetingModal.style.zIndex = settingsZIndex + 10;
        } else if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
            greetingModal.classList.add('above-hamburger');
        }
    }

    function closeGreetingModal() {
        const modal = document.getElementById("greetingSelectModal");
        modal.style.display = "none";
        modal.classList.remove('above-hamburger');
        modal.style.zIndex = '';
        tempImportedCharacterData = null;
    }
    function confirmGreetingSelection() {
        const selectedOption = document.querySelector("#greetingOptions .greeting-option.selected");
        if (selectedOption && tempImportedCharacterData) {
            tempImportedCharacterData.character.welcomeMessage = selectedOption.dataset.fullGreeting;
            finalizeImport(tempImportedCharacterData);
        }
        closeGreetingModal();
    }


    // --- Mode Switching (Personal/Group) ---
    function switchMode(mode) {
      if (currentMode === mode) return;
      currentMode = mode;

      const settingsPersonalBtn = document.querySelector('#settingsModal #personalModeBtn');
      const settingsGroupBtn = document.querySelector('#settingsModal #groupModeBtn');
      if (settingsPersonalBtn) {
        settingsPersonalBtn.classList.toggle("selected", mode === "personal");
        settingsPersonalBtn.setAttribute("aria-selected", mode === "personal");
      }
      if (settingsGroupBtn) {
        settingsGroupBtn.classList.toggle("selected", mode === "group");
        settingsGroupBtn.setAttribute("aria-selected", mode === "group");
      }

      renderMode();
      clearVariants();
    }

    function renderMode() {
      document.getElementById("groupParticipants").style.display = currentMode === "group" ? "flex" : "none";
      document.getElementById("characterSelect").disabled = currentMode === "group";
      shouldScrollToBottom = true;
      loadAndRenderMessages();
      renderGroupParticipants();
      updateVariantControls();
    }

    // --- Data Storage Utilities ---
    function saveToStorage(key, value) {
      if (value !== undefined && value !== null) localStorage.setItem(key, value);
      else localStorage.removeItem(key);
    }

    // --- Settings Load/Save ---
    function loadSettings() {
      characters = JSON.parse(localStorage.getItem("characters_v3")) || {};
      document.getElementById("apiKey").value = localStorage.getItem(API_KEY_STORAGE) || "";
      document.getElementById("apiUrl").value = localStorage.getItem(API_URL_STORAGE) || "https://llm.chutes.ai/v1/chat/completions";

      restApiUrlValue = localStorage.getItem(REST_API_URL_STORAGE) || "";
      document.getElementById("restApiUrl").value = restApiUrlValue;
      const headersString = localStorage.getItem(REST_API_HEADERS_STORAGE) || "";
      document.getElementById("restApiHeaders").value = headersString;
      try { restApiHeadersValue = headersString ? JSON.parse(headersString) : {}; }
      catch (e) { console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ REST API:", e); restApiHeadersValue = {}; }
      useRestApi = localStorage.getItem(ENABLE_REST_API_STORAGE) === "true";
      document.getElementById("enableRestApi").checked = useRestApi;

      googleApiKey = localStorage.getItem(GOOGLE_API_KEY_STORAGE) || "";
      document.getElementById("googleApiKey").value = googleApiKey;
      googleApiModel = localStorage.getItem(GOOGLE_API_MODEL_STORAGE) || (AVAILABLE_GOOGLE_MODELS.length > 0 ? AVAILABLE_GOOGLE_MODELS[0].id : "");
      document.getElementById("googleApiModel").value = googleApiModel;
      useGoogleApi = localStorage.getItem(ENABLE_GOOGLE_API_STORAGE) === "true";
      document.getElementById("enableGoogleApi").checked = useGoogleApi;



      if (!activeCharacter && Object.keys(characters).length > 0) {
        activeCharacter = Object.keys(characters)[0];
      }

      // --- Restore temperature and maxTokens from localStorage (ensure persistence even after dynamic settings re-render) ---
      try {
        const storedTemp = localStorage.getItem('temperature');
        const storedMax = localStorage.getItem('maxTokens');
        const tempEl = document.getElementById('temperature');
        const maxEl = document.getElementById('maxTokens');
        if (tempEl && storedTemp !== null) tempEl.value = storedTemp;
        if (maxEl && storedMax !== null) maxEl.value = storedMax;

        // Attach listeners so future changes are persisted (idempotent)
        function saveTemp() { try { if (tempEl) localStorage.setItem('temperature', tempEl.value); } catch(e){console.warn(e);} }
        function saveMax() { try { if (maxEl) localStorage.setItem('maxTokens', maxEl.value); } catch(e){console.warn(e);} }
        if (tempEl && !tempEl.__charis_persist_attached) { tempEl.addEventListener('input', saveTemp); tempEl.addEventListener('change', saveTemp); tempEl.__charis_persist_attached = true; }
        if (maxEl && !maxEl.__charis_persist_attached) { maxEl.addEventListener('input', saveMax); maxEl.addEventListener('change', saveMax); maxEl.__charis_persist_attached = true; }
      } catch(e){ console.warn('settings persistence injection error', e); }

      populateCharacterSelect();
    }
    function loadNeuralMemory() {
      document.getElementById("neuralMemory").value = localStorage.getItem(MEMORY_KEY) || "";
    }

    /**
     * [FIXED] Saves settings and handles avatar file uploads by resizing and compressing them.
     */
    async function saveSettings() {
      const name = document.getElementById("characterName").value.trim();
      if (!name) return showCustomAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");

      const isNewChar = !characters[name];
      const charData = characters[name] || {};

      // --- Update character data from all form fields ---
      charData.name = name;
      charData.description = document.getElementById("description").value;
      charData.personality = document.getElementById("personality").value;
      charData.scenario = document.getElementById("scenario").value;
      charData.mes_example = document.getElementById("mes_example").value;
      charData.welcomeMessage = document.getElementById("welcomeMessage").value;
      // Removed: charData.alternate_greetings = document.getElementById("alternate_greetings").value.split('\n').map(g => g.trim()).filter(g => g);
      // When saving, we don't take alternate_greetings from UI, they are only imported.
      // If charData.alternate_greetings doesn't exist or is empty, initialize it as an empty array.
      if (!charData.alternate_greetings || !Array.isArray(charData.alternate_greetings)) {
          charData.alternate_greetings = [];
      }


      // Advanced prompts
      charData.system_prompt = document.getElementById("system_prompt").value;
      charData.post_history_instructions = document.getElementById("post_history_instructions").value;
      charData.creator_notes = document.getElementById("creator_notes").value;

      charData.model = document.getElementById("characterModel").value.trim() || document.getElementById("model").value;
      charData.lorebook = charData.lorebook || [];

      // Await avatar processing
      const charAvatarFromFile = await handleAvatarUpload('character');
      const userAvatarFromFile = await handleAvatarUpload('user');

      // Prioritize file upload, then URL input, then existing, then default placeholder
      if (charAvatarFromFile) {
          charData.avatarCharacter = charAvatarFromFile;
      } else if (document.getElementById("avatarUrl_character").value) {
          charData.avatarCharacter = document.getElementById("avatarUrl_character").value;
      } else if (!charData.avatarCharacter || charData.avatarCharacter.startsWith('data:image')) {
          charData.avatarCharacter = "https://placehold.co/100x100/FF7AAC/FFFFFF?text=–ë–æ—Ç";
      }

      if (userAvatarFromFile) {
          charData.avatarUser = userAvatarFromFile;
      } else if (document.getElementById("avatarUrl_user").value) {
          charData.avatarUser = document.getElementById("avatarUrl_user").value;
      } else if (!charData.avatarUser || charData.avatarUser.startsWith('data:image')) {
          charData.avatarUser = "https://placehold.co/100x100/7AC5FF/FFFFFF?text=–í—ã";
      }


      // Save REST API settings
      restApiUrlValue = document.getElementById("restApiUrl").value.trim();
      saveToStorage(REST_API_URL_STORAGE, restApiUrlValue);
      const headersString = document.getElementById("restApiHeaders").value.trim();
      saveToStorage(REST_API_HEADERS_STORAGE, headersString);
      try { restApiHeadersValue = headersString ? JSON.parse(headersString) : {}; }
      catch (e) { showCustomAlert("–û—à–∏–±–∫–∞ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ REST API. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."); console.error("–ù–µ–≤–µ—Ä–Ω—ã–π JSON –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö REST API:", e); restApiHeadersValue = {};}
      useRestApi = document.getElementById("enableRestApi").checked;
      saveToStorage(ENABLE_REST_API_STORAGE, useRestApi.toString());

      // Save Google API settings
      googleApiKey = document.getElementById("googleApiKey").value.trim();
      saveToStorage(GOOGLE_API_KEY_STORAGE, googleApiKey);
      googleApiModel = document.getElementById("googleApiModel").value;
      saveToStorage(GOOGLE_API_MODEL_STORAGE, googleApiModel);
      useGoogleApi = document.getElementById("enableGoogleApi").checked;
      saveToStorage(ENABLE_GOOGLE_API_STORAGE, useGoogleApi.toString());

      characters[name] = charData;
      localStorage.setItem("characters_v3", JSON.stringify(characters));

      populateCharacterSelect();
      renderChatList(document.getElementById('chatList'));
      const hamburgerChatListContainer = document.getElementById('mobileMenuChatListInternal');
      if (hamburgerChatListContainer) renderChatList(hamburgerChatListContainer);

      renderGroupParticipants();

      if (isNewChar || activeCharacter !== name) {
          setActiveCharacter(name);
      } else {
          loadAndRenderMessages();
          applyBackground(name);
      }
      document.getElementById("characterSelect").value = name;
      animateSaveButton();
      showCustomAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω.`);
      closeSettingsModal();
    }

    function populateGoogleApiModelSelect() {
        const selectEl = document.getElementById("googleApiModel");
        if (!selectEl) return;
        selectEl.innerHTML = "";
        AVAILABLE_GOOGLE_MODELS.forEach(model => {
            const option = document.createElement("option");
            option.value = model.id;
            option.textContent = model.name;
            selectEl.appendChild(option);
        });
        selectEl.value = localStorage.getItem(GOOGLE_API_MODEL_STORAGE) || (AVAILABLE_GOOGLE_MODELS.length > 0 ? AVAILABLE_GOOGLE_MODELS[0].id : "");
    }


    function animateSaveButton() {
      const btn = document.querySelector('.settings-content button[onclick="saveSettings()"]');
      if (!btn) return;
      const originalText = btn.textContent;
      btn.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
      btn.style.background = "linear-gradient(135deg, #a8e063 0%, #56ab2f 100%)";
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = "";
      }, 1500);
    }

    function showAvatarOptions(option, target) {
      document.getElementById(`avatarLinkInput_${target}`).style.display = option === 'link' ? 'block' : 'none';
      document.getElementById(`avatarFileInputWrapper_${target}`).style.display = option === 'file' ? 'block' : 'none';
    }

    /**
     * [FIXED] Handles avatar file upload. Resizes and compresses the image to prevent
     * localStorage size limit issues before converting to a Data URL.
     * @param {string} target - 'character' or 'user'.
     * @returns {Promise<string|null>} A promise that resolves with the compressed Data URL or null.
     */
    async function handleAvatarUpload(target) {
        const fileInput = document.getElementById(`avatarFileInput_${target}`);
        if (!fileInput || fileInput.files.length === 0) {
            return null;
        }
        const file = fileInput.files[0];
        const MAX_WIDTH = 256;
        const MAX_HEIGHT = 256;

        return new Promise((resolve) => {
            const img = document.createElement("img");
            const reader = new FileReader();

            reader.onload = (e) => {
                img.src = e.target.result; // Load file into an image element
            };

            img.onerror = () => {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.");
                resolve(null); // Resolve with null if the image fails to load
            };

            img.onload = () => {
                // Resize the image on a canvas
                const canvas = document.createElement("canvas");
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);

                // Get a compressed data URL (jpeg is usually smaller for photos)
                const dataUrl = canvas.toDataURL("image/jpeg", 0.85); 
                resolve(dataUrl);
            };
            
            reader.readAsDataURL(file);
        });
    }


    // --- Character List and Selection ---
    function populateCharacterSelect() {
      const select = document.getElementById("characterSelect");
      if (!select) return;
      const currentVal = select.value;
      select.innerHTML = "<option value=\"\" disabled>-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ --</option>";
      const sortedNames = Object.keys(characters).sort((a, b) => a.localeCompare(b, 'ru'));

      for (const name of sortedNames) {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      }
      if (characters[currentVal]) select.value = currentVal;
      else if (activeCharacter && characters[activeCharacter]) select.value = activeCharacter;
      else if (sortedNames.length > 0) select.value = "";

      select.onchange = () => {
          if (select.value) setActiveCharacter(select.value);
          clearVariants();
      };
    }

    function renderChatList(targetContainerEl = null) {
      const container = targetContainerEl || document.getElementById("chatList");
      if (!container) {
        return;
      }

      container.innerHTML = "";
      const fragment = document.createDocumentFragment();
      const sortedNames = Object.keys(characters).sort((a, b) => a.localeCompare(b, 'ru'));

      if (sortedNames.length === 0 && container.id === "chatList") {
          container.innerHTML = `<p style="text-align:center; font-style:italic; opacity:0.7; padding:1rem;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.</p>`;
          return;
      }

      for (const name of sortedNames) {
        const char = characters[name];
        const chatItem = document.createElement("div");
        chatItem.className = "chat-item";
        if (activeCharacter === name && currentMode === "personal") chatItem.classList.add("active");
        chatItem.setAttribute("role", "listitem");
        chatItem.setAttribute("tabindex", "0");

        const avatarSrc = char.avatarCharacter || "https://placehold.co/80x80/FF7AAC/FFFFFF?text=" + name.charAt(0);
        chatItem.innerHTML = `
          <img src="${avatarSrc}" alt="–ê–≤–∞—Ç–∞—Ä ${name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/FF7AAC/FFFFFF?text=?';"/>
          <div class="chat-name" title="${name}">${name}</div>
          <button class="delete-char-btn" aria-label="–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${name}" title="–£–¥–∞–ª–∏—Ç—å ${name}">√ó</button>
        `;
        chatItem.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-char-btn')) return;
            setActiveCharacter(name);
            switchMode("personal");
            clearVariants();
            if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
                mobileMenuContainer.classList.remove('open');
                if(hamburgerBtn) hamburgerBtn.classList.remove('open');
            }
        });
        chatItem.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                if (e.target.classList.contains('delete-char-btn')) {
                    e.target.click();
                } else {
                    setActiveCharacter(name);
                    switchMode("personal");
                    clearVariants();
                     if (isMobileView() && mobileMenuContainer.classList.contains('open')) {
                        mobileMenuContainer.classList.remove('open');
                        if(hamburgerBtn) hamburgerBtn.classList.remove('open');
                    }
                }
            }
        });

        chatItem.querySelector('.delete-char-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            showCustomConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${name}" –∏ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å –Ω–∏–º? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`, () => {
              delete characters[name];
              localStorage.setItem("characters_v3", JSON.stringify(characters));
              localStorage.removeItem(getChatKey(name));

              if (activeCharacter === name) {
                activeCharacter = Object.keys(characters)[0] || null;
                if (activeCharacter) {
                  setActiveCharacter(activeCharacter);
                } else {
                  // Clear all fields if no characters left
                  ['characterName', 'description', 'personality', 'scenario', 'mes_example', 'welcomeMessage', 'characterModel', 'system_prompt', 'post_history_instructions', 'creator_notes', 'avatarUrl_character', 'avatarUrl_user'].forEach(id => document.getElementById(id).value = '');
                  // For alternate_greetings, we no longer have an input field, so just ensure it's handled as an empty array or null if needed.
                  loadAndRenderMessages();
                  applyBackground(null);
                  displayInitialHelperMessage();
                }
              }
              renderChatList(document.getElementById('chatList'));
              const hamburgerChatList = document.getElementById('mobileMenuChatListInternal');
              if (hamburgerChatList) renderChatList(hamburgerChatList);

              renderGroupParticipants();
              populateCharacterSelect();
              clearVariants();
            });
        });
        fragment.appendChild(chatItem);
      }
      container.appendChild(fragment);
    }


    function renderGroupParticipants() {
      const container = document.getElementById("groupParticipants");
      container.innerHTML = "";
      if (currentMode !== "group" || Object.keys(characters).length === 0) {
        container.style.display = "none";
        return;
      }
      container.style.display = "flex";
      const fragment = document.createDocumentFragment();
      const sortedNames = Object.keys(characters).sort((a, b) => a.localeCompare(b, 'ru'));

      for (const name of sortedNames) {
        const char = characters[name];
        const participant = document.createElement("div");
        participant.className = "participant";
        participant.title = `–û—Ç–≤–µ—Ç–∏—Ç—å –æ—Ç –∏–º–µ–Ω–∏ ${name}`;
        participant.setAttribute("role", "button");
        participant.setAttribute("tabindex", "0");
        const avatarSrc = char.avatarCharacter || 'https://placehold.co/80x80/FF7AAC/FFFFFF?text=' + name.charAt(0);
        participant.innerHTML = `
          <img src="${avatarSrc}" alt="–ê–≤–∞—Ç–∞—Ä ${name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/FF7AAC/FFFFFF?text=?';"/>
          <div>${name}</div>
        `;
        participant.addEventListener('click', () => {
            showCustomConfirm(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ ${name}?`, () => {
                 respondToLastMessage(name);
            });
        });
        participant.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                showCustomConfirm(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∏–º–µ–Ω–∏ ${name}?`, () => {
                     respondToLastMessage(name);
                });
            }
        });
        fragment.appendChild(participant);
      }
      if (sortedNames.length === 0) {
          container.innerHTML = `<p style="text-align:center; font-style:italic; opacity:0.7; padding:0.5rem;">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>`;
      } else {
          container.appendChild(fragment);
      }
    }


    function setActiveCharacter(name) {
      if (!characters[name]) {
        console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
        activeCharacter = null;
        return;
      }
      activeCharacter = name;
      const ch = characters[name];

      // --- Populate all settings fields for the active character ---
      document.getElementById("characterName").value = name;
      document.getElementById("description").value = ch.description || "";
      document.getElementById("personality").value = ch.personality || "";
      document.getElementById("scenario").value = ch.scenario || "";
      document.getElementById("mes_example").value = ch.mes_example || "";
      document.getElementById("welcomeMessage").value = ch.welcomeMessage || "";
      // Removed: document.getElementById("alternate_greetings").value = (ch.alternate_greetings || []).join('\n');
      document.getElementById("system_prompt").value = ch.system_prompt || "";
      document.getElementById("post_history_instructions").value = ch.post_history_instructions || "";
      document.getElementById("creator_notes").value = ch.creator_notes || "";
      document.getElementById("characterModel").value = ch.model || "";
      
      // Update avatar URL input fields based on character data
      const avatarUrlInputChar = document.getElementById("avatarUrl_character");
      if (ch.avatarCharacter && !ch.avatarCharacter.startsWith('data:image')) {
          avatarUrlInputChar.value = ch.avatarCharacter;
          showAvatarOptions('link', 'character');
      } else {
          avatarUrlInputChar.value = "";
          showAvatarOptions('file', 'character'); // Default to file input if it's a data URL or missing
      }
      
      const avatarUrlInputUser = document.getElementById("avatarUrl_user");
      if (ch.avatarUser && !ch.avatarUser.startsWith('data:image')) {
          avatarUrlInputUser.value = ch.avatarUser;
          showAvatarOptions('link', 'user');
      } else {
          avatarUrlInputUser.value = "";
          showAvatarOptions('file', 'user'); // Default to file input if it's a data URL or missing
      }


      if (document.getElementById("characterSelect").value !== name) {
          document.getElementById("characterSelect").value = name;
      }

      shouldScrollToBottom = true;
      loadAndRenderMessages();
      renderChatList(document.getElementById('chatList'));
      const hamburgerChatList = document.getElementById('mobileMenuChatListInternal');
      if (hamburgerChatList) renderChatList(hamburgerChatList);

      applyBackground(name);
      clearVariants();
    }

    function getCurrentCharacterName() {
      if (currentMode === "personal") {
        return activeCharacter || (Object.keys(characters).length > 0 ? Object.keys(characters)[0] : null);
      }
      return null;
    }

    // --- Chat History Management ---
    function getChatKey(name) { return `chatHistory_v3_${name}`; }
    function saveChat(name, messages) {
      if (!name) return;
      try {
        localStorage.setItem(getChatKey(name), JSON.stringify(messages));
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞ –≤ localStorage:", e);
        showCustomAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è.");
      }
      allMessages = messages;
    }
    function loadChat(name) {
      if (!name) return [];
      let msgs = JSON.parse(localStorage.getItem(getChatKey(name)) || "[]");
      return msgs.map(msg => ({ ...msg, attachments: msg.attachments || null }));
    }
    function saveRoomChat(messages) {
        try {
            localStorage.setItem(ROOM_HISTORY_KEY, JSON.stringify(messages));
        } catch(e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞ –∫–æ–º–Ω–∞—Ç—ã –≤ localStorage:", e);
            showCustomAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è.");
        }
        allMessages = messages;
    }
    function loadRoomChat() {
      let msgs = JSON.parse(localStorage.getItem(ROOM_HISTORY_KEY) || "[]");
      return msgs.map(msg => ({ ...msg, attachments: msg.attachments || null }));
    }

    let allMessages = [];

    function loadAndRenderMessages(scrollToIndex = -1) {
        messagesBox.innerHTML = "";
        let characterForBackground = null;

        if (currentMode === "personal") {
            const name = getCurrentCharacterName();
            if (!name) {
                displayInitialHelperMessage();
                applyBackground(null);
                allMessages = [];
                return;
            }
            allMessages = loadChat(name);
            characterForBackground = name;
            if (allMessages.length === 0 && characters[name]?.welcomeMessage) {
                const welcome = characters[name].welcomeMessage;
                const welcomeMsgObject = { role: "assistant", content: welcome, avatar: characters[name].avatarCharacter, attachments: null };
                allMessages.push(welcomeMsgObject);
                saveChat(name, allMessages);
            } else if (allMessages.length === 0) {
                 const helperP = document.createElement('p');
                 helperP.style.textAlign = 'center'; helperP.style.color = 'var(--text-color)'; helperP.style.padding = '20px'; helperP.style.fontStyle = 'italic'; helperP.style.opacity = '0.7';
                 helperP.textContent = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!';
                 messagesBox.appendChild(helperP);
            }
        } else {
            allMessages = loadRoomChat();
            characterForBackground = null;
            if (allMessages.length === 0) {
                const helperP = document.createElement('p');
                helperP.style.textAlign = 'center'; helperP.style.color = 'var(--text-color)'; helperP.style.padding = '20px'; helperP.style.fontStyle = 'italic'; helperP.style.opacity = '0.7';
                helperP.textContent = '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!';
                messagesBox.appendChild(helperP);
            }
        }
        applyBackground(characterForBackground);

        const fragment = document.createDocumentFragment();
        allMessages.forEach((msg, i) => {
            const container = createMessageContainerDOM(msg, i);
            fragment.appendChild(container);
        });
        messagesBox.appendChild(fragment);

        if (scrollToIndex !== -1 && scrollToIndex < allMessages.length) {
            const targetMsgEl = messagesBox.children[scrollToIndex];
            if (targetMsgEl) targetMsgEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
        } else if (shouldScrollToBottom) {
            scrollToBottom(true);
            shouldScrollToBottom = false;
        }
    }


    // --- Message DOM Manipulation ---
    function createMessageContainerDOM(msgData, index) {
      const container = document.createElement("div");
      container.className = "message-container";
      container.dataset.index = index;

      let senderName, msgClass, roleForButtons, avatarUrl;
      const charNameForMsg = getCurrentCharacterName();

      if (currentMode === "personal") {
        senderName = msgData.role === "user" ? "–í—ã" : charNameForMsg;
        msgClass = msgData.role === "user" ? "user" : (msgData.role === "system" ? "system" : (msgData.role === "api" ? "api" : ""));
        roleForButtons = msgData.role;
        if (msgData.role === "user") {
          avatarUrl = characters[charNameForMsg]?.avatarUser || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
        } else if (msgData.role === "assistant") {
          avatarUrl = characters[charNameForMsg]?.avatarCharacter || "https://placehold.co/80x80/FF7AAC/FFFFFF?text=" + (charNameForMsg ? charNameForMsg.charAt(0) : "–ë");
        } else {
          avatarUrl = msgData.role === "system" ? "https://placehold.co/80x80/CCCCCC/FFFFFF?text=S" : "https://placehold.co/80x80/80D0C0/FFFFFF?text=A";
        }
      } else {
        senderName = msgData.sender || (msgData.role === "user" ? "–í—ã" : "–°–∏—Å—Ç–µ–º–∞");
        msgClass = (msgData.sender === "–í—ã" || msgData.role === "user") ? "user" : (msgData.role === "system" ? "system" : (msgData.role === "api" ? "api" : ""));
        roleForButtons = msgData.role;
        if (msgData.sender === "–í—ã") {
          const anyUserAvatar = Object.values(characters).find(c => c.avatarUser)?.avatarUser;
          avatarUrl = anyUserAvatar || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
        } else if (characters[msgData.sender]) {
          avatarUrl = characters[msgData.sender].avatarCharacter || "https://placehold.co/80x80/FF7AAC/FFFFFF?text=" + msgData.sender.charAt(0);
        } else {
          avatarUrl = msgData.role === "system" ? "https://placehold.co/80x80/CCCCCC/FFFFFF?text=S" : "https://placehold.co/80x80/80D0C0/FFFFFF?text=A";
        }
      }
      avatarUrl = msgData.avatar || avatarUrl;
      if (msgClass === "user") container.classList.add("user-container");

      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'message-content-wrapper';

      const avatarImg = document.createElement("img");
      avatarImg.src = avatarUrl || "https://placehold.co/80x80/CCCCCC/FFFFFF?text=?";
      avatarImg.alt = `–ê–≤–∞—Ç–∞—Ä ${senderName}`;
      avatarImg.className = "avatar";
      avatarImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/80x80/CCCCCC/FFFFFF?text=?'; };


      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${msgClass}`;

      let htmlContent = "";
      let textPart = msgData.content ? marked.parse(msgData.content) : '';
      htmlContent = `<strong>${senderName}:</strong>${textPart}`;
      messageDiv.innerHTML = htmlContent;

      if (msgData.attachments && msgData.attachments.length > 0) {
        const attachmentsGrid = document.createElement('div');
        attachmentsGrid.className = 'attachments-grid';
        msgData.attachments.forEach(att => {
            if (att.type && att.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = att.src;
                img.alt = att.name || '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                img.className = 'attached-image';
                attachmentsGrid.appendChild(img);
            } else {
                const fileLink = document.createElement('a');
                fileLink.href = att.src;
                fileLink.target = '_blank';
                fileLink.className = 'attached-file-link';
                fileLink.download = att.name || 'file';
                fileLink.innerHTML = `<span class="file-icon">üìÑ</span> ${att.name || '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª'}`;
                attachmentsGrid.appendChild(fileLink);
            }
        });
        messageDiv.appendChild(attachmentsGrid);
      }


      contentWrapper.appendChild(avatarImg);
      contentWrapper.appendChild(messageDiv);
      container.appendChild(contentWrapper);

      if (index !== null && roleForButtons !== "system" && senderName !== "API" && senderName !== "–°–∏—Å—Ç–µ–º–∞") {
        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "message-buttons";

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn"; copyBtn.title = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
        copyBtn.setAttribute("aria-label", "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        copyBtn.addEventListener("click", () => copyMessageToClipboard(msgData.content || ""));
        buttonsDiv.appendChild(copyBtn);

        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn"; editBtn.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.setAttribute("aria-label", "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        editBtn.addEventListener("click", () => startEditingMessage(container, index));
        buttonsDiv.appendChild(editBtn);

        if (roleForButtons === "assistant") {
          const regenBtn = document.createElement("button");
          regenBtn.className = "regen-btn"; regenBtn.title = "–†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å";
          regenBtn.setAttribute("aria-label", "–†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç");
          regenBtn.addEventListener("click", () => regenerateMessage(index));
          if (isBotGenerating) regenBtn.disabled = true;
          buttonsDiv.appendChild(regenBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn"; delBtn.title = "–£–¥–∞–ª–∏—Ç—å";
        delBtn.setAttribute("aria-label", "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
        delBtn.addEventListener("click", () => deleteMessage(index));
        buttonsDiv.appendChild(delBtn);

        container.appendChild(buttonsDiv);
      }
      return container;
    }

    function appendNewMessageToDOM(msgData, index) {
        const container = createMessageContainerDOM(msgData, index);
        messagesBox.appendChild(container);
        requestAnimationFrame(() => {
            container.style.opacity = 1;
            container.style.transform = 'translateY(0)';
        });
        if (shouldScrollToBottom) {
            scrollToBottom(true);
        }
    }

    function updateMessageInDOM(index, newMsgData) {
        const oldContainer = messagesBox.querySelector(`.message-container[data-index="${index}"]`);
        if (oldContainer) {
            const newContainer = createMessageContainerDOM(newMsgData, index);
            messagesBox.replaceChild(newContainer, oldContainer);
             requestAnimationFrame(() => {
                newContainer.style.opacity = 1;
                newContainer.style.transform = 'translateY(0)';
            });
        }
    }
    function removeMessageFromDOM(index) {
        const containerToRemove = messagesBox.querySelector(`.message-container[data-index="${index}"]`);
        if (containerToRemove) {
            messagesBox.removeChild(containerToRemove);
            const messageContainers = messagesBox.querySelectorAll('.message-container');
            messageContainers.forEach((container, newIdx) => {
                container.dataset.index = newIdx;
            });
        }
    }


    function scrollToBottom(force = false) {
      if (force || messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 100) {
        messagesBox.scrollTop = messagesBox.scrollHeight;
      }
    }

    // --- Message Editing ---
    function startEditingMessage(container, index) {
      const messageContentWrapper = container.querySelector(".message-content-wrapper");
      const messageButtons = container.querySelector(".message-buttons");
      if (!messageContentWrapper || container.querySelector(".message-edit-area")) return;

      let originalText = allMessages[index].content;

      messageContentWrapper.style.display = "none";
      if (messageButtons) messageButtons.style.display = "none";

      const editArea = document.createElement("textarea");
      editArea.className = "message-edit-area";
      editArea.value = originalText;
      editArea.style.height = 'auto';
      editArea.style.height = (Math.max(80, editArea.scrollHeight)) + 'px';
      editArea.addEventListener('input', () => {
          editArea.style.height = 'auto';
          editArea.style.height = (Math.max(80, editArea.scrollHeight)) + 'px';
      });

      const saveBtn = document.createElement("button");
      saveBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; saveBtn.className = "send-button";
      saveBtn.style.marginRight = "0.5rem";

      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "–û—Ç–º–µ–Ω–∞"; cancelBtn.className = "send-button";
      cancelBtn.style.background = "var(--participant-bg)"; cancelBtn.style.color = "var(--text-color)";

      const btnContainer = document.createElement("div");
      btnContainer.className = "edit-button-container";
      btnContainer.appendChild(saveBtn); btnContainer.appendChild(cancelBtn);

      container.insertBefore(editArea, messageContentWrapper);
      container.insertBefore(btnContainer, editArea.nextSibling);
      editArea.focus();

      saveBtn.onclick = () => {
        const newText = editArea.value.trim();
        const currentMessageAttachments = allMessages[index]?.attachments;
        if (!newText && (!currentMessageAttachments || currentMessageAttachments.length === 0)) {
            return showCustomAlert("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π.");
        }
        updateMessageContent(index, newText);

        if (allMessages[index].role === 'user' || allMessages[index].sender === '–í—ã') {
            const charToRespondName = currentMode === 'personal' ? getCurrentCharacterName() : getLastBotSender(index);
            if (charToRespondName && characters[charToRespondName]) {
                triggerBotResponseAfterEdit(index, charToRespondName);
            }
        }
      };
      cancelBtn.onclick = () => {
        messageContentWrapper.style.display = "flex";
        if (messageButtons) messageButtons.style.display = "flex";
        container.removeChild(editArea);
        container.removeChild(btnContainer);
      };
    }

    function getLastBotSender(currentUserMsgIndex) {
        if (currentMode !== 'group') return null;
        for (let i = currentUserMsgIndex - 1; i >= 0; i--) {
            if (allMessages[i].role === 'assistant' && allMessages[i].sender && characters[allMessages[i].sender]) {
                return allMessages[i].sender;
            }
        }
        return Object.keys(characters).length > 0 ? Object.keys(characters)[0] : null;
    }

    async function triggerBotResponseAfterEdit(editedUserMessageIndex, characterNameToRespond) {
        const charDataForApi = characters[characterNameToRespond];
        if (!charDataForApi) return;

        const historyUpToEdited = allMessages.slice(0, editedUserMessageIndex + 1);
        const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
        const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;

        if (allMessages.length > editedUserMessageIndex + 1) {
            allMessages.splice(editedUserMessageIndex + 1);
             if (currentMode === "personal") saveChat(getCurrentCharacterName(), allMessages);
             else saveRoomChat(allMessages);
            loadAndRenderMessages(editedUserMessageIndex);
        }

        const systemPromptText = getSystemContent(charDataForApi, allMessages[editedUserMessageIndex].content);

        if (useGoogleApi && googleApiKey && googleApiModel) {
            let geminiContents = [];
            historyUpToEdited.forEach(m => {
                let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
                let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${m.content}` : m.content;

                let parts = [];
                if (textContent) parts.push({ text: textContent });
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                    m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                    });
                } else if (m.attachments) {
                     parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }

                if (parts.length > 0) {
                     if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                        console.warn("Consecutive roles for Gemini (after edit), appending parts:", role);
                        geminiContents[geminiContents.length - 1].parts.push(...parts);
                    } else {
                        geminiContents.push({ role: role, parts: parts });
                    }
                }
            });
            let lastValidRoleAfterEdit = null;
            geminiContents = geminiContents.filter(item => {
                if (item.role === lastValidRoleAfterEdit) return false;
                lastValidRoleAfterEdit = item.role;
                return true;
            });

            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ systemPromptText (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã) —á—Ç–æ–±—ã Gemini —É—á–∏—Ç—ã–≤–∞–ª –∏—Ö —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
            try {
                const postEl = document.getElementById('post_history_instructions');
                const postInstr = postEl ? postEl.value.trim() : '';
                if (postInstr) {
                    // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü systemPromptText, –æ—Ç–¥–µ–ª—è—è –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                    systemPromptText = (systemPromptText ? systemPromptText + "\n\n" : "") + postInstr;
                }
            } catch(e){ console.error('post history instructions append error', e); }
        await fetchGeminiChatCompletion(
                googleApiKey, googleApiModel, systemPromptText, geminiContents,
                temperature, max_tokens, characterNameToRespond,
                allMessages, charDataForApi.avatarCharacter, true
            );

        } else {
            let messagesForAPI = [{ role: "system", content: systemPromptText }];
            messagesForAPI.push(...historyUpToEdited.map(m => {
                let apiMsgContentArray = [];
                if (m.content) apiMsgContentArray.push({ type: "text", text: m.content });
                // Append post-history instructions as system (if present)
                try {
                    const postEl = document.getElementById('post_history_instructions');
                    const postInstr = postEl ? postEl.value.trim() : '';
                    if (postInstr) {
                        messagesForAPI.push({ role: "system", content: postInstr });
                    }
                } catch(e){ console.error('post history instructions append error', e); }
                
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                    m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                         apiMsgContentArray.push({ type: "image_url", image_url: { url: att.src } });
                    });
                } else if (m.attachments) {
                     apiMsgContentArray.push({ type: "text", text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }
                const finalContent = apiMsgContentArray.length === 1 && apiMsgContentArray[0].type === "text" ? apiMsgContentArray[0].text : apiMsgContentArray;

                return {
                    role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                    content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${finalContent}` : finalContent
                };
            }));

            const apiKey = document.getElementById("apiKey").value;
            const apiUrl = document.getElementById("apiUrl").value;
            const modelForApi = charDataForApi.model || document.getElementById("model").value;

            await fetchChatCompletion(
                apiUrl, apiKey, modelForApi, messagesForAPI,
                temperature, max_tokens, characterNameToRespond,
                allMessages, charDataForApi.avatarCharacter, true
            );
        }
    }


    function updateMessageContent(index, newContent) {
      if (index < 0 || index >= allMessages.length) return;
      const msgToUpdate = allMessages[index];
      msgToUpdate.content = newContent;

      if (currentMode === "personal") {
        const name = getCurrentCharacterName();
        if (!name) return;
        saveChat(name, allMessages);
      } else {
        saveRoomChat(allMessages);
      }
      updateMessageInDOM(index, msgToUpdate);
    }

    function deleteMessage(index) {
      if (index < 0 || index >= allMessages.length) return;
      showCustomConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?", () => {
        allMessages.splice(index, 1);

        if (currentMode === "personal") {
          const name = getCurrentCharacterName();
          if (!name) return;
          saveChat(name, allMessages);
        } else {
          saveRoomChat(allMessages);
        }
        removeMessageFromDOM(index);
        clearVariants();
        if (allMessages.length === 0) {
            loadAndRenderMessages();
        }
      });
    }

    // --- Message Regeneration ---
    async function regenerateMessage(index) {
        if (isBotGenerating) return;
        if (index < 0 || index >= allMessages.length || allMessages[index].role !== 'assistant') {
            showCustomAlert("–ú–æ–∂–Ω–æ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.");
            return;
        }

        isBotGenerating = true;
        updateRegenerateButtonsState(true);
        setStatusActive(true);

        const characterForResponse = currentMode === "personal" ? getCurrentCharacterName() : allMessages[index].sender;
        if (!characterForResponse || !characters[characterForResponse]) {
            showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.");
            isBotGenerating = false; updateRegenerateButtonsState(false); setStatusActive(false);
            return;
        }
        const charData = characters[characterForResponse];

        let userMsgIndex = -1;
        for (let i = index - 1; i >= 0; i--) {
            const msg = allMessages[i];
            const isUserMsg = (currentMode === "personal" && msg.role === "user") ||
                              (currentMode === "group" && (msg.sender === "–í—ã" || msg.role === "user"));
            if (isUserMsg) {
                userMsgIndex = i;
                break;
            }
        }
        if (userMsgIndex === -1) {
            showCustomAlert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.");
            isBotGenerating = false; updateRegenerateButtonsState(false); setStatusActive(false);
            return;
        }

        if (regenerateVariants.length === 0 || currentVariantIndex === -1) {
            regenerateVariants = [JSON.parse(JSON.stringify(allMessages))];
            currentVariantIndex = 0;
        }

        const historyForAPI = allMessages.slice(0, index);
        const userMessageContentForSystem = allMessages[userMsgIndex].content;

        const targetMessageContainer = messagesBox.querySelector(`.message-container[data-index="${index}"]`);
        const messageDivToUpdate = targetMessageContainer ? targetMessageContainer.querySelector('.message') : null;

        if (messageDivToUpdate) {
            messageDivToUpdate.innerHTML = `<strong>${characterForResponse}:</strong> ...—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...`;
            scrollToBottom(true);
        }

        let newVariantChatState;

        try {
            let reply;
            const systemPromptText = getSystemContent(charData, userMessageContentForSystem);

            if (useGoogleApi && googleApiKey && googleApiModel) {
                let geminiContents = [];
                 historyForAPI.forEach(m => {
                    let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
                    let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${m.content}` : m.content;
                    let parts = [];
                    if (textContent) parts.push({ text: textContent });
                    if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                        m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                            parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                        });
                    } else if (m.attachments) {
                        parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                    }
                    if (parts.length > 0) {
                         if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                             console.warn("Consecutive roles for Gemini (regen), appending parts:", role);
                             geminiContents[geminiContents.length - 1].parts.push(...parts);
                         } else {
                            geminiContents.push({ role: role, parts: parts });
                         }
                    }
                });
                let lastValidRoleRegen = null;
                geminiContents = geminiContents.filter(item => {
                    if (item.role === lastValidRoleRegen) return false;
                    lastValidRoleRegen = item.role;
                    return true;
                });

                const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${googleApiModel}:generateContent?key=${googleApiKey}`;
                const geminiRequestBody = {
                    systemInstruction: { parts: [{ text: systemPromptText }] },
                    contents: geminiContents,
                    generationConfig: {
                        temperature: parseFloat(document.getElementById("temperature").value) || 0.7,
                        maxOutputTokens: parseInt(document.getElementById("maxTokens").value) || 1024
                    }
                };
                const response = await fetch(geminiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(geminiRequestBody)
                });
                if (!response.ok) throw new Error(`Google API –û—à–∏–±–∫–∞: ${response.status} ${await response.text()}`);
                const result = await response.json();
                reply = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (!reply && !(result.candidates && result.candidates[0].finishReason === "MAX_TOKENS")) throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Google API.");

                newVariantChatState = JSON.parse(JSON.stringify(allMessages.slice(0, index)));
                const newBotMsgData = {
                    ...allMessages[index],
                    content: reply,
                    attachments: null,
                };
                newVariantChatState.push(newBotMsgData);
                if (allMessages.length > index + 1) {
                    newVariantChatState.push(...JSON.parse(JSON.stringify(allMessages.slice(index + 1))));
                }
                regenerateVariants.push(newVariantChatState);
                currentVariantIndex = regenerateVariants.length - 1;
                allMessages = [...newVariantChatState];
                if (currentMode === "personal") saveChat(getCurrentCharacterName(), allMessages);
                else saveRoomChat(allMessages);
                updateMessageInDOM(index, allMessages[index]);
                scrollToBottom(true);
                shouldScrollToBottom = false;

            } else {
                shouldScrollToBottom = true;
                let messagesForStdAPI = [{ role: "system", content: systemPromptText }];
                messagesForStdAPI.push(...historyForAPI.map(m => {
                     let apiContentArray = [];
                     if (m.content) apiContentArray.push({ type: "text", text: m.content });
                // Append '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏' –∫–∞–∫ system-—Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ)
                try {
                    const postEl = document.getElementById('post_history_instructions');
                    const postInstr = postEl ? postEl.value.trim() : '';
                    if (postInstr) {
                        messagesForStdAPI.push({ role: "system", content: postInstr });
                    }
                } catch(e){ console.error('post history instructions append error', e); }
                
                     if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                         m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                              apiContentArray.push({ type: "image_url", image_url: { url: att.src } });
                         });
                     } else if (m.attachments) {
                         apiContentArray.push({ type: "text", text: ` [–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                     }
                     const finalContent = apiContentArray.length === 1 && apiContentArray[0].type === "text" ? apiContentArray[0].text : apiContentArray;
                    return {
                        role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                        content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${finalContent}` : finalContent
                    };
                }));

                const apiKey = document.getElementById("apiKey").value;
                const apiUrl = document.getElementById("apiUrl").value;
                const model = charData.model || document.getElementById("model").value;
                const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
                const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model, messages: messagesForStdAPI, stream: true, max_tokens, temperature })
                });
                if (!response.ok) throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status} ${await response.text()}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let streamedContent = "";
                reply = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n").filter(line => line.trim().startsWith("data: "));
                    for (const line of lines) {
                        if (line.includes("[DONE]")) break;
                        const jsonString = line.replace(/^data: /, "");
                        try {
                            const parsed = JSON.parse(jsonString);
                            const content = parsed.choices?.[0]?.delta?.content;
                            if (content) {
                                streamedContent += content;
                                reply = removeThoughts(streamedContent);
                                if (messageDivToUpdate) {
                                    messageDivToUpdate.innerHTML = `<strong>${characterForResponse}:</strong>${marked.parse(reply)}`;
                                    scrollToBottom(true);
                                }
                            }
                        } catch (e) { /* console.warn("Stream parsing error:", e, jsonString); */ }
                    }
                }
                if (!reply && streamedContent) reply = removeThoughts(streamedContent);

                newVariantChatState = JSON.parse(JSON.stringify(allMessages.slice(0, index)));
                const newBotMsgDataStreaming = {
                    ...allMessages[index],
                    content: reply,
                    attachments: null,
                };
                newVariantChatState.push(newBotMsgDataStreaming);
                if (allMessages.length > index + 1) {
                    newVariantChatState.push(...JSON.parse(JSON.stringify(allMessages.slice(index + 1))));
                }
                regenerateVariants.push(newVariantChatState);
                currentVariantIndex = regenerateVariants.length - 1;
                allMessages = [...newVariantChatState];
                if (currentMode === "personal") saveChat(getCurrentCharacterName(), allMessages);
                else saveRoomChat(allMessages);
                if (!messageDivToUpdate) {
                    updateMessageInDOM(index, allMessages[index]);
                }
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:", err);
            if (messageDivToUpdate) {
                 const originalMessageOfCurrentVariant = regenerateVariants[currentVariantIndex] ? regenerateVariants[currentVariantIndex][index] : null;
                 const veryFirstOriginalMessage = regenerateVariants[0] ? regenerateVariants[0][index] : null;
                 const messageToRevertTo = originalMessageOfCurrentVariant || veryFirstOriginalMessage;

                 if (messageToRevertTo) {
                    updateMessageInDOM(index, messageToRevertTo);
                    allMessages[index] = JSON.parse(JSON.stringify(messageToRevertTo));
                 } else {
                    messageDivToUpdate.innerHTML = `<strong>${characterForResponse}:</strong> –û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${err.message}`;
                 }
            } else {
                appendNewMessageToDOM({ sender: "–°–∏—Å—Ç–µ–º–∞", content: `–û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${err.message}`, role: "system" }, allMessages.length);
            }
        } finally {
            setStatusActive(false);
            isBotGenerating = false;
            updateRegenerateButtonsState(false);
            updateVariantControls();
            if (shouldScrollToBottom) { scrollToBottom(true); shouldScrollToBottom = false; }
            userInput.focus();
        }
    }


    function updateRegenerateButtonsState(disable) {
        const regenBtns = document.querySelectorAll('.message-buttons .regen-btn');
        regenBtns.forEach(btn => btn.disabled = disable);
    }


    function renderSpecificChatState(chatState) {
        messagesBox.innerHTML = "";
        const fragment = document.createDocumentFragment();
        chatState.forEach((msg, i) => {
            const container = createMessageContainerDOM(msg, i);
            fragment.appendChild(container);
        });
        messagesBox.appendChild(fragment);
        scrollToBottom(true);
    }


    function updateVariantControls() {
      const hasVariants = regenerateVariants.length > 1;
      [prevVariantBtn, nextVariantBtn, applyVariantBtn, variantCounter].forEach(el => {
          if (el) el.style.display = hasVariants ? "inline-block" : "none";
      });
      if (!hasVariants) {
        if (variantCounter) variantCounter.textContent = "";
        if(prevVariantBtn) prevVariantBtn.disabled = true;
        if(nextVariantBtn) nextVariantBtn.disabled = true;
        return;
      }
      if (currentVariantIndex < 0 && regenerateVariants.length > 0) currentVariantIndex = 0;
      if (currentVariantIndex >= regenerateVariants.length) currentVariantIndex = regenerateVariants.length - 1;

      if (variantCounter) variantCounter.textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${currentVariantIndex + 1} / ${regenerateVariants.length}`;
      if (prevVariantBtn) prevVariantBtn.disabled = currentVariantIndex === 0;
      if (nextVariantBtn) nextVariantBtn.disabled = currentVariantIndex === regenerateVariants.length - 1;
    }
    function prevVariant() { if (currentVariantIndex > 0) { currentVariantIndex--; renderVariant(); updateVariantControls(); } }
    function nextVariant() { if (currentVariantIndex < regenerateVariants.length - 1) { currentVariantIndex++; renderVariant(); updateVariantControls(); } }
    function applyVariant() {
      if (currentVariantIndex < 0 || currentVariantIndex >= regenerateVariants.length) return;
      const variantToApply = regenerateVariants[currentVariantIndex];
      allMessages = [...variantToApply];

      if (currentMode === "personal") {
        const name = getCurrentCharacterName();
        if (!name) return;
        saveChat(name, allMessages);
      } else {
        saveRoomChat(allMessages);
      }
      clearVariantsAndRender();
    }
    function renderVariant() {
      if (currentVariantIndex < 0 || currentVariantIndex >= regenerateVariants.length) return;
      renderSpecificChatState(regenerateVariants[currentVariantIndex]);
    }
    function clearVariants() { regenerateVariants = []; currentVariantIndex = -1; updateVariantControls(); }
    function clearVariantsAndRender() {
        clearVariants();
        shouldScrollToBottom = true;
        loadAndRenderMessages();
    }


    function getNeuralMemory() { return document.getElementById("neuralMemory").value.trim(); }

    function getSystemContent(charData, userMessage) {
        const memory = getNeuralMemory();
        const dateTime = new Date().toLocaleString('ru-RU', { dateStyle: 'full', timeStyle: 'short' });
        const dateTimeInfo = `[–¢–µ–∫—É—â–∏–µ –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è]: ${dateTime}`;

        // Build a comprehensive character definition string
        let characterDefinition = "";
        if (charData.description) characterDefinition += `[–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞]\n${charData.description}\n\n`;
        if (charData.personality) characterDefinition += `[–õ–∏—á–Ω–æ—Å—Ç—å]\n${charData.personality}\n\n`;
        if (charData.scenario) characterDefinition += `[–°—Ü–µ–Ω–∞—Ä–∏–π]\n${charData.scenario}\n\n`;
        if (charData.mes_example) characterDefinition += `[–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞]\n${charData.mes_example}\n\n`;

        // Start building the final system prompt
        let systemContent = `${characterDefinition.trim()}\n\n${dateTimeInfo}`;

        if (memory) {
            systemContent += `\n\n[–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏)]:\n${memory}`;
        }

        // Add character's specific system_prompt if it exists
        if (charData.system_prompt) {
            systemContent += `\n\n[–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]\n${charData.system_prompt}`;
        }

        // Check lorebook entries against the user's message
        if (charData.lorebook && charData.lorebook.length > 0 && userMessage) {
            const triggeredEntries = charData.lorebook.filter(entry =>
                entry.triggers && entry.triggers.some(trigger => userMessage.toLowerCase().includes(trigger.toLowerCase().trim()))
            );
            if (triggeredEntries.length > 0) {
                const loreInfo = triggeredEntries.map(entry => {
                    let entryPrefix = "- ";
                    if (entry.entryName) {
                        entryPrefix = `- [${entry.entryName}]: `;
                    }
                    return `${entryPrefix}${entry.info}`;
                }).join("\n");
                systemContent += `\n\n[–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ Lorebook (–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)]:\n${loreInfo}`;
            }
        }
        return systemContent.trim();
    }


    async function sendToRestApi(userMessageContent, attachmentsArray = null) {
        if (!restApiUrlValue) {
            appendNewMessageToDOM({sender:"–°–∏—Å—Ç–µ–º–∞", content:"URL REST API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.", role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"}, allMessages.length);
            return;
        }
        setStatusActive(true);
        const apiPlaceholderAvatar = "https://placehold.co/80x80/80D0C0/FFFFFF?text=A";
        const placeholderMsgData = {sender:"API", content:"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ REST API...", role:"api", avatar: apiPlaceholderAvatar, attachments: attachmentsArray};
        allMessages.push(placeholderMsgData);
        appendNewMessageToDOM(placeholderMsgData, allMessages.length -1);


        try {
            const requestBody = { message: userMessageContent, attachments: attachmentsArray };
            const response = await fetch(restApiUrlValue, {
                method: "POST",
                headers: { "Content-Type": "application/json", ...restApiHeadersValue },
                body: JSON.stringify(requestBody)
            });

            const placeholderIndex = allMessages.findIndex(m => m.content === "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ REST API..." && m.sender === "API");
            if (placeholderIndex > -1) {
                allMessages.splice(placeholderIndex, 1);
                removeMessageFromDOM(placeholderIndex);
            }


            const responseData = await response.json();
            if (!response.ok) throw new Error(`API –û—à–∏–±–∫–∞: ${response.status} - ${responseData.error || JSON.stringify(responseData)}`);

            let apiReplyText = responseData.reply || responseData.message || JSON.stringify(responseData.data) || JSON.stringify(responseData);
            const apiReplyMsgData = {sender:"API", content:apiReplyText, role:"api", avatar: apiPlaceholderAvatar, attachments: responseData.attachments};
            allMessages.push(apiReplyMsgData);
            appendNewMessageToDOM(apiReplyMsgData, allMessages.length - 1);


        } catch (error) {
            console.error("REST API –û—à–∏–±–∫–∞:", error);
            const placeholderIndexOnError = allMessages.findIndex(m => m.content === "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ REST API..." && m.sender === "API");
            if (placeholderIndexOnError > -1) {
                 allMessages.splice(placeholderIndexOnError, 1);
                removeMessageFromDOM(placeholderIndexOnError);
            }
            const errorMsgData = {sender:"–°–∏—Å—Ç–µ–º–∞", content:`–û—à–∏–±–∫–∞ REST API: ${error.message}`, role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
            allMessages.push(errorMsgData);
            appendNewMessageToDOM(errorMsgData, allMessages.length - 1);

        } finally {
            setStatusActive(false);
            scrollToBottom(true);
            userInput.focus();
        }
    }
    function setupRestApiSwitch() {
        const enableRestApiCheckbox = document.getElementById("enableRestApi");
        enableRestApiCheckbox.addEventListener("change", () => {
            useRestApi = enableRestApiCheckbox.checked;
            saveToStorage(ENABLE_REST_API_STORAGE, useRestApi.toString());
        });
    }

    async function respondToLastMessage(characterName) {
      if (isBotGenerating) return;
      isBotGenerating = true;
      updateRegenerateButtonsState(true);

      const currentGroupMessages = [...allMessages];
      if (currentGroupMessages.length === 0) {
          showCustomAlert("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–≤–µ—Ç–∞.");
          isBotGenerating = false; updateRegenerateButtonsState(false); return;
      }
      if (!characters[characterName]) {
          showCustomAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${characterName}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
          isBotGenerating = false; updateRegenerateButtonsState(false); return;
      }

      const charData = characters[characterName];
      let lastUserMessageForContext = "";
      let lastUserMessageAttachments = null;
      for (let i = currentGroupMessages.length -1; i >= 0; i--) {
          if ((currentGroupMessages[i].sender === "–í—ã" || currentGroupMessages[i].role === "user")) {
              lastUserMessageForContext = currentGroupMessages[i].content;
              lastUserMessageAttachments = currentGroupMessages[i].attachments;
              break;
          }
      }

      const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
      const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;
      const systemPromptText = getSystemContent(charData, lastUserMessageForContext);


      if (useGoogleApi && googleApiKey && googleApiModel) {
        let geminiContents = [];
        currentGroupMessages.forEach(m => {
            let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
            let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender) ? `${m.sender}: ${m.content}` : m.content;

            let parts = [];
            if (textContent) parts.push({ text: textContent });
            if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                 m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                    parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                 });
            } else if (m.attachments) {
                parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
            }

            if (parts.length > 0) {
                 if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                     console.warn("Consecutive roles for Gemini (respondToLast), appending parts:", role);
                     geminiContents[geminiContents.length - 1].parts.push(...parts);
                 } else {
                    geminiContents.push({ role: role, parts: parts });
                 }
            }
        });
        let lastValidRoleGroup = null;
        geminiContents = geminiContents.filter(item => {
            if (item.role === lastValidRoleGroup) return false;
            lastValidRoleGroup = item.role;
            return true;
        });

        await fetchGeminiChatCompletion(
            googleApiKey, googleApiModel, systemPromptText, geminiContents,
            temperature, max_tokens, characterName, allMessages, charData.avatarCharacter
        );

      } else {
        const model = charData.model || document.getElementById("model").value;
        const apiKey = document.getElementById("apiKey").value;
        const apiUrl = document.getElementById("apiUrl").value;
        const messagesForAPI = [
          { role: "system", content: systemPromptText },
          ...currentGroupMessages.map(m => {
              let apiContentArray = [];
              if (m.content) apiContentArray.push({ type: "text", text: m.content });
              if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                   m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        apiContentArray.push({ type: "image_url", image_url: { url: att.src } });
                   });
              } else if (m.attachments) {
                  apiContentArray.push({ type: "text", text: ` [–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
              }

              const finalContent = apiContentArray.length === 1 && apiContentArray[0].type === "text" ? apiContentArray[0].text : apiContentArray;
              return {
                  role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                  content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender) ? `${m.sender}: ${finalContent}` : finalContent
              }
          })
        ];
        await fetchChatCompletion(apiUrl, apiKey, model, messagesForAPI, temperature, max_tokens, characterName, allMessages, charData.avatarCharacter);
      }
    }


    async function sendMessage() {
        if (isBotGenerating && !useRestApi && !(useGoogleApi && googleApiKey && googleApiModel) ) {
            return;
        }

        const messageContent = userInput.value.trim();
        if (!messageContent && attachedFiles.length === 0) return;

        clearVariants();
        const originalPlaceholder = userInput.placeholder;
        userInput.value = "";
        userInput.placeholder = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
        userInput.disabled = true;
        userInput.style.height = 'auto';
        userInput.style.height = (userInput.scrollHeight) + 'px';


        let userAvatarUrl;
        let activeCharNameForUserMsg = getCurrentCharacterName();
        let attachmentsDataArray = [];

        if (attachedFiles.length > 0) {
            for (const file of attachedFiles) {
                 attachmentsDataArray.push({
                    name: file.name,
                    type: file.type,
                    src: await readFileAsDataURL(file)
                });
            }
        }

        const userMsgObject = {
            role: "user",
            content: messageContent,
            attachments: attachmentsDataArray.length > 0 ? attachmentsDataArray : null
        };

        if (currentMode === "personal") {
            if (!activeCharNameForUserMsg) {
                showCustomAlert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.");
                userInput.placeholder = originalPlaceholder; userInput.disabled = false; userInput.focus(); return;
            }
            userAvatarUrl = characters[activeCharNameForUserMsg]?.avatarUser || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
            userMsgObject.avatar = userAvatarUrl;
            allMessages.push(userMsgObject);
            saveChat(activeCharNameForUserMsg, allMessages);
        } else {
            const anyUserAvatar = Object.values(characters).find(c => c.avatarUser)?.avatarUser;
            userAvatarUrl = anyUserAvatar || "https://placehold.co/80x80/7AC5FF/FFFFFF?text=–í—ã";
            userMsgObject.sender = "–í—ã";
            userMsgObject.avatar = userAvatarUrl;
            allMessages.push(userMsgObject);
            saveRoomChat(allMessages);
        }

        appendNewMessageToDOM(userMsgObject, allMessages.length - 1);
        shouldScrollToBottom = true;

        attachedFiles = [];
        renderFilePreviews();
        document.getElementById("fileInput").value = "";

        const temperature = parseFloat(document.getElementById("temperature").value) || 0.7;
        const max_tokens = parseInt(document.getElementById("maxTokens").value) || 1024;

        let charToRespondName, charDataForApi, systemContextMsgForLLM;
        if (currentMode === "personal") {
            charToRespondName = activeCharNameForUserMsg;
            charDataForApi = characters[charToRespondName];
            systemContextMsgForLLM = messageContent;
        } else {
            let lastBotSender = null;
            for (let i = allMessages.length - 2; i >= 0; i--) {
                if (allMessages[i].role === 'assistant' && allMessages[i].sender && characters[allMessages[i].sender]) {
                    lastBotSender = allMessages[i].sender; break;
                }
            }
            charToRespondName = lastBotSender || (Object.keys(characters).length > 0 ? Object.keys(characters)[0] : null);
            if (!charToRespondName || !characters[charToRespondName]) {
                const sysMsg = {sender:"–°–∏—Å—Ç–µ–º–∞", content:"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ.", role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
                allMessages.push(sysMsg); appendNewMessageToDOM(sysMsg, allMessages.length - 1);
                userInput.placeholder = originalPlaceholder; userInput.disabled = false; userInput.focus(); return;
            }
            charDataForApi = characters[charToRespondName];
            systemContextMsgForLLM = messageContent;
        }

        const systemPromptText = getSystemContent(charDataForApi, systemContextMsgForLLM);

        if (useGoogleApi && googleApiKey && googleApiModel) {
            isBotGenerating = true;
            updateRegenerateButtonsState(true);
            setStatusActive(true);
            shouldScrollToBottom = true;

            let geminiContents = [];
            allMessages.forEach(m => {
                let role = (m.sender === "–í—ã" || m.role === "user") ? "user" : "model";
                let textContent = (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${m.content}` : m.content;

                let parts = [];
                if (textContent) parts.push({ text: textContent });
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                     m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        parts.push({ inlineData: { mimeType: att.type, data: att.src.split(',')[1] } });
                     });
                } else if (m.attachments) {
                    parts.push({ text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }


                if (parts.length > 0) {
                    if (geminiContents.length > 0 && geminiContents[geminiContents.length - 1].role === role) {
                        console.warn("Consecutive roles for Gemini (send), appending parts:", role);
                         geminiContents[geminiContents.length - 1].parts.push(...parts);
                    } else {
                        geminiContents.push({ role: role, parts: parts });
                    }
                }
            });
            let lastValidRoleSend = null;
            geminiContents = geminiContents.filter(item => {
                if (item.role === lastValidRoleSend) return false;
                lastValidRoleSend = item.role;
                return true;
            });


            await fetchGeminiChatCompletion(
                googleApiKey, googleApiModel, systemPromptText, geminiContents,
                temperature, max_tokens, charToRespondName, allMessages, charDataForApi.avatarCharacter
            );


        } else if (useRestApi && restApiUrlValue) {
            shouldScrollToBottom = true;
            await sendToRestApi(messageContent, attachmentsDataArray);
        } else {
            isBotGenerating = true;
            updateRegenerateButtonsState(true);
            setStatusActive(true);
            shouldScrollToBottom = true;

            let messagesForAPI = [{ role: "system", content: systemPromptText }];
            messagesForAPI.push(...allMessages.map(m => {
                let apiMsgContentArray = [];
                if (m.content) apiMsgContentArray.push({ type: "text", text: m.content });
                if (m.attachments && m.attachments.some(att => att.type.startsWith('image/') && att.src.startsWith('data:image'))) {
                     m.attachments.filter(att => att.type.startsWith('image/') && att.src.startsWith('data:image')).forEach(att => {
                        apiMsgContentArray.push({ type: "image_url", image_url: { url: att.src } });
                     });
                } else if (m.attachments) {
                    apiMsgContentArray.push({ type: "text", text: `[–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ ${m.attachments.length} —Ñ–∞–π–ª–æ–≤]` });
                }

                const finalContent = apiMsgContentArray.length === 1 && apiMsgContentArray[0].type === "text" ? apiMsgContentArray[0].text : apiMsgContentArray;
                return {
                    role: (m.sender === "–í—ã" || m.role === "user") ? "user" : "assistant",
                    content: (m.sender !== "–í—ã" && m.role !== "user" && m.sender && currentMode === 'group') ? `${m.sender}: ${finalContent}` : finalContent
                };
            }));

            const apiKey = document.getElementById("apiKey").value;
            const apiUrl = document.getElementById("apiUrl").value;
            const modelForApi = charDataForApi.model || document.getElementById("model").value;

            await fetchChatCompletion(apiUrl, apiKey, modelForApi, messagesForAPI, temperature, max_tokens, charToRespondName, allMessages, charDataForApi.avatarCharacter);
        }
        userInput.placeholder = originalPlaceholder; userInput.disabled = false;
        userInput.focus(); // Keep focus on the input field
    }

    async function fetchGeminiChatCompletion(gApiKey, gModel, systemInstructionText, geminiContents, temperature, maxOutputTokens, apiCharacterName, chatArrayToUpdateRef, botAvatarUrl, isAfterEdit = false) {
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${gModel}:generateContent?key=${gApiKey}`;

        const requestBody = {
            systemInstruction: { parts: [{ text: systemInstructionText }] },
            contents: geminiContents,
            generationConfig: {
                temperature: temperature,
                maxOutputTokens: maxOutputTokens
            }
        };

        setStatusActive(true);

        const placeholderMsgData = { content: "...", role: "assistant", avatar: botAvatarUrl, attachments: null };
        if (currentMode === "group") {
            placeholderMsgData.sender = apiCharacterName;
        }

        let placeholderIndex = -1;
        if (!isAfterEdit) {
            chatArrayToUpdateRef.push(placeholderMsgData);
            placeholderIndex = chatArrayToUpdateRef.length - 1;
            appendNewMessageToDOM(placeholderMsgData, placeholderIndex);
        } else {
             chatArrayToUpdateRef.push(placeholderMsgData);
             placeholderIndex = chatArrayToUpdateRef.length - 1;
             appendNewMessageToDOM(placeholderMsgData, placeholderIndex);
        }


        try {
            const response = await fetch(geminiApiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`Google API –û—à–∏–±–∫–∞: ${response.status} - ${errorBody}`);
            }
            const result = await response.json();
            const reply = result.candidates?.[0]?.content?.parts?.[0]?.text || "";

            if (!reply && !(result.candidates && result.candidates[0].finishReason === "MAX_TOKENS")) {
                 throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Google API –∏–ª–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
            }

            chatArrayToUpdateRef[placeholderIndex].content = reply;
            chatArrayToUpdateRef[placeholderIndex].attachments = null;
            if (currentMode === "group") {
                 chatArrayToUpdateRef[placeholderIndex].sender = apiCharacterName;
            }

            updateMessageInDOM(placeholderIndex, chatArrayToUpdateRef[placeholderIndex]);
            scrollToBottom(true);
            shouldScrollToBottom = false;

            if (currentMode === "personal") saveChat(getCurrentCharacterName(), chatArrayToUpdateRef);
            else saveRoomChat(chatArrayToUpdateRef);

        } catch (err) {
            console.error("fetchGeminiChatCompletion –û—à–∏–±–∫–∞:", err);
            if (chatArrayToUpdateRef[placeholderIndex] && chatArrayToUpdateRef[placeholderIndex].content === "...") {
                chatArrayToUpdateRef.splice(placeholderIndex, 1);
                removeMessageFromDOM(placeholderIndex);
            }
            const errorMsgData = {sender:"–°–∏—Å—Ç–µ–º–∞", content:`–û—à–∏–±–∫–∞ Google Gemini API: ${err.message}`, role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
            chatArrayToUpdateRef.push(errorMsgData);
            appendNewMessageToDOM(errorMsgData, chatArrayToUpdateRef.length - 1);
        } finally {
            setStatusActive(false);
            isBotGenerating = false;
            updateRegenerateButtonsState(false);
            if (shouldScrollToBottom) { scrollToBottom(true); shouldScrollToBottom = false; }
            userInput.focus();
        }
    }


    async function fetchChatCompletion(apiUrl, apiKey, model, messagesForAPI, temperature, max_tokens, apiCharacterName, chatArrayToUpdateRef, botAvatarUrl, isAfterEdit = false) {
      const requestBody = { model, messages: messagesForAPI, stream: true, max_tokens, temperature };
      setStatusActive(true);
      shouldScrollToBottom = true;

      const placeholderMsgData = { content: "...", role: "assistant", avatar: botAvatarUrl, attachments: null };
      if (currentMode === "group") {
          placeholderMsgData.sender = apiCharacterName;
      }

      chatArrayToUpdateRef.push(placeholderMsgData);
      const placeholderIndex = chatArrayToUpdateRef.length - 1;
      appendNewMessageToDOM(placeholderMsgData, placeholderIndex);

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
          body: JSON.stringify(requestBody)
        });
        if (!response.ok) throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status} ${await response.text()}`);

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let reply = "", streamedContent = "";

        const streamingMessageContainer = messagesBox.querySelector(`.message-container[data-index="${placeholderIndex}"]`);
        const streamingMessageDiv = streamingMessageContainer?.querySelector(".message");


        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split("\n").filter(line => line.trim().startsWith("data: "));
          for (const line of lines) {
            if (line.includes("[DONE]")) break;
            const jsonString = line.replace(/^data: /, "");
            try {
              const parsed = JSON.parse(jsonString);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                streamedContent += content;
                reply = removeThoughts(streamedContent);
                if (streamingMessageDiv) {
                  streamingMessageDiv.innerHTML = `<strong>${apiCharacterName}:</strong>${marked.parse(reply)}`;
                  scrollToBottom(true);
                }
              }
            } catch (e) { /* console.warn("Stream parsing error:", e, jsonString); */ }
          }
        }
        if (!reply && streamedContent) reply = removeThoughts(streamedContent);

        chatArrayToUpdateRef[placeholderIndex].content = reply;
        chatArrayToUpdateRef[placeholderIndex].attachments = null;
        if (currentMode === "group") {
            chatArrayToUpdateRef[placeholderIndex].sender = apiCharacterName;
        }

        if (!streamingMessageDiv) {
            updateMessageInDOM(placeholderIndex, chatArrayToUpdateRef[placeholderIndex]);
        }

        if (currentMode === "personal") saveChat(getCurrentCharacterName(), chatArrayToUpdateRef);
        else saveRoomChat(chatArrayToUpdateRef);


      } catch (err) {
        console.error("fetchChatCompletion –û—à–∏–±–∫–∞:", err);
        if (chatArrayToUpdateRef[placeholderIndex] && chatArrayToUpdateRef[placeholderIndex].content === "...") {
            chatArrayToUpdateRef.splice(placeholderIndex, 1);
            removeMessageFromDOM(placeholderIndex);
        }
        const errorMsgData = {sender:"–°–∏—Å—Ç–µ–º–∞", content:`–û—à–∏–±–∫–∞ LLM: ${err.message}`, role:"system", avatar:"https://placehold.co/80x80/CCCCCC/FFFFFF?text=S"};
        chatArrayToUpdateRef.push(errorMsgData);
        appendNewMessageToDOM(errorMsgData, chatArrayToUpdateRef.length - 1);

      } finally {
        setStatusActive(false);
        isBotGenerating = false;
        updateRegenerateButtonsState(false);
        if (shouldScrollToBottom) { scrollToBottom(true); shouldScrollToBottom = false; }
      }
    }


    function removeThoughts(text) { return text.replace(/<think>[\s\S]*?<\/think>/g, '').trim(); }

    function clearMessages() {
      showCustomConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.", () => {
        let initialMessages = [];
        if (currentMode === "personal") {
          const name = getCurrentCharacterName();
          if (!name) return;
          const charData = characters[name];
          if (charData && charData.welcomeMessage) {
              initialMessages.push({ role: "assistant", content: charData.welcomeMessage, avatar: charData.avatarCharacter, attachments: null });
          }
          saveChat(name, initialMessages);
        } else {
          saveRoomChat(initialMessages);
        }
        shouldScrollToBottom = true;
        loadAndRenderMessages();
        clearVariants();
      });
    }

    function exportCharacterData() {
      const name = getCurrentCharacterName();
      if (!name || !characters[name]) return showCustomAlert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");

      const charData = characters[name];
      const chatHistory = loadChat(name);

      const dataToExport = {
        spec: "chara_card_v2",
        spec_version: "2.0",
        data: {
            name: charData.name || "",
            description: charData.description || "",
            personality: charData.personality || "",
            scenario: charData.scenario || "",
            first_mes: charData.welcomeMessage || "",
            mes_example: charData.mes_example || "",
            creator_notes: charData.creator_notes || "",
            system_prompt: charData.system_prompt || "",
            post_history_instructions: charData.post_history_instructions || "",
            alternate_greetings: charData.alternate_greetings || [],
            tags: [], // Tags not implemented in UI yet
            creator: "", // Creator not implemented in UI yet
            character_version: "", // Version not implemented in UI yet
            avatar: "none", // Placeholder, actual avatar is in our app's format
            extensions: {}
        }
      };

      const fullExportData = {
          character: charData,
          messages: chatHistory,
          version: "2.0",
          format: "llm_chatbot_rp_v3_full",
          tavern_card: dataToExport
      };

      const blob = new Blob([JSON.stringify(fullExportData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `${name}_–ø–µ—Ä—Å–æ–Ω–∞–∂_–∏_—á–∞—Ç.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showCustomAlert(`–î–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${name}" –∏ –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.`);
    }

    function importCharacterData() { document.getElementById("jsonFileInput").click(); }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedJson = JSON.parse(e.target.result);
          let charDataToProcess;

          // Check for our app's full format first
          if (importedJson.format === "llm_chatbot_rp_v3_full" && importedJson.character) {
              console.log("Importing llm_chatbot_rp_v3_full format");
              charDataToProcess = {
                  character: importedJson.character,
                  messages: importedJson.messages || [],
              };
          }
          // Then check for standard TavernAI/Chub format
          else if (importedJson.spec === "chara_card_v2" && importedJson.data) {
            console.log("Importing chara_card_v2 format");
            const tavernData = importedJson.data;
            charDataToProcess = {
              character: {
                name: tavernData.name || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π",
                description: tavernData.description || "",
                personality: tavernData.personality || "",
                scenario: tavernData.scenario || "",
                mes_example: tavernData.mes_example || "",
                welcomeMessage: tavernData.first_mes || "",
                alternate_greetings: tavernData.alternate_greetings || [],
                system_prompt: tavernData.system_prompt || "",
                post_history_instructions: tavernData.post_history_instructions || "",
                creator_notes: tavernData.creator_notes || "",
                avatarCharacter: tavernData.avatar || "https://placehold.co/100x100/FF7AAC/FFFFFF?text=–ë–æ—Ç", // Use TavernAI avatar or default
                avatarUser: document.getElementById("avatarUrl_user").value || "https://placehold.co/100x100/7AC5FF/FFFFFF?text=–í—ã",
                model: document.getElementById("characterModel").value || document.getElementById("model").value,
                lorebook: [],
              },
              messages: [],
              _tavernData: tavernData // Keep original data for reference
            };

            if (tavernData.character_book && tavernData.character_book.entries) {
                charDataToProcess.character.lorebook = tavernData.character_book.entries.map(entry => ({
                    entryName: entry.name || "",
                    triggers: entry.keys || [],
                    info: entry.content || ""
                })).filter(lbEntry => (lbEntry.triggers.length > 0 && lbEntry.info) || lbEntry.entryName);
            }
          } else {
            throw new Error("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ JSON.");
          }

          tempImportedCharacterData = charDataToProcess;

          if (charDataToProcess._tavernData) {
            const greetings = [];
            if (charDataToProcess._tavernData.first_mes) greetings.push(charDataToProcess._tavernData.first_mes);
            if (charDataToProcess._tavernData.alternate_greetings && charDataToProcess._tavernData.alternate_greetings.length > 0) {
                greetings.push(...charDataToProcess._tavernData.alternate_greetings);
            }

            if (greetings.length > 1) {
                openGreetingModal(charDataToProcess.character.name, greetings); return;
            } else if (greetings.length === 1) {
                charDataToProcess.character.welcomeMessage = greetings[0];
            }
          }
          finalizeImport(charDataToProcess);

        } catch (err) {
          showCustomAlert(`–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞: ${err.message}`); console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", err);
          tempImportedCharacterData = null;
        } finally {
            event.target.value = null;
        }
      };
      reader.readAsText(file);
    }

    function finalizeImport(dataToImport) {
        if (!dataToImport || !dataToImport.character) {
            console.error("–î–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ–ø–æ–ª–Ω—ã–µ.");
            showCustomAlert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–º–ø–æ—Ä—Ç, –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ.");
            return;
        }
        const charData = dataToImport.character;
        const charName = charData.name;

        // Ensure all fields exist on the object to prevent errors
        const fullCharData = {
          name: charName,
          description: charData.description || "",
          personality: charData.personality || "",
          scenario: charData.scenario || "",
          mes_example: charData.mes_example || "",
          welcomeMessage: charData.welcomeMessage || "",
          alternate_greetings: charData.alternate_greetings || [],
          system_prompt: charData.system_prompt || "",
          post_history_instructions: charData.post_history_instructions || "",
          creator_notes: charData.creator_notes || "",
          model: charData.model || document.getElementById("model").value,
          avatarCharacter: charData.avatarCharacter || "https://placehold.co/100x100/FF7AAC/FFFFFF?text=–ë–æ—Ç",
          avatarUser: charData.avatarUser || document.getElementById("avatarUrl_user").value || "https://placehold.co/100x100/7AC5FF/FFFFFF?text=–í—ã",
          lorebook: charData.lorebook || [],
          backgroundImage: charData.backgroundImage || null
        };

        characters[charName] = fullCharData;
        saveChat(charName, dataToImport.messages || []);
        localStorage.setItem("characters_v3", JSON.stringify(characters));

        populateCharacterSelect();
        setActiveCharacter(charName);
        document.getElementById("characterSelect").value = charName;

        showCustomAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ "${charName}" —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
        closeSettingsModal();
        tempImportedCharacterData = null;
    }


    function setupFileAttach() {
        const hiddenFileInput = document.getElementById("fileInput");
        if(hiddenFileInput) {
            hiddenFileInput.addEventListener("change", (event) => {
                if (event.target.files.length > 0) {
                    Array.from(event.target.files).forEach(file => attachedFiles.push(file));
                    renderFilePreviews();
                    userInput.placeholder = `${attachedFiles.length} —Ñ–∞–π–ª(–æ–≤) –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ.`;
                }
                event.target.value = null;
            });
        }
    }

    function renderFilePreviews() {
        filePreviewsContainer.innerHTML = "";
        if (attachedFiles.length === 0) {
            filePreviewsContainer.style.display = "none";
            if (!userInput.value.trim()) {
                 userInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
            }
            return;
        }
        filePreviewsContainer.style.display = "flex";

        attachedFiles.forEach((file, index) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'file-preview-item';

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = '–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                attachedFiles.splice(index, 1);
                renderFilePreviews();
                 if (attachedFiles.length > 0) {
                    userInput.placeholder = `${attachedFiles.length} —Ñ–∞–π–ª(–æ–≤) –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ.`;
                } else if (!userInput.value.trim()) {
                     userInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
                }
            };
            previewItem.appendChild(removeBtn);

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => URL.revokeObjectURL(img.src);
                previewItem.appendChild(img);
            } else {
                const icon = document.createElement('div');
                icon.className = 'file-icon-placeholder';
                icon.textContent = 'üìÑ';
                previewItem.appendChild(icon);
            }
            const fileName = document.createElement('div');
            fileName.className = 'file-info';
            fileName.textContent = file.name;
            fileName.title = file.name;
            previewItem.appendChild(fileName);

            filePreviewsContainer.appendChild(previewItem);
        });
    }


    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }


    function renderLorebookEntries(characterName) {
      const container = document.getElementById("lorebookEntries");
      container.innerHTML = "";
      const character = characters[characterName];
      if (!character || !character.lorebook || character.lorebook.length === 0) {
        container.innerHTML = "<p style='font-style:italic; opacity:0.7;'>–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</p>"; return;
      }
      character.lorebook.forEach((entry, index) => {
        const entryDiv = document.createElement("div");
        entryDiv.className = "lorebook-entry";
        entryDiv.innerHTML = `
          <div>
            <label for="lore-entryName-${index}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–ò–º—è):</label>
            <input type="text" id="lore-entryName-${index}" value="${entry.entryName || ""}" data-index="${index}" oninput="updateLorebookField(${index}, 'entryName', this.value)" />
          </div>
          <div>
            <label for="lore-triggers-${index}">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <input type="text" id="lore-triggers-${index}" value="${(entry.triggers || []).join(', ')}" data-index="${index}" oninput="updateLorebookField(${index}, 'triggers', this.value)" />
          </div>
          <div>
            <label for="lore-info-${index}">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
            <textarea id="lore-info-${index}" data-index="${index}" oninput="updateLorebookField(${index}, 'info', this.value)">${entry.info || ""}</textarea>
          </div>
          <button type="button" onclick="deleteLorebookEntry(${index})" style="background: #ffcdd2; color:#5f2120; font-size:0.9rem; padding: 0.5rem 0.8rem;">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        `;
        container.appendChild(entryDiv);
      });
    }

    function updateLorebookField(index, field, value) {
        const charName = getCurrentCharacterName();
        if (!charName || !characters[charName] || !characters[charName].lorebook[index]) return;

        if (field === 'entryName') {
            characters[charName].lorebook[index].entryName = value.trim();
        } else if (field === 'triggers') {
            characters[charName].lorebook[index].triggers = value.split(',').map(t => t.trim()).filter(t => t);
        } else if (field === 'info') {
            characters[charName].lorebook[index].info = value.trim();
        }
        localStorage.setItem("characters_v2", JSON.stringify(characters));
    }

    function addLorebookEntry() {
      const charName = getCurrentCharacterName();
      if (!charName || !characters[charName]) return showCustomAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.");
      characters[charName].lorebook = characters[charName].lorebook || [];
      characters[charName].lorebook.push({ entryName: "", triggers: [], info: "" }); // Add new empty entry with entryName
      localStorage.setItem("characters_v2", JSON.stringify(characters));
      renderLorebookEntries(charName);
    }

    function deleteLorebookEntry(index) {
      const charName = getCurrentCharacterName();
      if (!charName || !characters[charName] || !characters[charName].lorebook) return;
      showCustomConfirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –∏–∑ Lorebook?", () => {
        characters[charName].lorebook.splice(index, 1);
        localStorage.setItem("characters_v2", JSON.stringify(characters));
        renderLorebookEntries(charName);
      });
    }

    function uploadBackground() {
      const name = getCurrentCharacterName(); // Get current character
      if (!name || !characters[name]) return showCustomAlert("–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      const fileInput = document.getElementById("backgroundFileInput");
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          characters[name].backgroundImage = e.target.result; // Store as dataURL
          localStorage.setItem("characters_v2", JSON.stringify(characters)); // Save
          applyBackground(name); // Apply immediately
          closeBackgroundModal(); // Close modal
        };
        reader.readAsDataURL(file);
      } else {
        showCustomAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
      }
      fileInput.value = ""; // Reset file input
    }
    function deleteBackground() {
      const name = getCurrentCharacterName();
      if (!name || !characters[name]) return showCustomAlert("–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      delete characters[name].backgroundImage; // Remove property
      localStorage.setItem("characters_v2", JSON.stringify(characters)); // Save
      applyBackground(name); // Re-apply (will remove background)
      closeBackgroundModal();
    }

    function applyBackground(characterName) {
      const messagesDiv = document.querySelector('.messages');
      const chatContainerDiv = document.getElementById('chatContainer');
      const inputAreaContainer = document.querySelector('.input-area-container');

      if (!messagesDiv || !chatContainerDiv || !inputAreaContainer) return;

      const character = characterName ? characters[characterName] : null;
      const backgroundImage = character?.backgroundImage;

      if (backgroundImage && currentMode === "personal") {
        chatContainerDiv.style.backgroundImage = `url(${backgroundImage})`;
        chatContainerDiv.style.backgroundSize = 'cover';
        chatContainerDiv.style.backgroundPosition = 'center';
        chatContainerDiv.style.backgroundRepeat = 'no-repeat';
        chatContainerDiv.classList.add('chat-container-custom-bg'); // Add class to adjust padding

        messagesDiv.classList.add('has-custom-background');
        inputAreaContainer.classList.add('has-custom-background-too');
      } else {
        chatContainerDiv.style.backgroundImage = 'none';
        chatContainerDiv.classList.remove('chat-container-custom-bg'); // Remove class to revert padding

        messagesDiv.classList.remove('has-custom-background');
        inputAreaContainer.classList.remove('has-custom-background-too');
      }
    }


    function setupAvatarClickHandler() {
      document.addEventListener('click', function(e) {
        const targetElement = e.target;
        // Check if clicked on an avatar in a message, or an attached image in a message, or an image in file preview
        if (targetElement.classList.contains('avatar')) {
          const avatarSrc = targetElement.src;
          previewImage(avatarSrc);
        }
        else if (targetElement.classList.contains('attached-image')) { // Image inside a message bubble
          const imageSrc = targetElement.src;
          previewImage(imageSrc);
        }
        else if (targetElement.tagName === 'IMG' && targetElement.closest('.file-preview-item')) { // Image in the file preview area before sending
             const imageSrc = targetElement.src;
             previewImage(imageSrc);
        }
      });
    }

    function previewImage(src) {
        // Remove existing modal if any
        const existingModal = document.querySelector('.avatar-preview-modal');
        if (existingModal) document.body.removeChild(existingModal);

        const modal = document.createElement('div');
        modal.className = 'avatar-preview-modal';
        // Basic styling for the modal (overlay)
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.background = 'rgba(0,0,0,0.8)'; // Dark overlay
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '2000'; // High z-index to be on top
        modal.style.cursor = 'zoom-out'; // Indicate it can be closed by clicking
        // Image styling within the modal
        modal.innerHTML = `
            <img src="${src}" style="max-width:90vw; max-height:90vh; object-fit:contain; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.5);" />
        `;
        // Close modal on click
        modal.addEventListener('click', () => document.body.removeChild(modal));
        document.body.appendChild(modal);
    }


    function setupScrollHandler() {
      messagesBox.addEventListener("scroll", () => {
        // If user scrolls up, disable auto-scroll to bottom
        const nearBottom = messagesBox.scrollTop + messagesBox.clientHeight >= messagesBox.scrollHeight - 100;
        if (!nearBottom) {
            shouldScrollToBottom = false; // User has scrolled away from the bottom
        }
        // Auto-scroll is re-enabled when a new message is sent or bot responds (by setting shouldScrollToBottom = true)
      });
    }

    function showCustomAlert(message) {
        const messageBox = document.createElement('div');
        messageBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--accent-color);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
            z-index: 3000;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
        `;
        messageBox.textContent = message;
        document.body.appendChild(messageBox);
        setTimeout(() => {
            messageBox.style.opacity = 1;
        }, 10); // Small delay to trigger transition
        setTimeout(() => {
            messageBox.style.opacity = 0;
            messageBox.addEventListener('transitionend', () => messageBox.remove());
        }, 2000); // Disappear after 2 seconds
    }

    function showCustomConfirm(message, onConfirm) {
        const confirmBox = document.createElement('div');
        confirmBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 3000;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 350px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        `;
        confirmBox.innerHTML = `
            <p>${message}</p>
            <div style="display: flex; justify-content: center; gap: 10px;">
                <button id="confirmYes" class="send-button" style="margin:0;">–î–∞</button>
                <button id="confirmNo" class="send-button" style="background: var(--participant-bg); color:var(--text-color); margin:0;">–ù–µ—Ç</button>
            </div>
        `;
        document.body.appendChild(confirmBox);
        setTimeout(() => {
            confirmBox.style.opacity = 1;
        }, 10);

        document.getElementById('confirmYes').onclick = () => {
            onConfirm();
            confirmBox.remove();
        };
        document.getElementById('confirmNo').onclick = () => {
            confirmBox.remove();
        };
    }


    function setStatusActive(active) {
      const currentStatusIndicator = document.getElementById("messages-status-indicator");
      // The mobile prefix container and its cloned indicator might not always exist if the DOM structure changes.
      // It's safer to query for it within the mobile prefix div if it's consistently there.
      const mobilePrefixDiv = mainInputRow.querySelector('.mobile-input-prefix');
      const clonedStatusIndicator = mobilePrefixDiv ? mobilePrefixDiv.querySelector('#messages-status-indicator') : null;


      if (currentStatusIndicator) {
        currentStatusIndicator.classList.toggle("active", active);
        currentStatusIndicator.title = active ? "–ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞..." : "–ù–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      }
      if (clonedStatusIndicator) { // Also update the cloned indicator if it exists (for mobile view)
        clonedStatusIndicator.classList.toggle("active", active);
        clonedStatusIndicator.title = active ? "–ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞..." : "–ù–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
      }
    }

  </script>

<script>
// Original (PC) settings content (from original file)
if (typeof window.originalSettingsHTML === 'undefined') {
  window.originalSettingsHTML = `
<fieldset class="fieldset-span-1"> <legend>üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</legend>
<label for="apiKey">–ö–ª—é—á API (LLM):</label>
<input aria-label="–ö–ª—é—á API LLM" autocomplete="off" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á" type="password"/>
<label for="apiUrl">URL API LLM:</label>
<input aria-label="URL LLM API" id="apiUrl" type="text" value="https://llm.chutes.ai/v1/chat/completions"/>
<label for="model">–ú–æ–¥–µ–ª—å LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):</label>
<input aria-label="–ú–æ–¥–µ–ª—å LLM" id="model" readonly="" type="text" value="deepseek-ai/DeepSeek-V3-0324"/>
<label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0-1):</label>
<input aria-label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ LLM" id="temperature" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 0.7" step="0.1" type="number" value="0.7"/>
<label for="maxTokens">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤:</label>
<input aria-label="–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ LLM" id="maxTokens" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1024" type="number" value="1024"/>
</fieldset>
<fieldset class="fieldset-span-1">
<legend>üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</legend>
<label for="googleApiKey">–ö–ª—é—á Google API:</label>
<input aria-label="–ö–ª—é—á Google API" autocomplete="off" id="googleApiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Google API –∫–ª—é—á" type="password"/>
<label for="googleApiModel">–ú–æ–¥–µ–ª—å Google Gemini:</label>
<select aria-label="–ú–æ–¥–µ–ª—å Google Gemini" id="googleApiModel"></select>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableGoogleApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Gemini API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å Google Gemini API" id="enableGoogleApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset>
<fieldset>
<legend>üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</legend>
<label for="restApiUrl">URL REST API:</label>
<input aria-label="URL REST API" id="restApiUrl" placeholder="URL –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ REST API" type="text"/>
<label for="restApiHeaders">–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON):</label>
<textarea aria-label="–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON)" id="restApiHeaders" placeholder='–ü—Ä–∏–º–µ—Ä: {"Authorization": "Bearer –í–ê–®_–¢–û–ö–ï–ù"}'></textarea>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableRestApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REST API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å REST API" id="enableRestApi" type="checkbox">
<span class="slider round"></span>
</input></label>
</div>
</fieldset>
<fieldset>
<legend>üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</legend>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
<div>
<label for="characterSelect">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<select aria-label="–í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" disabled="" id="characterSelect"></select>
</div>
<div>
<label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<input aria-label="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
</div>
<label for="characterModel">–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è):</label>
<input aria-label="–ú–æ–¥–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, gpt-4-turbo –∏–ª–∏ –º–æ–¥–µ–ª—å Gemini" type="text"/>
</fieldset>
<fieldset>
<legend>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</legend>
<label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–≤–Ω–µ—à–Ω–æ—Å—Ç—å, —Ä–æ–ª—å, —Ü–µ–ª–∏):</label>
<textarea aria-label="–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏..." style="min-height: 140px;"></textarea>
<label for="personality">–õ–∏—á–Ω–æ—Å—Ç—å (—á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞):</label>
<textarea aria-label="–õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="personality" placeholder="–õ–∏—á–Ω–æ—Å—Ç—å, –º–∞–Ω–µ—Ä–∞ —Ä–µ—á–∏, –ø–æ–≤–µ–¥–µ–Ω–∏–µ..."></textarea>
</fieldset>
<fieldset>
<legend>üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</legend>
<label for="scenario">–°—Ü–µ–Ω–∞—Ä–∏–π (–º–∏—Ä, –æ–∫—Ä—É–∂–µ–Ω–∏–µ):</label>
<textarea aria-label="–°—Ü–µ–Ω–∞—Ä–∏–π" id="scenario" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞, —Å–∏—Ç—É–∞—Ü–∏–∏, —Å–µ—Ç—Ç–∏–Ω–≥–∞..."></textarea>
<label for="mes_example">–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:</label>
<textarea aria-label="–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞" id="mes_example" placeholder="&lt;START&gt;\\n–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∏–ª—è..." style="min-height: 140px;"></textarea>
</fieldset>
<fieldset>
<legend>üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</legend>
<label for="welcomeMessage">–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:</label>
<textarea aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" id="welcomeMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —á–∞—Ç–∞"></textarea>
<!-- REMOVED: Alternative Greetings Input Field -->
</fieldset>
<fieldset>
<legend>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</legend>
<label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
<textarea aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç" id="system_prompt" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò (system prompt)"></textarea>
<label for="post_history_instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏:</label>
<textarea aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏" id="post_history_instructions" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"></textarea>
<label for="creator_notes">–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:</label>
<textarea aria-label="–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è" id="creator_notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"></textarea>
</fieldset>
<fieldset class="fieldset-span-1">
<legend>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</legend>
<div>
<label for="mainTextColor">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
<input aria-label="–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞" id="mainTextColor" type="color"/>
</div>
<div style="margin-top: 1rem;">
<label for="chatFontSize">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ: <span id="chatFontSizeIndicator">100%</span></label>
<input aria-label="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ" id="chatFontSize" max="1.5" min="0.8" step="0.05" type="range" value="1"/>
</div>
</fieldset>
<fieldset class="fieldset-span-1">
<legend>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</legend>
<div class="avatar-selection">
<button onclick="showAvatarOptions('link', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_character" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarUrl_character" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_character" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarFileInput_character" type="file"/>
</div>
<div class="avatar-selection" style="margin-top: 1rem;">
<button onclick="showAvatarOptions('link', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_user" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∞–≤–∞—Ç–∞—Ä" id="avatarUrl_user" placeholder="URL –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_user" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" id="avatarFileInput_user" type="file"/>
</div>
</fieldset>
<fieldset>
<legend>üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</legend>
<textarea aria-label="–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" class="memory-box" id="neuralMemory" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ..." spellcheck="true"></textarea>
</fieldset>
<div style="grid-column: span 2; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top:1rem;">
<button onclick="saveSettings()" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å</button>
<button onclick="clearMessages()" style="background: #ffcdd2; color:#5f2120;" type="button">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
<button onclick="exportCharacterData()" type="button">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
<button onclick="importCharacterData()" type="button">üì• –ò–º–ø–æ—Ä—Ç JSON</button>
<input accept=".json, .card" id="jsonFileInput" onchange="handleFileUpload(event)" style="display:none" type="file"/>
<button onclick="openLorebookModal()" type="button">üìö Lorebook</button>
<button onclick="openBackgroundModal()" type="button">üñºÔ∏è –§–æ–Ω —á–∞—Ç–∞</button>
</div>
`;
}

// Mobile (tabbed) settings content (from modified file)
const mobileSettingsHTML = `<div class="tab-buttons"><button class="active" onclick="openSettingsTab(1)" type="button">üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</button><button onclick="openSettingsTab(2)" type="button">üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</button><button onclick="openSettingsTab(3)" type="button">üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</button><button onclick="openSettingsTab(4)" type="button">üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</button><button onclick="openSettingsTab(5)" type="button">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</button><button onclick="openSettingsTab(6)" type="button">üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</button><button onclick="openSettingsTab(7)" type="button">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</button><button onclick="openSettingsTab(8)" type="button">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</button><button onclick="openSettingsTab(9)" type="button">üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</button><button onclick="openSettingsTab(10)" type="button">üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</button><button onclick="openSettingsTab(11)" type="button">üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</button></div><div class="tab-page active" id="settingsTab1"><fieldset class="fieldset-span-1"> <legend>üîå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API LLM (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é)</legend>
<label for="apiKey">–ö–ª—é—á API (LLM):</label>
<input aria-label="–ö–ª—é—á API LLM" autocomplete="off" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á" type="password"/>
<label for="apiUrl">URL API LLM:</label>
<input aria-label="URL LLM API" id="apiUrl" type="text" value="https://llm.chutes.ai/v1/chat/completions"/>
<label for="model">–ú–æ–¥–µ–ª—å LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):</label>
<input aria-label="–ú–æ–¥–µ–ª—å LLM" id="model" readonly="" type="text" value="deepseek-ai/DeepSeek-V3-0324"/>
<label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0-1):</label>
<input aria-label="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ LLM" id="temperature" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 0.7" step="0.1" type="number" value="0.7"/>
<label for="maxTokens">–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤:</label>
<input aria-label="–ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ LLM" id="maxTokens" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1024" type="number" value="1024"/>
</fieldset></div><div class="tab-page" id="settingsTab2"><fieldset class="fieldset-span-1">
<legend>üá¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Gemini API</legend>
<label for="googleApiKey">–ö–ª—é—á Google API:</label>
<input aria-label="–ö–ª—é—á Google API" autocomplete="off" id="googleApiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Google API –∫–ª—é—á" type="password"/>
<label for="googleApiModel">–ú–æ–¥–µ–ª—å Google Gemini:</label>
<select aria-label="–ú–æ–¥–µ–ª—å Google Gemini" id="googleApiModel"></select>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableGoogleApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Gemini API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å Google Gemini API" id="enableGoogleApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset></div><div class="tab-page" id="settingsTab3"><fieldset>
<legend>üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∏ REST API</legend>
<label for="restApiUrl">URL REST API:</label>
<input aria-label="URL REST API" id="restApiUrl" placeholder="URL –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ REST API" type="text"/>
<label for="restApiHeaders">–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON):</label>
<textarea aria-label="–ó–∞–≥–æ–ª–æ–≤–∫–∏ REST API (JSON)" id="restApiHeaders" placeholder='–ü—Ä–∏–º–µ—Ä: {"Authorization": "Bearer –í–ê–®_–¢–û–ö–ï–ù"}'></textarea>
<div style="display: flex; align-items: center; margin-top: 0.5rem; gap: 10px;">
<label for="enableRestApi" style="font-weight: 500; margin-bottom: 0;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REST API:</label>
<label class="switch">
<input aria-label="–í–∫–ª—é—á–∏—Ç—å REST API" id="enableRestApi" type="checkbox"/>
<span class="slider round"></span>
</label>
</div>
</fieldset></div><div class="tab-page" id="settingsTab4"><fieldset>
<legend>üë§ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</legend>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
<div>
<label for="characterSelect">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<select aria-label="–í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" disabled="" id="characterSelect"></select>
</div>
<div>
<label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
<input aria-label="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
</div>
<label for="characterModel">–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è):</label>
<input aria-label="–ú–æ–¥–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="characterModel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, gpt-4-turbo –∏–ª–∏ –º–æ–¥–µ–ª—å Gemini" type="text"/>
</fieldset></div><div class="tab-page" id="settingsTab5"><fieldset>
<legend>üìù –û–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–∏—á–Ω–æ—Å—Ç—å</legend>
<label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–≤–Ω–µ—à–Ω–æ—Å—Ç—å, —Ä–æ–ª—å, —Ü–µ–ª–∏):</label>
<textarea aria-label="–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏..." style="min-height: 140px;"></textarea>
<label for="personality">–õ–∏—á–Ω–æ—Å—Ç—å (—á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞):</label>
<textarea aria-label="–õ–∏—á–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="personality" placeholder="–õ–∏—á–Ω–æ—Å—Ç—å, –º–∞–Ω–µ—Ä–∞ —Ä–µ—á–∏, –ø–æ–≤–µ–¥–µ–Ω–∏–µ..."></textarea>
</fieldset></div><div class="tab-page" id="settingsTab6"><fieldset>
<legend>üìñ –°—Ü–µ–Ω–∞—Ä–∏–π –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞</legend>
<label for="scenario">–°—Ü–µ–Ω–∞—Ä–∏–π (–º–∏—Ä, –æ–∫—Ä—É–∂–µ–Ω–∏–µ):</label>
<textarea aria-label="–°—Ü–µ–Ω–∞—Ä–∏–π" id="scenario" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞, —Å–∏—Ç—É–∞—Ü–∏–∏, —Å–µ—Ç—Ç–∏–Ω–≥–∞..."></textarea>
<label for="mes_example">–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:</label>
<textarea aria-label="–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞" id="mes_example" placeholder="&lt;START&gt;\\n–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç–∏–ª—è..." style="min-height: 140px;"></textarea>
</fieldset></div><div class="tab-page" id="settingsTab7"><fieldset>
<legend>üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</legend>
<label for="welcomeMessage">–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:</label>
<textarea aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" id="welcomeMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —á–∞—Ç–∞"></textarea>
<!-- REMOVED: Alternative Greetings Input Field -->
</fieldset></div><div class="tab-page" id="settingsTab8"><fieldset>
<legend>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò</legend>
<label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:</label>
<textarea aria-label="–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç" id="system_prompt" placeholder="–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò (system prompt)"></textarea>
<label for="post_history_instructions">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏:</label>
<textarea aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏" id="post_history_instructions" placeholder="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"></textarea>
<label for="creator_notes">–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:</label>
<textarea aria-label="–ó–∞–º–µ—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è" id="creator_notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"></textarea>
</fieldset></div><div class="tab-page" id="settingsTab9"><fieldset class="fieldset-span-1">
<legend>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</legend>
<div>
<label for="mainTextColor">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
<input aria-label="–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞" id="mainTextColor" type="color"/>
</div>
<div style="margin-top: 1rem;">
<label for="chatFontSize">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ: <span id="chatFontSizeIndicator">100%</span></label>
<input aria-label="–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ" id="chatFontSize" max="1.5" min="0.8" step="0.05" type="range" value="1"/>
</div>
</fieldset></div><div class="tab-page" id="settingsTab10"><fieldset class="fieldset-span-1">
<legend>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä—ã</legend>
<div class="avatar-selection">
<button onclick="showAvatarOptions('link', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'character')" type="button">–ê–≤–∞—Ç–∞—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–∞: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_character" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarUrl_character" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_character" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" id="avatarFileInput_character" type="file"/>
</div>
<div class="avatar-selection" style="margin-top: 1rem;">
<button onclick="showAvatarOptions('link', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –°—Å—ã–ª–∫–∞</button>
<button onclick="showAvatarOptions('file', 'user')" type="button">–í–∞—à –ê–≤–∞—Ç–∞—Ä: –§–∞–π–ª</button>
</div>
<div id="avatarLinkInput_user" style="display:none; margin-top: 0.5rem;">
<input aria-label="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –∞–≤–∞—Ç–∞—Ä" id="avatarUrl_user" placeholder="URL –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" type="text"/>
</div>
<div id="avatarFileInputWrapper_user" style="display:none; margin-top: 0.5rem;">
<input accept="image/*" aria-label="–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞" id="avatarFileInput_user" type="file"/>
</div>
</fieldset></div><div class="tab-page" id="settingsTab11"><fieldset>
<legend>üß† –ü–∞–º—è—Ç—å –ò–ò (–û–±—â–∞—è)</legend>
<textarea aria-label="–ü–∞–º—è—Ç—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" class="memory-box" id="neuralMemory" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ..." spellcheck="true"></textarea>
</fieldset></div>`;

function applySettingsLayout() {
  const container = document.getElementById('settingsSection');
  if(!container) return;
  const w = window.innerWidth || document.documentElement.clientWidth;
  if (w > 900) {
    // PC: restore original layout (if not already)
    if (container.innerHTML.trim() !== originalSettingsHTML.trim()) {
      container.innerHTML = originalSettingsHTML;
      // reattach any JS bindings if needed (basic)
      if (typeof initSettingsBindings === 'function') initSettingsBindings();
    }
    // hide mobile tab buttons if any exist
    const tb = document.querySelectorAll('.settings-content .tab-buttons');
    tb.forEach(b => b.style.display = 'none');
  } else {
    // Mobile: use tabbed layout (if not already)
    if (container.innerHTML.trim() !== mobileSettingsHTML.trim()) {
      container.innerHTML = mobileSettingsHTML;
      // ensure first tab active
      const btns = container.querySelectorAll('.tab-buttons button');
      if (btns && btns.length > 0) btns[0].classList.add('active');
      // run mobile tab initializer if exists
      if (typeof initMobileTabs === 'function') initMobileTabs();
      if (typeof initSettingsBindings === 'function') initSettingsBindings();
    }
    // show mobile tab buttons
    const tb = document.querySelectorAll('.settings-content .tab-buttons');
    tb.forEach(b => b.style.display = 'flex');
  }
}

// helper in case other functions need to rebind
function initMobileTabs() {
  // ensure openSettingsTab exists
  if (typeof openSettingsTab !== 'function') return;
  // activate first tab
  const btns = document.querySelectorAll('.settings-content .tab-buttons button');
  if (btns.length) btns.forEach((b,i)=> b.classList.toggle('active', i===0));
  const pages = document.querySelectorAll('.settings-content .tab-page');
  pages.forEach((p,i)=> p.classList.toggle('active', i===0));
}

// expose a simple initializer for other scripts
function initSettingsBindings() {
  // nothing heavy for now; placeholder to reattach event handlers if needed
}

// switch on load and resize
window.addEventListener('DOMContentLoaded', applySettingsLayout);
window.addEventListener('resize', applySettingsLayout);
</script>

<script>
(function(){
  const modalIds = ['settingsModal','lorebookModal','backgroundModal','greetingSelectModal','clearChatConfirmModal'];
  function addShowClass(modal) {
    if (!modal) return;
    modal.classList.add('modal-show');
  }
  function removeShowClass(modal) {
    if (!modal) return;
    modal.classList.remove('modal-show');
  }

  // Wrap original open/close functions if present to toggle modal-show reliably.
  modalIds.forEach(id => {
    const modal = document.getElementById(id);
    if (!modal) return;
    // If modal.style.display used by code, ensure it's set to 'flex' only when showing
    // We'll observe mutations on style attribute to sync modal-show class.
    const mo = new MutationObserver((mutations) => {
      for (const m of mutations) {
        if (m.attributeName === 'style') {
          const display = modal.style.display;
          if (display && display.indexOf('flex') !== -1) {
            // show requested by existing code -> add class so animation occurs
            addShowClass(modal);
          } else if (display === 'none' || display === '') {
            // existing code hid it -> remove class to allow fade-out
            removeShowClass(modal);
          }
        }
      }
    });
    mo.observe(modal, { attributes: true, attributeFilter: ['style'] });

    // Also listen for transitionend on opacity to set display none if not shown
    modal.addEventListener('transitionend', (e) => {
      if (e.propertyName !== 'opacity') return;
      if (!modal.classList.contains('modal-show')) {
        // ensure it's not intercepting pointer events after fade-out
        modal.style.display = 'none';
      } else {
        // ensure display is flex when visible
        modal.style.display = 'flex';
      }
    });
    // initialize: if currently style.display flex -> add class, else ensure display none
    if (modal.style.display && modal.style.display.indexOf('flex') !== -1) {
      addShowClass(modal);
    } else {
      modal.style.display = 'none';
      removeShowClass(modal);
    }
  });

  // Additionally, prevent rapid repeated opening by attaching a delegation handler on document
  document.addEventListener('click', function(e){
    const target = e.target;
    // block clicks that try to open multiple confirm boxes by detecting data-action attributes too
    const openSelectors = ['toggleSettingsBtn','toggleLorebookBtn','toggleBackgroundBtn','toggleGreetingBtn'];
    for (const id of openSelectors) {
      if (target.closest && target.closest('#'+id)) {
        const modalId = id === 'toggleSettingsBtn' ? 'settingsModal' :
                        id === 'toggleLorebookBtn' ? 'lorebookModal' :
                        id === 'toggleBackgroundBtn' ? 'backgroundModal' :
                        id === 'toggleGreetingBtn' ? 'greetingSelectModal' : null;
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        // If already visible or in transition, stop propagation to prevent other handlers firing duplicates
        if (modal.classList.contains('modal-show') || modal.dataset.animating === '1') {
          e.stopPropagation();
          e.preventDefault();
          return;
        }
        // mark animating briefly to avoid duplicate triggers
        modal.dataset.animating = '1';
        setTimeout(() => { delete modal.dataset.animating; }, 500);
      }
    }
  }, true);

})();</script>
<!-- END IMPORTED MODAL SCRIPTS -->



<!-- LOCALSTORAGE_MAXTOKENS_TEMPERATURE_INJECTED -->
<script>
// Robust persistence for Max Tokens and Temperature (handles both "maxTokens" and "max-tokens" ids, dynamic re-renders)
// Saves to localStorage keys: 'maxTokens' and 'temperature'
(function(){
  const ID_CANDIDATES = ['maxTokens','max-tokens'];
  const TEMP_ID_CANDIDATES = ['temperature','temp','tempurature']; // include common typos as fallback

  function findEl(candidates){
    for(const id of candidates){
      const el = document.getElementById(id);
      if(el) return el;
    }
    return null;
  }

  function attach(el, keyName){
    if(!el) return;
    if(el.__charis_persist_attached) return;
    const save = () => { try { localStorage.setItem(keyName, el.value); } catch(e){ console.warn('localStorage set error', e); } };
    el.addEventListener('input', save);
    el.addEventListener('change', save);
    el.__charis_persist_attached = true;
  }

  function restoreIfNeeded(){
    try {
      const maxEl = findEl(ID_CANDIDATES);
      const tempEl = findEl(TEMP_ID_CANDIDATES);

      const sMax = localStorage.getItem('maxTokens');
      const sTemp = localStorage.getItem('temperature');

      if (sMax !== null && maxEl) {
        // Only set if different to avoid clobbering dynamic defaults immediately
        if (maxEl.value !== sMax) maxEl.value = sMax;
      }
      if (sTemp !== null && tempEl) {
        if (tempEl.value !== sTemp) tempEl.value = sTemp;
      }

      // attach listeners
      if (maxEl) attach(maxEl, 'maxTokens');
      if (tempEl) attach(tempEl, 'temperature');
      return !!(maxEl || tempEl);
    } catch(e){ console.warn('restoreIfNeeded error', e); return false; }
  }

  // Try restore right away
  if (!restoreIfNeeded()) {
    // If elements are not present yet (dynamic render), observe DOM for them
    const obs = new MutationObserver((mutations, observer) => {
      if (restoreIfNeeded()) {
        // once attached, disconnect observer after short delay to avoid overhead
        setTimeout(()=>observer.disconnect(), 3000);
      }
    });
    obs.observe(document.documentElement || document.body, { childList: true, subtree: true });
    // Also try again on window load
    window.addEventListener('load', () => { restoreIfNeeded(); setTimeout(()=>obs.disconnect(), 3000); });
  }

  // Expose helper API
  window.__charis_settings_persistence = Object.assign(window.__charis_settings_persistence || {}, {
    saveNow: function(){ try{ const maxEl = findEl(ID_CANDIDATES); const tempEl = findEl(TEMP_ID_CANDIDATES); if(maxEl) localStorage.setItem('maxTokens', maxEl.value); if(tempEl) localStorage.setItem('temperature', tempEl.value); }catch(e){console.warn(e);} },
    restoreNow: function(){ try{ restoreIfNeeded(); }catch(e){console.warn(e);} },
    clear: function(){ try{ localStorage.removeItem('maxTokens'); localStorage.removeItem('temperature'); }catch(e){console.warn(e);} }
  });
})();
</script>



<script>
(function() {
  'use strict';
  const CLOUDFLARE_ENABLED_STORAGE_KEY = 'enableCloudflareRedirect_v1';
  const CLOUDFLARE_WORKER_URL = 'https://gemini-proxy.xlebovichxleb140.workers.dev/';
  const CLOUDFLARE_CHECKBOX_ID = 'enableCloudflareRedirect';
  const GEMINI_API_URL_PREFIX = 'https://generativelanguage.googleapis.com/';
  const FALLBACK_ON_ERROR = false;
  let useCloudflareRedirect = localStorage.getItem(CLOUDFLARE_ENABLED_STORAGE_KEY) === 'true';

  function addCloudflareCheckbox() {
    const googleApiSwitch = document.getElementById('enableGoogleApi');
    const settingsSection = document.getElementById('settingsSection');
    
    let targetParent = null;
    if (googleApiSwitch) {
      targetParent = googleApiSwitch.closest('.switch')?.parentElement || googleApiSwitch.parentElement;
    } else if (settingsSection) {
      targetParent = settingsSection;
    } else {
      targetParent = document.body;
    }

    if (!targetParent || document.getElementById(CLOUDFLARE_CHECKBOX_ID)) {
      return;
    }

    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'display:flex;align-items:center;gap:10px;margin-top:0.6rem;';
    wrapper.innerHTML = `
      <label for="${CLOUDFLARE_CHECKBOX_ID}" style="font-weight:500;">
        <strong>Cloudflare</strong>: –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã Gemini
      </label>
      <label class="switch">
        <input type="checkbox" id="${CLOUDFLARE_CHECKBOX_ID}">
        <span class="slider round"></span>
      </label>
    `;
    targetParent.appendChild(wrapper);
    
    const cb = document.getElementById(CLOUDFLARE_CHECKBOX_ID);
    cb.checked = useCloudflareRedirect;
    cb.addEventListener('change', e => {
      useCloudflareRedirect = e.target.checked;
      localStorage.setItem(CLOUDFLARE_ENABLED_STORAGE_KEY, useCloudflareRedirect);
      console.log('[cloudflare_redirect] useCloudflareRedirect =', useCloudflareRedirect);
    });
  }
  
  function buildHeaders(src) {
    const h = new Headers();
    if (!src) return h;
    if (src instanceof Headers) {
      for (const [k, v] of src.entries()) h.set(k, v);
    } else if (Array.isArray(src)) {
      for (const [k, v] of src) h.set(k, v);
    } else if (typeof src === 'object') {
      for (const k of Object.keys(src)) {
        const v = src[k];
        if (v != null) h.set(k, String(v));
      }
    }
    return h;
  }

  function patchFetch() {
    if (window.fetch.isPatched) return;
    const originalFetch = window.fetch.bind(window);
    window.fetch = async function(input, init = {}) {
      try {
        const isRequestObj = input instanceof Request;
        const origUrl = isRequestObj ? input.url : String(input || '');
        if (!useCloudflareRedirect || !origUrl.startsWith(GEMINI_API_URL_PREFIX)) {
          return originalFetch(input, init);
        }
        console.log('[cloudflare_redirect] intercepting:', origUrl);
        const srcHeaders = buildHeaders(init.headers || (isRequestObj ? input.headers : null));
        srcHeaders.set('X-Original-URL', origUrl);
        const method = (init.method || (isRequestObj ? input.method : 'POST')).toUpperCase();
        let body = init.body;
        if (body == null && isRequestObj) {
          body = input.body;
        }
        const fetchOptions = {
          method,
          headers: srcHeaders,
          body,
          credentials: init.credentials || (isRequestObj ? input.credentials : undefined),
          redirect: init.redirect || (isRequestObj ? input.redirect : undefined),
          referrer: init.referrer || (isRequestObj ? input.referrer : undefined),
          referrerPolicy: init.referrerPolicy || (isRequestObj ? input.referrerPolicy : undefined),
        };
        try {
          return await originalFetch(CLOUDFLARE_WORKER_URL, fetchOptions);
        } catch (err) {
          console.error('[cloudflare_redirect] fetch to worker failed:', err);
          if (FALLBACK_ON_ERROR) {
            console.warn('[cloudflare_redirect] falling back to original URL (may fail for geo-blocked requests)');
            return originalFetch(input, init);
          }
          throw err;
        }
      } catch (outerErr) {
        console.error('[cloudflare_redirect] unexpected patch error:', outerErr);
        return originalFetch(input, init);
      }
    };
    window.fetch.isPatched = true;
    console.log('[cloudflare_redirect] fetch patched.');
  }

(function() {
  try {
    if (window.__cf_xhr_patched) return;
    const origOpen = XMLHttpRequest.prototype.open;
    const origSend = XMLHttpRequest.prototype.send;
    const origSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
    XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
      try {
        this.__cf_original_url = url;
        this.__cf_should_proxy = (typeof useCloudflareRedirect !== 'undefined' ? useCloudflareRedirect : false)
                                 && (typeof url === 'string') && (typeof GEMINI_API_URL_PREFIX === 'string') && url.indexOf(GEMINI_API_URL_PREFIX) === 0;
        if (this.__cf_should_proxy) {
          return origOpen.call(this, method, (typeof CLOUDFLARE_WORKER_URL === 'string' ? CLOUDFLARE_WORKER_URL : '/'), async, user, password);
        }
      } catch (e) {
        console.error('[cf_xhr_patch] open error', e);
      }
      return origOpen.call(this, method, url, async, user, password);
    };
    XMLHttpRequest.prototype.send = function(body) {
      try {
        if (this.__cf_should_proxy && this.__cf_original_url) {
          try { origSetRequestHeader.call(this, 'X-Original-URL', this.__cf_original_url); } catch(e) {}
        }
      } catch(e) {
        console.error('[cf_xhr_patch] send error', e);
      }
      return origSend.call(this, body);
    };
    window.__cf_xhr_patched = true;
    console.log('[cf_xhr_patch] XMLHttpRequest patched for Cloudflare proxy');
  } catch (e) {
    console.error('[cf_xhr_patch] init error', e);
  }
})();

  
  function init() {
    addCloudflareCheckbox();
    patchFetch();
  }

  const observer = new MutationObserver(() => {
    const googleApiSwitch = document.getElementById('enableGoogleApi');
    const settingsSection = document.getElementById('settingsSection');
    
    if (googleApiSwitch || settingsSection) {
      observer.disconnect();
      init();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init();
  } else {
    window.addEventListener('load', init);
  }
})();
</script>


<!-- START: Inline Cloudflare / Gemini proxy helper (inserted) -->
<script>
(function () {
  'use strict';

  // ---- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ----
  var CLOUDFLARE_ENABLED_STORAGE_KEY = 'enableCloudflareRedirect_v1';
  var CLOUDFLARE_WORKER_URL = 'https://gemini-proxy.xlebovichxleb140.workers.dev/';
  var CLOUDFLARE_CHECKBOX_ID = 'enableCloudflareRedirect';
  var GEMINI_API_URL_PREFIX = 'https://generativelanguage.googleapis.com/';
  var FALLBACK_ON_ERROR = false;

  // ---- –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å localStorage (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–ª—è –ø—Ä–æ–¥-–æ–∫—Ä—É–∂–µ–Ω–∏–π/CSP) ----
  function safeGetLS(key) { try { return window.localStorage.getItem(key); } catch (e) { return null; } }
  function safeSetLS(key, val) { try { window.localStorage.setItem(key, val); } catch (e) {} }

  var useCloudflareRedirect = safeGetLS(CLOUDFLARE_ENABLED_STORAGE_KEY) === 'true';

  // ---- —á–µ–∫–±–æ–∫—Å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ----
  function addCloudflareCheckbox() {
    var googleApiSwitch = document.getElementById('enableGoogleApi');
    var settingsSection = document.getElementById('settingsSection');

    var targetParent = null;
    if (googleApiSwitch) {
      // –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π .switch –∏ –±–µ—Ä—ë–º –µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è (–±–µ–∑ optional chaining –¥–ª—è –∫—Ä–æ—Å—Å–±—Ä–∞—É–∑–µ—Ä–Ω–æ—Å—Ç–∏)
      var node = googleApiSwitch;
      var wrapper = null;
      while (node && node.nodeType === 1) {
        if ((node.className || '').indexOf('switch') !== -1) { wrapper = node; break; }
        node = node.parentElement;
      }
      targetParent = (wrapper && wrapper.parentElement) ? wrapper.parentElement : googleApiSwitch.parentElement;
    } else if (settingsSection) {
      targetParent = settingsSection;
    } else {
      targetParent = document.body || document.documentElement;
    }

    if (!targetParent || document.getElementById(CLOUDFLARE_CHECKBOX_ID)) return;

    var wrapperDiv = document.createElement('div');
    wrapperDiv.style.cssText = 'display:flex;align-items:center;gap:10px;margin-top:0.6rem;';
    wrapperDiv.innerHTML =
      '<label for="' + CLOUDFLARE_CHECKBOX_ID + '" style="font-weight:500;">' +
        '<strong>Cloudflare</strong>: –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã Gemini' +
      '</label>' +
      '<label class="switch" style="margin-left:auto;">' +
        '<input type="checkbox" id="' + CLOUDFLARE_CHECKBOX_ID + '">' +
        '<span class="slider round"></span>' +
      '</label>';

    targetParent.appendChild(wrapperDiv);

    var cb = document.getElementById(CLOUDFLARE_CHECKBOX_ID);
    if (cb) {
      cb.checked = useCloudflareRedirect;
      cb.addEventListener('change', function (e) {
        useCloudflareRedirect = !!e.target.checked;
        safeSetLS(CLOUDFLARE_ENABLED_STORAGE_KEY, useCloudflareRedirect ? 'true' : 'false');
        console.log('[cloudflare_redirect] enabled =', useCloudflareRedirect);
      });
    }
  }

  // ---- —É—Ç–∏–ª–∏—Ç–∞: –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ ----
  function buildHeaders(src) {
    var h = new Headers();
    if (!src) return h;
    if (src instanceof Headers) {
      src.forEach(function (v, k) { h.set(k, v); });
    } else if (Array.isArray(src)) {
      for (var i = 0; i < src.length; i++) { h.set(src[i][0], src[i][1]); }
    } else if (typeof src === 'object') {
      for (var k in src) if (Object.prototype.hasOwnProperty.call(src, k) && src[k] != null) h.set(k, String(src[k]));
    }
    return h;
  }

  // ---- –ø–∞—Ç—á–∏–º fetch –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥/–≤–µ—Ä—á–µ–ª ----
  function patchFetch() {
    if (!('fetch' in window)) { console.warn('[cloudflare_redirect] window.fetch –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'); return; }
    if (window.fetch && window.fetch.__cf_patched) return;

    var originalFetch = window.fetch.bind(window);

    window.fetch = function (input, init) {
      init = init || {};
      try {
        var isRequestObj = (typeof Request !== 'undefined') && (input instanceof Request);
        var origUrl = isRequestObj ? input.url : String(input || '');

        if (!useCloudflareRedirect || origUrl.indexOf(GEMINI_API_URL_PREFIX) !== 0) {
          return originalFetch(input, init);
        }

        console.log('[cloudflare_redirect] ‚Üí', origUrl);

        var srcHeaders = buildHeaders(init.headers || (isRequestObj ? input.headers : null));
        srcHeaders.set('X-Original-URL', origUrl);

        var method = String((init.method || (isRequestObj ? input.method : 'POST')) || 'POST').toUpperCase();
        var body = (init.body != null) ? init.body : (isRequestObj ? input.body : null);

        var fetchOptions = { method: method, headers: srcHeaders };
        if (body != null) fetchOptions.body = body;
        if (init && 'credentials' in init) fetchOptions.credentials = init.credentials;
        if (init && 'redirect' in init)    fetchOptions.redirect    = init.redirect;
        if (init && 'referrer' in init)    fetchOptions.referrer    = init.referrer;
        if (init && 'referrerPolicy' in init) fetchOptions.referrerPolicy = init.referrerPolicy;

        return originalFetch(CLOUDFLARE_WORKER_URL, fetchOptions).catch(function (err) {
          console.error('[cloudflare_redirect] –∑–∞–ø—Ä–æ—Å –∫ –≤–æ—Ä–∫–µ—Ä—É —É–ø–∞–ª:', err);
          if (FALLBACK_ON_ERROR) {
            console.warn('[cloudflare_redirect] fallback ‚Üí –∏—Å—Ö–æ–¥–Ω—ã–π URL');
            return originalFetch(input, init);
          }
          throw err;
        });
      } catch (outerErr) {
        console.error('[cloudflare_redirect] –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', outerErr);
        return originalFetch(input, init);
      }
    };

    window.fetch.__cf_patched = true;
    console.log('[cloudflare_redirect] fetch patched.');
  }

  function runWhenReady(fn) {
    if (document.readyState === 'complete' || document.readyState === 'interactive') fn();
    else window.addEventListener('DOMContentLoaded', fn);
  }

  function init() {
    try { addCloudflareCheckbox(); } catch(e) { console.warn('addCloudflareCheckbox error', e); }
    try { patchFetch(); } catch(e) { console.warn('patchFetch error', e); }
  }

  // —Å—Ç–∞—Ä—Ç—É–µ–º –∏ –Ω–∞ DOMReady, –∏ –∫–æ–≥–¥–∞ –ø–æ–∑–∂–µ –¥–æ—Ä–∏—Å—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  runWhenReady(init);

  try {
    var observer = new MutationObserver(function () {
      var googleApiSwitch = document.getElementById('enableGoogleApi');
      var settingsSection = document.getElementById('settingsSection');
      if (googleApiSwitch || settingsSection) init();
    });
    if (document.body) observer.observe(document.body, { childList: true, subtree: true });
  } catch (e) {
    // —Å—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –±–µ–∑ MutationObserver ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä
  }
})();
<script>
    (function() {
        const CLOUDFLARE_CHECKBOX_ID = 'enableCloudflareRedirect';
        const GOOGLE_API_SWITCH_ID = 'enableGoogleApi';

        function applyLayoutFix() {
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ, –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Gemini API
            const settingsContainer = document.querySelector('#settingsTab4 fieldset');
            if (!settingsContainer) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ Gemini. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ.');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç Cloudflare –∏ –µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const cloudflareInput = document.getElementById(CLOUDFLARE_CHECKBOX_ID);
            if (!cloudflareInput) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ–ª–∞–∂–æ–∫ Cloudflare. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –µ—â–µ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω.');
                return;
            }

            const existingWrapper = cloudflareInput.closest('div');
            if (!existingWrapper) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–ª–∞–∂–∫–∞ Cloudflare. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ.');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é, –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Ñ–ª–∞–∂–∫–∞ Cloudflare
            const newCloudflareWrapper = document.createElement('div');
            newCloudflareWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; margin-top: 1rem;';

            const cloudflareLabel = document.createElement('label');
            cloudflareLabel.setAttribute('for', CLOUDFLARE_CHECKBOX_ID);
            cloudflareLabel.textContent = '–í–∫–ª—é—á–∏—Ç—å Cloudflare Worker –¥–ª—è –æ–±—Ö–æ–¥–∞ —Ü–µ–Ω–∑—É—Ä—ã';
            
            const cloudflareSwitchDiv = document.createElement('div');
            cloudflareSwitchDiv.className = 'switch';
            cloudflareSwitchDiv.appendChild(cloudflareInput);
            cloudflareSwitchDiv.style.cssText = 'margin-top: 0.5rem;';

            newCloudflareWrapper.appendChild(cloudflareLabel);
            newCloudflareWrapper.appendChild(cloudflareSwitchDiv);

            // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ –Ω–æ–≤—É—é
            settingsContainer.replaceChild(newCloudflareWrapper, existingWrapper);

            // –¢–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º layout –¥–ª—è —Ñ–ª–∞–∂–∫–∞ Google API, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            const googleApiInput = document.getElementById(GOOGLE_API_SWITCH_ID);
            if (googleApiInput) {
                const googleApiWrapper = googleApiInput.closest('div');
                if (googleApiWrapper) {
                    googleApiWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 1rem;';
                }
            }

            console.log('[layout_fix] –ú–∞–∫–µ—Ç —Ñ–ª–∞–∂–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω.');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', applyLayoutFix);
        
        // –¢–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        const observer = new MutationObserver((mutations, obs) => {
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal && settingsModal.style.display !== 'none') {
                if (document.getElementById(CLOUDFLARE_CHECKBOX_ID) && !document.getElementById(CLOUDFLARE_CHECKBOX_ID).closest('.fixed-layout')) {
                    applyLayoutFix();
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–æ–≤–∞
                    document.getElementById(CLOUDFLARE_CHECKBOX_ID).closest('div').classList.add('fixed-layout');
                }
            }
        });

        observer.observe(document.body, { childList: true, subtree: true });

    })();
</script>

<!-- AUTO-INJECT: DOM fix script for settings checkboxes -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function fixSettingsCheckboxes() {
    try {
      const settingsContent = document.querySelector('#settingsModal .settings-content');
      if (!settingsContent) return;

      // Find inline-flex rows used for switches and convert to column layout
      const rows = settingsContent.querySelectorAll('div[style*="display: flex"][style*="align-items"]');
      rows.forEach(row => {
        // only affect rows that contain a .switch or input[type=checkbox]
        if (row.querySelector('.switch') || row.querySelector('input[type="checkbox"]')) {
          row.style.display = 'flex';
          row.style.flexDirection = 'column';
          row.style.alignItems = 'flex-start';
          row.style.gap = '6px';
        }
      });

      // For each .switch in settings, show native checkbox and hide slider span
      const switches = settingsContent.querySelectorAll('.switch');
      switches.forEach(sw => {
        const input = sw.querySelector('input[type="checkbox"]');
        const slider = sw.querySelector('.slider');
        if (input) {
          input.style.opacity = '1';
          input.style.width = '18px';
          input.style.height = '18px';
          input.style.position = 'relative';
          input.style.appearance = 'checkbox';
          input.style.webkitAppearance = 'checkbox';
          input.style.accentColor = '#ff69b4';
        }
        if (slider) slider.style.display = 'none';
      });

      // Ensure labels that are siblings to switches are above them
      const labeledPairs = settingsContent.querySelectorAll('label[for]');
      labeledPairs.forEach(lbl => {
        const parent = lbl.parentElement;
        if (parent && parent.querySelector('.switch')) {
          // move label before switch if needed (usually already)
          const sw = parent.querySelector('.switch');
          if (sw && lbl.nextSibling !== sw) {
            parent.insertBefore(lbl, sw);
          }
        }
      });
    } catch (e) {
      console.warn('fixSettingsCheckboxes error', e);
    }
  }

  // Try to run once now
  fixSettingsCheckboxes();

  // Observe DOM mutations (in case settings are loaded later)
  const observer = new MutationObserver(function(muts) {
    fixSettingsCheckboxes();
  });
  observer.observe(document.body, { childList: true, subtree: true });

  // Also expose a manual function
  window.__fixSettingsCheckboxes = fixSettingsCheckboxes;
});
</script>

</body>
</html>
